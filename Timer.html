<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Tap Timer Analytics</title>

    <!-- AUTHENTICATION CHECK - MUST RUN FIRST -->
    <script>
      (function () {
        var token = localStorage.getItem("pwtm_auth_token");
        var userData = localStorage.getItem("pwtm_user_data");
        if (!token || !userData) {
          window.location.replace("login.html");
        }
      })();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="config.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron&family=Poppins&family=Roboto+Mono&family=Montserrat&family=Oswald&family=Pacifico&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #f4f6f8;
        --text: #000;
        --panel: #fff;
        --accent: #4f46e5;
      }
      body {
        margin: 0;
        font-family: Poppins, sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      #timerScreen {
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }
      #backgroundAnalytics {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0.45;
        pointer-events: none;
        z-index: 1;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #backgroundAnalytics canvas {
        max-width: 100%;
        max-height: 100%;
      }
      .timer-center {
        position: relative;
        z-index: 10;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
      }
      .save-session-inline {
        display: flex;
        gap: 8px;
        align-items: center;
        background: rgba(255, 255, 255, 0.1);
        padding: 12px;
        border-radius: 10px;
        backdrop-filter: blur(8px);
        border: 1px solid rgba(79, 70, 229, 0.2);
      }
      .save-session-inline input {
        padding: 8px 12px !important;
        border: 1px solid rgba(79, 70, 229, 0.3) !important;
        border-radius: 6px !important;
        background: #fff !important;
        color: #0f172a !important;
        font-size: 12px !important;
        min-width: 100px;
        margin: 0 !important;
      }
      .save-session-inline input::placeholder {
        color: #4b5563;
      }
      .save-session-inline input:focus {
        outline: none;
        border-color: var(--accent) !important;
        box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2) !important;
      }
      .save-session-inline button {
        padding: 8px 16px !important;
        background: linear-gradient(
          135deg,
          var(--accent) 0%,
          #3b82f6 100%
        ) !important;
        color: #fff !important;
        border: none !important;
        border-radius: 6px !important;
        font-weight: 600;
        font-size: 12px;
        white-space: nowrap;
        cursor: pointer;
        transition: all 0.2s;
      }
      .save-session-inline button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
      }
      #timeDisplay {
        font-size: 36px;
        font-weight: bold;
        font-family: Orbitron;
      }
      #stats {
        margin-top: 10px;
        text-align: center;
      }
      #hint {
        font-size: 12px;
      }
      #dataPanel {
        position: fixed;
        top: 10px;
        right: 10px;
      }
      #navBar {
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 1000;
        display: flex;
        gap: 8px;
      }
      button {
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      #openBtn {
        background: var(--accent);
        color: #fff;
      }
      .nav-btn {
        background: var(--accent);
        color: #fff;
        font-size: 14px;
        font-weight: 600;
      }
      .nav-btn:hover {
        background: #3b33cc;
        transform: scale(1.05);
        transition: all 0.2s;
      }
      #panel {
        position: fixed;
        top: 0;
        right: -35vw;
        width: 35vw;
        height: 100vh;
        background: linear-gradient(
          135deg,
          var(--panel) 0%,
          rgba(79, 70, 229, 0.05) 100%
        );
        box-shadow: -8px 0 25px rgba(0, 0, 0, 0.25);
        transition: right 0.4s ease;
        padding: 0;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        z-index: 999;
      }
      #panel.open {
        right: 0;
      }
      #panel > h3 {
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, var(--accent) 0%, #3b82f6 100%);
        color: #fff;
        font-size: 18px;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      #closeBtn {
        background: transparent;
        border: none;
        color: #fff;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: auto;
        float: none;
      }
      #closeBtn:hover {
        transform: scale(1.1);
        transition: all 0.2s;
      }
      .panel-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
      }
      input,
      select {
        width: 100%;
        padding: 10px 12px;
        margin-bottom: 12px;
        border: 1.5px solid #ddd;
        border-radius: 8px;
        font-family: inherit;
        font-size: 13px;
        background: var(--panel);
        color: var(--text);
        transition: all 0.3s;
      }
      input:focus,
      select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      }
      .panel-section {
        margin-bottom: 20px;
      }
      .panel-section h4 {
        margin: 0 0 10px 0;
        font-size: 13px;
        font-weight: 600;
        color: var(--accent);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .font-size-controls {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
      }
      .font-size-controls button {
        flex: 1;
        padding: 8px 12px;
        background: #f0f0f0;
        border: 1.5px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
      }
      .font-size-controls button:hover {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
        border-radius: 8px;
        overflow: hidden;
        font-size: 11px;
      }
      th,
      td {
        border: 1px solid #e0e0e0;
        padding: 8px 4px;
        text-align: center;
      }
      th {
        background: linear-gradient(135deg, var(--accent) 0%, #3b82f6 100%);
        color: #fff;
        font-weight: 600;
      }
      tr:nth-child(even) {
        background: rgba(79, 70, 229, 0.05);
      }
      #csvBtn,
      #saveBtn,
      #clearBtn {
        width: 100%;
        color: #fff;
        padding: 10px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        margin-bottom: 10px;
        transition: all 0.3s;
      }
      #csvBtn {
        background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
      }
      #csvBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
      }
      #saveBtn {
        background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      }
      #saveBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
      }
      #clearBtn {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      }
      #clearBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
      }
      #chart {
        margin: 20px 0;
        max-height: 250px;
      }
      .resetBtn {
        margin-top: 10px;
        background: #f97316;
        color: #fff;
      }
    </style>
  </head>
  <body>
    <div id="navBar">
      <button
        class="nav-btn"
        onclick="window.location.href = 'index.html'"
        title="Go to Work Tracker"
      >
        üìä Tracker
      </button>
      <button
        class="nav-btn"
        onclick="window.location.href = 'NotificationTimer.html'"
        title="Go to Smart Timer"
      >
        üîî Smart Timer
      </button>
    </div>

    <div id="timerScreen">
      <div id="backgroundAnalytics"></div>

      <div class="timer-center">
        <div id="timeDisplay">00:00:00.000</div>
        <div id="stats">Best: -- | Avg: --</div>

        <div class="save-session-inline">
          <input id="title" placeholder="Title" style="max-width: 80px" />
          <input
            id="subtitle"
            placeholder="Sub-title"
            style="max-width: 80px"
          />
          <button id="saveBtn">üíæ Save</button>
        </div>

        <button class="resetBtn" id="resetBtn">Reset Timer</button>
        <div id="hint">Tap / Press SPACE</div>
      </div>
    </div>

    <div id="dataPanel"><button id="openBtn">View Details</button></div>

    <div id="panel">
      <h3>
        ‚öôÔ∏è Session Details
        <button id="closeBtn">‚úï</button>
      </h3>
      <div class="panel-content">
        <div class="panel-section">
          <h4>üé® Appearance</h4>
          <label
            style="
              font-size: 12px;
              color: var(--text);
              margin-bottom: 8px;
              display: block;
            "
          >
            Theme Mode
          </label>
          <select id="modeDropdown">
            <option value="day">‚òÄÔ∏è Day Mode</option>
            <option value="dark">üåô Dark Mode</option>
          </select>

          <label
            style="
              font-size: 12px;
              color: var(--text);
              margin-bottom: 8px;
              display: block;
            "
          >
            Color Theme
          </label>
          <select id="colorDropdown"></select>

          <label
            style="
              font-size: 12px;
              color: var(--text);
              margin-bottom: 8px;
              display: block;
            "
          >
            Font Style
          </label>
          <select id="fontDropdown"></select>

          <label
            style="
              font-size: 12px;
              color: var(--text);
              margin-bottom: 8px;
              display: block;
            "
          >
            Font Size
          </label>
          <div class="font-size-controls">
            <button onclick="fontSize('+')">A+</button>
            <button onclick="fontSize('-')">A‚àí</button>
          </div>
        </div>

        <div class="panel-section">
          <h4>üìä Sessions History</h4>
          <table id="dataTable">
            <thead>
              <tr>
                <th>Title</th>
                <th>Sub</th>
                <th>Date</th>
                <th>Time</th>
                <th>Duration</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="panel-section">
          <h4>üìà Analytics</h4>
          <div
            style="
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 10px;
              margin-bottom: 15px;
            "
          >
            <div
              style="
                background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%);
                color: #fff;
                padding: 12px;
                border-radius: 8px;
                text-align: center;
              "
            >
              <div style="font-size: 11px; opacity: 0.9">Total Sessions</div>
              <div style="font-size: 18px; font-weight: 700" id="statSessions">
                0
              </div>
            </div>
            <div
              style="
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: #fff;
                padding: 12px;
                border-radius: 8px;
                text-align: center;
              "
            >
              <div style="font-size: 11px; opacity: 0.9">Total Time</div>
              <div style="font-size: 18px; font-weight: 700" id="statTotalTime">
                00:00:00
              </div>
            </div>
            <div
              style="
                background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                color: #fff;
                padding: 12px;
                border-radius: 8px;
                text-align: center;
              "
            >
              <div style="font-size: 11px; opacity: 0.9">Avg Duration</div>
              <div style="font-size: 18px; font-weight: 700" id="statAvgTime">
                00:00:00
              </div>
            </div>
            <div
              style="
                background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
                color: #fff;
                padding: 12px;
                border-radius: 8px;
                text-align: center;
              "
            >
              <div style="font-size: 11px; opacity: 0.9">Best Time</div>
              <div style="font-size: 18px; font-weight: 700" id="statBestTime">
                00:00:00
              </div>
            </div>
          </div>

          <div
            style="
              margin-bottom: 15px;
              background: rgba(79, 70, 229, 0.05);
              padding: 12px;
              border-radius: 8px;
            "
          >
            <h5
              style="margin: 0 0 10px 0; font-size: 13px; color: var(--accent)"
            >
              Duration Trend
            </h5>
            <canvas id="lineChart" style="max-height: 200px"></canvas>
          </div>

          <div
            style="
              margin-bottom: 15px;
              background: rgba(79, 70, 229, 0.05);
              padding: 12px;
              border-radius: 8px;
            "
          >
            <h5
              style="margin: 0 0 10px 0; font-size: 13px; color: var(--accent)"
            >
              Tasks Distribution
            </h5>
            <canvas id="pieChart" style="max-height: 180px"></canvas>
          </div>

          <div
            style="
              margin-bottom: 15px;
              background: rgba(79, 70, 229, 0.05);
              padding: 12px;
              border-radius: 8px;
            "
          >
            <h5
              style="margin: 0 0 10px 0; font-size: 13px; color: var(--accent)"
            >
              Duration by Task
            </h5>
            <canvas id="barChart" style="max-height: 180px"></canvas>
          </div>
        </div>

        <div class="panel-section">
          <button id="csvBtn">üì• Download CSV</button>
          <button id="clearBtn">üóëÔ∏è Clear All Data</button>
        </div>
      </div>
    </div>

    <script>
      let running = false,
        startTime,
        interval = null,
        elapsed = 0;
      let fontSizeVal = 36;
      const fonts = [
        "Orbitron",
        "Roboto Mono",
        "Montserrat",
        "Poppins",
        "Oswald",
        "Pacifico",
      ];
      const colors = {
        Blue: "#4f46e5",
        Pink: "#f72585",
        Green: "#06d6a0",
        Orange: "#f97316",
        Purple: "#6a4c93",
        Sky: "#4cc9f0",
      };

      const display = document.getElementById("timeDisplay");
      let data = JSON.parse(localStorage.getItem("timerData")) || [];
      const tbody = document.querySelector("#dataTable tbody");

      /* FORMAT */
      function format(ms) {
        let milli = String(ms % 1000).padStart(3, "0");
        let s = Math.floor(ms / 1000);
        let h = String(Math.floor(s / 3600)).padStart(2, "0");
        let m = String(Math.floor((s % 3600) / 60)).padStart(2, "0");
        let sec = String(s % 60).padStart(2, "0");
        return `${h}:${m}:${sec}.${milli}`;
      }

      /* TIMER */
      function toggleTimer() {
        if (!running) {
          startTime = Date.now() - elapsed;
          interval = setInterval(() => {
            elapsed = Date.now() - startTime;
            display.innerText = format(elapsed);
          }, 10);
          running = true;
        } else {
          clearInterval(interval);
          running = false;
        }
      }

      function resetTimer() {
        clearInterval(interval);
        interval = null;
        running = false;
        elapsed = 0;
        display.innerText = "00:00:00.000";
      }

      // EVENTS

      document
        .getElementById("timerScreen")
        .addEventListener("click", toggleTimer);

      // Prevent timer start when clicking on inputs
      document.getElementById("title").addEventListener("click", (e) => {
        e.stopPropagation();
      });
      document.getElementById("subtitle").addEventListener("click", (e) => {
        e.stopPropagation();
      });

      document.getElementById("saveBtn").addEventListener("click", (e) => {
        e.stopPropagation();
      });

      document.getElementById("resetBtn").addEventListener("click", (e) => {
        e.stopPropagation();
        resetTimer();
      });

      // SPACE shortcut
      document.addEventListener("keydown", (e) => {
        if (e.code === "Space") {
          e.preventDefault();
          toggleTimer();
        }
      });

      // PANEL
      openBtn.onclick = () => panel.classList.add("open");
      closeBtn.onclick = () => panel.classList.remove("open");

      /* SAVE */
      function render() {
        tbody.innerHTML = "";
        data.sort((a, b) => a.ms - b.ms);
        data.forEach((d) => {
          let r = tbody.insertRow();
          r.innerHTML = `<td>${d.t}</td><td>${d.s}</td><td>${d.d}</td><td>${d.time}</td><td>${d.du}</td>`;
        });
        calcStats();
        drawChart();
        localStorage.setItem("timerData", JSON.stringify(data));
      }

      saveBtn.onclick = async () => {
        let t = title.value.trim(),
          s = subtitle.value.trim();
        if (!t || !s) return alert("Title & Sub required");
        let now = new Date();
        const newSession = {
          t,
          s,
          d: now.toLocaleDateString(),
          time: now.toLocaleTimeString(),
          du: format(elapsed),
          ms: elapsed,
        };

        // Save to local storage FIRST (instant)
        data.push(newSession);
        render();
        title.value = "";
        subtitle.value = "";

        // Silent sync to backend (no popup, no blocking)
        timerAPI
          .addSession({
            task_name: t,
            duration: elapsed,
            date: now.toISOString(),
            category: s,
          })
          .then((result) => {
            if (result.success) {
              console.log("‚úÖ Session synced to server");
            } else if (result.queued) {
              console.log("üì§ Session queued for later sync");
            } else {
              console.log("‚ö†Ô∏è Sync pending - will retry automatically");
            }
          })
          .catch((err) => {
            console.log("‚ö†Ô∏è Sync failed - queued for later:", err);
          });
      };

      clearBtn.onclick = () => {
        if (confirm("Delete all saved data?")) {
          data = [];
          localStorage.removeItem("timerData");
          render();
        }
      };

      /* STATS */
      let chartLine, chartPie, chartBar;

      function calcStats() {
        if (!data.length) {
          stats.innerText = "Best: -- | Avg: --";
          document.getElementById("statSessions").innerText = "0";
          document.getElementById("statTotalTime").innerText = "00:00:00";
          document.getElementById("statAvgTime").innerText = "00:00:00";
          document.getElementById("statBestTime").innerText = "00:00:00";
          return;
        }

        let best = Math.min(...data.map((d) => d.ms));
        let total = data.reduce((a, b) => a + b.ms, 0);
        let avg = total / data.length;

        // Update top stats
        stats.innerText = `Best: ${format(best)} | Avg: ${format(avg)}`;

        // Update analytics stats
        document.getElementById("statSessions").innerText = data.length;
        document.getElementById("statTotalTime").innerText = formatTime(total);
        document.getElementById("statAvgTime").innerText = formatTime(avg);
        document.getElementById("statBestTime").innerText = formatTime(best);
      }

      function formatTime(ms) {
        let sec = Math.floor(ms / 1000);
        let h = String(Math.floor(sec / 3600)).padStart(2, "0");
        let m = String(Math.floor((sec % 3600) / 60)).padStart(2, "0");
        let s = String(sec % 60).padStart(2, "0");
        return `${h}:${m}:${s}`;
      }

      /* CHARTS */
      function drawChart() {
        if (!data.length) return;

        // Line Chart - Duration Trend
        const lineCtx = document.getElementById("lineChart");
        if (chartLine) chartLine.destroy();
        chartLine = new Chart(lineCtx, {
          type: "line",
          data: {
            labels: data.map((_, i) => `#${i + 1}`),
            datasets: [
              {
                label: "Duration (sec)",
                data: data.map((x) => Math.round(x.ms / 1000)),
                borderColor: "#4f46e5",
                backgroundColor: "rgba(79, 70, 229, 0.1)",
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: "#4f46e5",
                pointBorderColor: "#fff",
                pointBorderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { display: true, position: "top" } },
            scales: { y: { beginAtZero: true } },
          },
        });

        // Pie Chart - Tasks Distribution
        const pieCtx = document.getElementById("pieChart");
        if (chartPie) chartPie.destroy();

        // Group by task name
        const taskGroups = {};
        data.forEach((d) => {
          if (!taskGroups[d.t]) taskGroups[d.t] = 0;
          taskGroups[d.t]++;
        });

        chartPie = new Chart(pieCtx, {
          type: "doughnut",
          data: {
            labels: Object.keys(taskGroups),
            datasets: [
              {
                data: Object.values(taskGroups),
                backgroundColor: [
                  "#4f46e5",
                  "#10b981",
                  "#f59e0b",
                  "#ef4444",
                  "#8b5cf6",
                  "#0ea5e9",
                  "#ec4899",
                  "#14b8a6",
                ],
                borderColor: "#fff",
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { position: "bottom" } },
          },
        });

        // Bar Chart - Duration by Task
        const barCtx = document.getElementById("barChart");
        if (chartBar) chartBar.destroy();

        // Group by task and sum duration
        const taskDuration = {};
        data.forEach((d) => {
          if (!taskDuration[d.t]) taskDuration[d.t] = 0;
          taskDuration[d.t] += Math.round(d.ms / 1000);
        });

        chartBar = new Chart(barCtx, {
          type: "bar",
          data: {
            labels: Object.keys(taskDuration),
            datasets: [
              {
                label: "Total Duration (sec)",
                data: Object.values(taskDuration),
                backgroundColor: [
                  "#4f46e5",
                  "#10b981",
                  "#f59e0b",
                  "#ef4444",
                  "#8b5cf6",
                  "#0ea5e9",
                  "#ec4899",
                  "#14b8a6",
                ],
                borderRadius: 6,
                borderSkipped: false,
              },
            ],
          },
          options: {
            indexAxis: "y",
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { display: false } },
            scales: { x: { beginAtZero: true } },
          },
        });

        // Draw background chart
        drawBackgroundAnalytics();
      }

      /* BACKGROUND ANALYTICS */
      let bgCharts = { line: null, pie: null, bar: null };
      function drawBackgroundAnalytics() {
        if (!data.length) return;

        const bgContainer = document.getElementById("backgroundAnalytics");
        bgContainer.innerHTML = "";
        bgContainer.style.display = "grid";
        bgContainer.style.gridTemplateColumns = "60% 40%";
        bgContainer.style.gridTemplateRows = "60% 40%";
        bgContainer.style.gap = "12px";
        bgContainer.style.padding = "20px";
        bgContainer.style.alignItems = "start";
        bgContainer.style.justifyContent = "start";

        // Canvases
        const lineCanvas = document.createElement("canvas");
        lineCanvas.style.width = "100%";
        lineCanvas.style.height = "100%";
        lineCanvas.style.aspectRatio = "16 / 9";
        lineCanvas.style.objectFit = "contain";
        bgContainer.appendChild(lineCanvas);

        const pieCanvas = document.createElement("canvas");
        pieCanvas.style.width = "100%";
        pieCanvas.style.height = "100%";
        pieCanvas.style.aspectRatio = "1 / 1";
        pieCanvas.style.objectFit = "contain";
        bgContainer.appendChild(pieCanvas);

        const barCanvas = document.createElement("canvas");
        barCanvas.style.width = "100%";
        barCanvas.style.height = "100%";
        barCanvas.style.aspectRatio = "16 / 9";
        barCanvas.style.objectFit = "contain";
        bgContainer.appendChild(barCanvas);

        // Mini table overlay (latest 4 rows)
        const tableWrap = document.createElement("div");
        tableWrap.style.background = "rgba(255,255,255,0.78)";
        tableWrap.style.color = "#0b1221";
        tableWrap.style.border = "1px solid rgba(0,0,0,0.06)";
        tableWrap.style.borderRadius = "10px";
        tableWrap.style.padding = "10px";
        tableWrap.style.fontSize = "11px";
        tableWrap.style.lineHeight = "1.4";
        tableWrap.style.boxShadow = "0 4px 12px rgba(0,0,0,0.08)";
        tableWrap.style.overflow = "hidden";
        tableWrap.style.backdropFilter = "blur(4px)";
        tableWrap.style.width = "100%";
        const tbl = document.createElement("table");
        tbl.style.width = "100%";
        tbl.style.borderCollapse = "collapse";
        const head = document.createElement("thead");
        head.innerHTML =
          "<tr><th style='text-align:left;padding:6px 4px;'>Title</th><th style='text-align:left;padding:6px 4px;'>Sub</th><th style='text-align:left;padding:6px 4px;'>Duration</th></tr>";
        const body = document.createElement("tbody");
        data.slice(-4).forEach((row) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td style='padding:4px 4px;border-top:1px solid rgba(0,0,0,0.05);'>${row.t}</td><td style='padding:4px 4px;border-top:1px solid rgba(0,0,0,0.05);'>${row.s}</td><td style='padding:4px 4px;border-top:1px solid rgba(0,0,0,0.05);'>${row.du}</td>`;
          body.appendChild(tr);
        });
        tbl.appendChild(head);
        tbl.appendChild(body);
        tableWrap.appendChild(tbl);
        bgContainer.appendChild(tableWrap);

        // Destroy existing charts
        Object.values(bgCharts).forEach((chart) => {
          if (chart) chart.destroy();
        });

        // Line Chart - Duration Trend
        bgCharts.line = new Chart(lineCanvas, {
          type: "line",
          data: {
            labels: data.map((_, i) => i + 1),
            datasets: [
              {
                label: "Duration (sec)",
                data: data.map((x) => Math.round(x.ms / 1000)),
                borderColor: "rgba(79, 70, 229, 0.7)",
                backgroundColor: "rgba(79, 70, 229, 0.3)",
                borderWidth: 2.5,
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: "rgba(79, 70, 229, 0.9)",
                pointBorderColor: "#fff",
                pointBorderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { display: true, labels: { color: "rgba(0,0,0,0.6)" } },
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: "rgba(0,0,0,0.08)" },
                ticks: { color: "rgba(0,0,0,0.5)" },
              },
              x: {
                grid: { color: "rgba(0,0,0,0.08)" },
                ticks: { color: "rgba(0,0,0,0.5)" },
              },
            },
          },
        });

        // Pie Chart - Task Distribution
        const taskGroups = {};
        data.forEach((d) => {
          if (!taskGroups[d.t]) taskGroups[d.t] = 0;
          taskGroups[d.t]++;
        });

        bgCharts.pie = new Chart(pieCanvas, {
          type: "doughnut",
          data: {
            labels: Object.keys(taskGroups),
            datasets: [
              {
                data: Object.values(taskGroups),
                backgroundColor: [
                  "rgba(79, 70, 229, 0.7)",
                  "rgba(16, 185, 129, 0.7)",
                  "rgba(245, 158, 11, 0.7)",
                  "rgba(239, 68, 68, 0.7)",
                  "rgba(139, 92, 246, 0.7)",
                  "rgba(14, 165, 233, 0.7)",
                ],
                borderColor: "#fff",
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                position: "bottom",
                labels: { color: "rgba(0,0,0,0.6)" },
              },
            },
          },
        });

        // Bar Chart - Duration by Task
        const taskDuration = {};
        data.forEach((d) => {
          if (!taskDuration[d.t]) taskDuration[d.t] = 0;
          taskDuration[d.t] += Math.round(d.ms / 1000);
        });

        bgCharts.bar = new Chart(barCanvas, {
          type: "bar",
          data: {
            labels: Object.keys(taskDuration),
            datasets: [
              {
                label: "Total Duration (sec)",
                data: Object.values(taskDuration),
                backgroundColor: [
                  "rgba(79, 70, 229, 0.7)",
                  "rgba(16, 185, 129, 0.7)",
                  "rgba(245, 158, 11, 0.7)",
                  "rgba(239, 68, 68, 0.7)",
                  "rgba(139, 92, 246, 0.7)",
                  "rgba(14, 165, 233, 0.7)",
                ],
                borderRadius: 5,
                borderSkipped: false,
              },
            ],
          },
          options: {
            indexAxis: "y",
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { display: false } },
            scales: {
              x: {
                beginAtZero: true,
                grid: { color: "rgba(0,0,0,0.08)" },
                ticks: { color: "rgba(0,0,0,0.5)" },
              },
              y: {
                grid: { color: "rgba(0,0,0,0.08)" },
                ticks: { color: "rgba(0,0,0,0.5)" },
              },
            },
          },
        });
      }

      /* CSV */
      csvBtn.onclick = () => {
        let csv = "Title,Sub,Date,Time,Duration\n";
        data.forEach(
          (d) => (csv += `${d.t},${d.s},${d.d},${d.time},${d.du}\n`),
        );
        let a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([csv]));
        a.download = "timer.csv";
        a.click();
      };

      /* DROPDOWNS */
      const colorDD = document.getElementById("colorDropdown");
      Object.keys(colors).forEach((k) => {
        let o = document.createElement("option");
        o.text = k;
        o.value = colors[k];
        colorDD.add(o);
      });

      colorDD.onchange = () => {
        let c = colorDD.value;
        setThemeVars(c);
        localStorage.setItem("userColor", c);
      };

      const fontDD = document.getElementById("fontDropdown");
      fonts.forEach((f) => {
        let o = document.createElement("option");
        o.text = f;
        o.value = f;
        fontDD.add(o);
      });
      fontDD.onchange = () => {
        display.style.fontFamily = fontDD.value;
        localStorage.setItem("userFont", fontDD.value);
      };

      // MODE
      const modeDD = document.getElementById("modeDropdown");
      modeDD.onchange = () => {
        applyMode(modeDD.value);
        localStorage.setItem("userMode", modeDD.value);
      };

      function applyMode(m) {
        if (m === "dark") {
          document.documentElement.style.setProperty("--bg", "#0f172a");
          document.documentElement.style.setProperty("--text", "#fff");
          document.documentElement.style.setProperty("--panel", "#1e293b");
        }
        if (m === "day") {
          document.documentElement.style.setProperty("--bg", "#f4f6f8");
          document.documentElement.style.setProperty("--text", "#000");
          document.documentElement.style.setProperty("--panel", "#fff");
        }
      }

      function setThemeVars(c) {
        document.documentElement.style.setProperty("--accent", c);
        document.documentElement.style.setProperty("--bg", c + "22");
        document.documentElement.style.setProperty("--panel", c + "33");
      }

      // FONT SIZE
      function fontSize(x) {
        if (x === "+") fontSizeVal += 4;
        if (x === "-") fontSizeVal -= 4;
        display.style.fontSize = fontSizeVal + "px";
        localStorage.setItem("userFontSize", fontSizeVal);
      }

      /* LOAD USER PREFS */
      window.onload = () => {
        let c = localStorage.getItem("userColor");
        let f = localStorage.getItem("userFont");
        let m = localStorage.getItem("userMode");
        let fs = localStorage.getItem("userFontSize");

        if (c) {
          colorDD.value = c;
          setThemeVars(c);
        }
        if (f) {
          fontDD.value = f;
          display.style.fontFamily = f;
        }
        if (m) {
          modeDD.value = m;
          applyMode(m);
        }
        if (fs) {
          fontSizeVal = parseInt(fs, 10) || fontSizeVal;
          display.style.fontSize = fontSizeVal + "px";
        }
      };

      render();
    </script>
  </body>
</html>
