<!-- FULL UPDATED VERSION: CLEAN B/W UI, FIXED DATES, LOCALSTORAGE, REFRESH LOCK, PIE CHART, STABLE HEADER, BACKEND INTEGRATION -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pro Work Time Tracker</title>
    <link rel="icon" type="image/png" href="logo/logo.png" />

    <!-- REDIRECT TO WELCOME PAGE IF FIRST VISIT, THEN CHECK AUTH -->
    <script>
      (function () {
        // Check if user came directly to index.html (not from another page)
        var fromApp = sessionStorage.getItem("pwtm_from_app");
        var token = localStorage.getItem("pwtm_auth_token");
        var userData = localStorage.getItem("pwtm_user_data");

        // If not logged in, go to login
        if (!token || !userData) {
          window.location.replace("login.html");
          return;
        }

        // Mark that user is now in the app
        sessionStorage.setItem("pwtm_from_app", "true");
      })();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="config.js"></script>
    <script src="database.js"></script>
    <style>
      :root {
        --bg: #f8f9fa;
        --fg: #111111;
        --muted: #666;
        --border: #ddd;
        --primary: #4f46e5;
        --success: #10b981;
        --danger: #ef4444;
        --accent: #3b82f6;
      }
      * {
        box-sizing: border-box;
        font-family:
          Segoe UI,
          Arial,
          sans-serif;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--fg);
      }
      header {
        position: sticky;
        top: 0;
        z-index: 10;
        background: #fff;
        border-bottom: 2px solid var(--primary);
        padding: 12px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      header h1 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: var(--primary);
      }
      header .right {
        display: flex;
        gap: 10px;
      }
      button {
        border: 1px solid var(--border);
        background: #fff;
        color: #000;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
      }
      button:hover {
        background: #f3f3f3;
        border-color: var(--primary);
      }
      button.running {
        background: var(--success);
        color: #fff;
        border-color: var(--success);
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      @media (max-width: 600px) {
        button {
          touch-action: manipulation;
          -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
        }
      }
      main {
        padding: 20px;
        max-width: 1400px;
        margin: auto;
      }
      .main-container {
        display: grid;
        grid-template-columns: 0.8fr 3fr;
        gap: 20px;
      }
      .left-panel {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .right-panel {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      #totalRunning {
        font-size: 26px;
        font-weight: 600;
        text-align: center;
        margin: 0 0 20px 0;
        white-space: nowrap;
        color: var(--primary);
      }
      .running-section {
        background: #fff;
        border: 2px solid var(--success);
        border-radius: 10px;
        padding: 16px;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.1);
      }
      .running-section h2 {
        margin: 0 0 12px 0;
        color: var(--success);
        font-size: 16px;
        text-align: center;
      }
      .running-card {
        background: #f0fff4;
        border: 1px solid var(--success);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 10px;
        text-align: center;
      }
      .running-card h4 {
        margin: 0 0 8px 0;
        color: var(--primary);
        font-size: 14px;
        word-break: break-word;
      }
      .running-card .time-display {
        color: var(--success);
        font-weight: 600;
        font-size: 12px;
        margin-bottom: 8px;
      }
      .running-card button {
        width: 100%;
        padding: 8px;
        margin: 0;
        font-size: 12px;
      }
      .task-list-section {
        background: #fff;
        border: 2px solid var(--primary);
        border-radius: 10px;
        padding: 16px;
        box-shadow: 0 2px 8px rgba(79, 70, 229, 0.1);
      }
      .task-list-section h2 {
        margin: 0 0 12px 0;
        color: var(--primary);
        font-size: 16px;
        text-align: center;
      }
      .task-list {
        list-style: none;
        margin: 0;
        padding: 0;
      }
      .task-list li {
        margin-bottom: 8px;
      }
      .task-list-link {
        display: block;
        padding: 8px 12px;
        background: #f0f4ff;
        border: 1px solid var(--primary);
        border-radius: 6px;
        color: var(--primary);
        text-decoration: none;
        cursor: pointer;
        font-weight: 500;
        font-size: 12px;
        transition: all 0.2s;
        text-align: left;
        word-break: break-word;
      }
      .task-list-link:hover {
        background: var(--primary);
        color: #fff;
      }
      .task-list-link.running {
        background: #ecfdf5;
        border-color: var(--success);
        color: var(--success);
        font-weight: 600;
      }
      .task-list-link.completed {
        background: #fef2f2;
        border-color: #fee2e2;
        color: var(--muted);
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 100;
        align-items: center;
        justify-content: center;
      }
      .modal.active {
        display: flex;
      }
      .modal-content {
        background: #fff;
        border: 2px solid var(--primary);
        border-radius: 8px;
        padding: 20px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      }
      .modal-content h2 {
        margin: 0 0 16px 0;
        color: var(--primary);
        font-size: 18px;
      }
      .shortcut-modal-content {
        width: 70%;
        max-width: 1000px;
        max-height: 80vh;
        overflow: auto;
      }
      .shortcut-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 12px;
      }
      .shortcut-table th,
      .shortcut-table td {
        border: 1px solid var(--border);
        padding: 8px 6px;
        text-align: left;
      }
      .shortcut-table th {
        background: var(--primary);
        color: #fff;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 1;
      }
      .shortcut-table tr:nth-child(even) {
        background: rgba(79, 70, 229, 0.06);
      }
      .sheet-list {
        list-style: none;
        margin: 0 0 16px 0;
        padding: 0;
      }
      .sheet-item {
        padding: 10px 12px;
        margin-bottom: 8px;
        background: #f8f9fa;
        border: 1px solid var(--border);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .sheet-item:hover {
        background: #e8ecf8;
        border-color: var(--primary);
      }
      .sheet-item.active {
        background: var(--primary);
        color: #fff;
        border-color: var(--primary);
        font-weight: 600;
      }
      .sheet-actions {
        display: flex;
        gap: 6px;
      }
      .sheet-actions button {
        padding: 4px 8px;
        font-size: 12px;
      }
      .create-sheet-btn {
        width: 100%;
        padding: 10px;
        background: var(--success);
        color: #fff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        margin-bottom: 10px;
      }
      .create-sheet-btn:hover {
        background: #059669;
      }
      .home-sidebar {
        position: fixed;
        left: 0;
        top: 0;
        width: 70%;
        height: 100%;
        background: #fff;
        border-right: 3px solid var(--primary);
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.15);
        z-index: 99;
        overflow-y: auto;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      .home-sidebar.active {
        transform: translateX(0);
      }
      .sidebar-header {
        padding: 20px;
        background: var(--primary);
        color: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      .sidebar-header h2 {
        margin: 0;
        font-size: 18px;
      }
      .sidebar-close {
        background: transparent;
        border: none;
        color: #fff;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
      }
      .running-tasks-list {
        padding: 20px;
      }
      .running-task-card {
        background: #f8f9fa;
        border: 2px solid var(--success);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
      }
      .running-task-card h4 {
        margin: 0 0 8px 0;
        color: var(--primary);
        font-size: 14px;
      }
      .running-task-card .sheet-name {
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 4px;
      }
      .running-task-card .timer {
        font-size: 24px;
        font-weight: 600;
        color: var(--success);
        margin-bottom: 8px;
      }
      .running-task-card button {
        width: 100%;
        padding: 8px;
        background: var(--danger);
        color: #fff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
      }
      .running-task-card button:hover {
        background: #dc2626;
      }
      .no-running {
        text-align: center;
        padding: 40px 20px;
        color: var(--muted);
        font-size: 14px;
      }
      .home-btn {
        margin-right: 10px;
      }
      /* Right-side menu drawer (20% width) */
      .menu-drawer {
        position: fixed;
        right: 0;
        top: 0;
        width: 20%;
        height: 100%;
        background: #fff;
        border-left: 3px solid var(--primary);
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.15);
        z-index: 101;
        overflow-y: auto;
        transform: translateX(100%);
        transition: transform 0.3s ease;
      }
      .menu-drawer.active {
        transform: translateX(0);
      }
      .menu-drawer .drawer-header {
        padding: 16px;
        background: var(--primary);
        color: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 102;
      }
      .menu-drawer .drawer-header h2 {
        margin: 0;
        font-size: 18px;
      }
      .menu-toggle-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 8px 12px;
        margin: 8px 0;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: #f8f9fa;
      }
      .menu-toggle-row .toggle-label {
        font-size: 12px;
        font-weight: 600;
        color: var(--fg);
      }
      .switch {
        position: relative;
        display: inline-block;
        width: 42px;
        height: 22px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #cbd5e1;
        transition: 0.2s;
        border-radius: 999px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 2px;
        top: 2px;
        background-color: #fff;
        transition: 0.2s;
        border-radius: 50%;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }
      .switch input:checked + .slider {
        background-color: var(--success);
      }
      .switch input:checked + .slider:before {
        transform: translateX(20px);
      }
      body.hide-actions .actions-header,
      body.hide-actions .cell-actions {
        display: none;
      }
      /* History Modal Styles */
      .history-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }
      .history-modal.active {
        display: flex;
      }
      .history-modal-content {
        background: white;
        border-radius: 12px;
        padding: 24px;
        max-width: 900px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      }
      body.theme-dark .history-modal-content {
        background: #1f2937;
        color: #e5e7eb;
      }
      .history-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 2px solid var(--border);
        padding-bottom: 12px;
      }
      .history-modal-header h2 {
        margin: 0;
        font-size: 18px;
        color: var(--primary);
      }
      .history-modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--muted);
        padding: 0;
        width: 30px;
        height: 30px;
      }
      .history-modal-close:hover {
        color: var(--danger);
      }
      .history-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }
      .history-table thead {
        background: linear-gradient(135deg, #e0e7ff 0%, #f5f3ff 100%);
      }
      body.theme-dark .history-table thead {
        background: #374151;
      }
      .history-table th {
        padding: 12px;
        text-align: left;
        font-weight: 700;
        color: #4338ca;
        border-bottom: 2px solid var(--border);
      }
      body.theme-dark .history-table th {
        color: #93c5fd;
      }
      .history-table td {
        padding: 12px;
        border-bottom: 1px solid var(--border);
      }
      .history-table tr:hover {
        background: rgba(79, 70, 229, 0.05);
      }
      body.theme-dark .history-table tr:hover {
        background: rgba(79, 70, 229, 0.2);
      }
      .history-change {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
      }
      .history-old {
        background: rgba(239, 68, 68, 0.1);
        padding: 4px 8px;
        border-radius: 4px;
        color: #991b1b;
      }
      body.theme-dark .history-old {
        background: rgba(239, 68, 68, 0.3);
        color: #fca5a5;
      }
      .history-new {
        background: rgba(16, 185, 129, 0.1);
        padding: 4px 8px;
        border-radius: 4px;
        color: #065f46;
      }
      body.theme-dark .history-new {
        background: rgba(16, 185, 129, 0.3);
        color: #86efac;
      }
      .history-arrow {
        color: #9ca3af;
        font-weight: bold;
      }
      .comment-input-wrapper {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px solid var(--border);
      }
      .comment-input-wrapper label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--primary);
      }
      .comment-input-wrapper textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-family: inherit;
        font-size: 14px;
        resize: vertical;
        min-height: 80px;
        background: white;
        color: #000;
      }
      body.theme-dark .comment-input-wrapper textarea {
        background: #111827;
        color: #e5e7eb;
        border-color: #374151;
      }
      .history-modal-footer {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 20px;
      }
      .history-modal-footer button {
        padding: 10px 20px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
      }
      .history-modal-footer .btn-save {
        background: var(--success);
        color: white;
      }
      .history-modal-footer .btn-save:hover {
        opacity: 0.9;
      }
      .history-modal-footer .btn-close {
        background: var(--border);
        color: var(--fg);
      }
      .history-modal-footer .btn-close:hover {
        background: #999;
      }
      .drawer-close {
        background: transparent;
        border: none;
        color: #fff;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        transition: transform 0.2s;
      }
      .drawer-close:hover {
        transform: scale(1.1);
      }
      @media (max-width: 600px) {
        .menu-drawer .drawer-content a:hover {
          background: var(--primary);
          color: #fff;
        }
      }
      .menu-drawer .drawer-content {
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      @media (max-width: 1024px) {
        .main-container {
          grid-template-columns: 1fr;
        }
      }
      @media (max-width: 768px) {
        header {
          padding: 10px 12px;
          flex-wrap: wrap;
          gap: 8px;
        }
        header h1 {
          font-size: 16px;
          flex-basis: 100%;
          order: 2;
          margin-top: 8px;
        }
        header .left {
          order: 1;
          flex: 1;
          min-width: 100%;
        }
        header .right {
          order: 3;
          flex: 1;
          min-width: 100%;
          flex-wrap: wrap;
        }
        header .left button,
        header .right button {
          padding: 6px 8px;
          font-size: 12px;
          flex: 1;
          min-width: 50px;
        }
        .menu-drawer {
          width: 100%;
        }
        main {
          padding: 12px;
        }
        .card {
          padding: 12px;
          margin-bottom: 12px;
        }
        .controls {
          gap: 6px;
          flex-wrap: wrap;
        }
        .controls button {
          padding: 6px 8px;
          font-size: 11px;
          flex: 1;
          min-width: 45px;
        }
      }
      @media (max-width: 600px) {
        body {
          font-size: 13px;
        }
        header {
          padding: 8px 10px;
          gap: 6px;
        }
        header h1 {
          font-size: 14px;
          margin: 6px 0;
        }
        header .left,
        header .right {
          flex: 1;
          min-width: 100%;
          gap: 6px;
        }
        header .left button,
        header .right button {
          padding: 6px 6px;
          font-size: 11px;
          flex: 1;
          min-width: 40px;
        }
        .menu-drawer {
          width: 100%;
          border-left: 2px solid var(--primary);
        }
        .menu-drawer .drawer-header {
          padding: 12px;
        }
        .menu-drawer .drawer-header h2 {
          font-size: 16px;
        }
        .menu-drawer .drawer-content {
          padding: 6px;
          gap: 4px;
        }
        .menu-drawer .drawer-content a {
          padding: 12px 10px;
          font-size: 13px;
          border-radius: 6px;
          margin-bottom: 2px;
        }
        main {
          padding: 10px;
          max-width: 100%;
        }
        .main-container {
          grid-template-columns: 1fr;
          gap: 12px;
        }
        .card {
          padding: 10px;
          margin-bottom: 10px;
          border-radius: 8px;
        }
        .card h3 {
          font-size: 13px;
          margin-bottom: 8px;
        }
        .controls {
          gap: 4px;
          margin-bottom: 6px;
          flex-wrap: wrap;
        }
        .controls button {
          padding: 6px 6px;
          font-size: 10px;
          flex: 1;
          min-width: 35px;
          border-radius: 4px;
        }
        .controls .total-time {
          flex-basis: 100%;
          font-size: 11px;
          text-align: center;
          padding: 6px 0;
        }
        .card table {
          font-size: 10px;
          width: 100%;
          border-collapse: collapse;
          border: 1px solid var(--border);
        }
        .card table th,
        .card table td {
          padding: 4px 3px;
          word-break: break-word;
          border: 1px solid var(--border);
        }
        .card table th {
          background: linear-gradient(135deg, #e0e7ff 0%, #f5f3ff 100%);
          color: #4338ca;
          font-weight: 700;
        }
        .card table td.cell-date,
        .card table td.cell-time {
          position: relative;
          padding-right: 22px;
        }
        .card table td.cell-date.editing::after {
          content: "üìÖ";
          position: absolute;
          right: 6px;
          top: 50%;
          transform: translateY(-50%);
          font-size: 14px;
          opacity: 0.95;
          pointer-events: none;
          z-index: 2;
          display: inline-block;
          width: 14px;
          text-align: center;
        }
        .card table td.cell-time.editing::after {
          content: "‚è∞";
          position: absolute;
          right: 6px;
          top: 50%;
          transform: translateY(-50%);
          font-size: 14px;
          opacity: 0.95;
          pointer-events: none;
          z-index: 2;
          display: inline-block;
          width: 14px;
          text-align: center;
        }
        .card table tr.edit-mode {
          background: linear-gradient(135deg, #fff7ed 0%, #fef3c7 100%);
        }
        .cell-picker {
          position: absolute;
          right: 4px;
          top: 50%;
          transform: translateY(-50%);
          border: none;
          background: transparent;
          cursor: pointer;
          font-size: 14px;
          line-height: 1;
          padding: 0;
          color: #6b21a8;
        }
        .cell-picker:hover {
          color: #7c3aed;
        }
        .picker-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: none;
          align-items: center;
          justify-content: center;
          z-index: 1000;
          backdrop-filter: blur(4px);
        }
        .picker-overlay.active {
          display: flex;
          animation: fadeInOverlay 0.3s ease-out;
        }
        @keyframes fadeInOverlay {
          from {
            opacity: 0;
          }
          to {
            opacity: 1;
          }
        }
        .picker-modal {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          border-radius: 16px;
          padding: 28px;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
          min-width: 340px;
          animation: slideUp 0.3s ease-out;
          border: 3px solid #fff;
        }
        @keyframes slideUp {
          from {
            transform: translateY(20px);
            opacity: 0;
          }
          to {
            transform: translateY(0);
            opacity: 1;
          }
        }
        .picker-modal h3 {
          margin: 0 0 20px 0;
          color: #fff;
          font-size: 20px;
          text-align: center;
          font-weight: 700;
        }
        .picker-modal input {
          width: 100%;
          padding: 14px 16px;
          border: 2px solid #fff;
          border-radius: 10px;
          font-size: 16px;
          margin-bottom: 20px;
          background: #fff;
          color: #333;
          cursor: pointer;
          box-sizing: border-box;
          font-weight: 600;
        }
        .picker-modal input:focus {
          outline: none;
          border-color: #ffd700;
          box-shadow: 0 0 12px rgba(255, 215, 0, 0.6);
        }
        .picker-buttons {
          display: flex;
          gap: 12px;
          margin-top: 20px;
        }
        .picker-buttons button {
          flex: 1;
          padding: 14px;
          border: none;
          border-radius: 10px;
          font-size: 15px;
          font-weight: 700;
          cursor: pointer;
          transition: all 0.3s;
        }
        .picker-btn-ok {
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          color: #fff;
        }
        .picker-btn-ok:hover {
          transform: translateY(-2px);
          box-shadow: 0 10px 20px rgba(16, 185, 129, 0.4);
        }
        .picker-btn-cancel {
          background: #f3f4f6;
          color: #374151;
        }
        .picker-btn-cancel:hover {
          background: #e5e7eb;
          transform: translateY(-2px);
        }
        .calendar-popup {
          background: #2d2d2d;
          border: 1px solid #444;
          border-radius: 12px;
          padding: 20px;
          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
          z-index: 10000;
          animation: slideUp 0.3s ease-out;
          position: fixed;
        }
        .calendar-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: 20px;
          color: #fff;
          font-weight: 700;
        }
        .calendar-header .cal-month {
          font-size: 18px;
          flex: 1;
          text-align: center;
        }
        .calendar-header .cal-nav {
          background: transparent;
          border: none;
          color: #999;
          width: 28px;
          height: 28px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 18px;
          font-weight: 400;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .calendar-header .cal-nav:hover {
          background: rgba(255, 255, 255, 0.1);
          color: #fff;
        }
        .calendar-weekdays {
          display: grid;
          grid-template-columns: repeat(7, 40px);
          gap: 4px;
          margin-bottom: 10px;
          color: #999;
          font-weight: 600;
          text-align: center;
          font-size: 11px;
        }
        .calendar-weekdays div {
          padding: 8px 0;
        }
        .calendar-days {
          display: grid;
          grid-template-columns: repeat(7, 40px);
          gap: 4px;
          margin-bottom: 15px;
        }
        .cal-day {
          width: 40px;
          height: 40px;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 6px;
          color: #fff;
          font-weight: 500;
          font-size: 14px;
          background: transparent;
          cursor: pointer;
          transition: all 0.15s ease;
          user-select: none;
        }
        .cal-day.other-month {
          color: #666;
          background: transparent;
          cursor: default;
        }
        .cal-day:not(.disabled):not(.other-month):hover {
          background: rgba(255, 255, 255, 0.1);
        }
        .cal-day.selected {
          background: #6366f1 !important;
          color: #fff !important;
          font-weight: 600;
          border: 2px solid #8b5cf6;
        }
        .cal-day.disabled {
          color: #555;
          cursor: not-allowed !important;
          pointer-events: none;
        }
        .calendar-footer {
          text-align: center;
          border-top: 1px solid #444;
          padding-top: 12px;
        }
        .calendar-footer .cal-today {
          background: transparent;
          border: none;
          color: #999;
          padding: 6px 12px;
          border-radius: 6px;
          cursor: pointer;
          font-weight: 500;
          font-size: 13px;
        }
        .calendar-footer .cal-today:hover {
          background: rgba(255, 255, 255, 0.1);
          color: #fff;
        }
        .time-popup {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          border: 3px solid #fff;
          border-radius: 16px;
          padding: 24px;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
          z-index: 1001;
          animation: slideUp 0.3s ease-out;
          min-width: 300px;
        }
        .time-header {
          font-size: 20px;
          font-weight: 700;
          color: #fff;
          text-align: center;
          margin-bottom: 20px;
        }
        .time-inputs {
          display: flex;
          align-items: flex-end;
          justify-content: center;
          gap: 8px;
          margin-bottom: 20px;
        }
        .time-field {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 8px;
        }
        .time-field label {
          color: #fff;
          font-size: 13px;
          font-weight: 700;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }
        .time-field input {
          width: 70px;
          padding: 12px 8px;
          border: 2px solid #fff;
          border-radius: 10px;
          background: #fff;
          color: #333;
          font-size: 20px;
          font-weight: 700;
          text-align: center;
        }
        .time-field input:focus {
          outline: none;
          border-color: #ffd700;
          box-shadow: 0 0 12px rgba(255, 215, 0, 0.6);
        }
        .time-separator {
          color: #fff;
          font-size: 32px;
          font-weight: 700;
          margin-bottom: 8px;
        }
        .time-buttons {
          display: flex;
          gap: 12px;
        }
        .time-btn-ok,
        .time-btn-cancel {
          flex: 1;
          padding: 10px;
          border: none;
          border-radius: 8px;
          font-weight: 700;
          cursor: pointer;
          transition: all 0.3s;
        }
        .time-btn-ok {
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          color: #fff;
        }
        .time-btn-ok:hover {
          transform: translateY(-2px);
          box-shadow: 0 10px 20px rgba(16, 185, 129, 0.4);
        }
        .time-btn-cancel {
          background: #f3f4f6;
          color: #374151;
        }
        .time-btn-cancel:hover {
          background: #e5e7eb;
          transform: translateY(-2px);
        }
        .card table tr.edit-mode td[contenteditable="true"] {
          background: #fffacd;
          border: 1px solid var(--primary);
          border-radius: 3px;
          outline: none;
          padding: 3px 2px;
        }
        .card table tr.edit-mode td[contenteditable="true"]:focus {
          background: #ffffcc;
          box-shadow: inset 0 0 3px rgba(79, 70, 229, 0.3);
        }
        .running-section {
          padding: 10px;
          border-radius: 8px;
        }
        .running-section h2 {
          font-size: 13px;
          margin-bottom: 8px;
        }
        .running-card {
          padding: 8px;
          margin-bottom: 6px;
          border-radius: 6px;
        }
        .running-card h4 {
          font-size: 11px;
          margin-bottom: 4px;
        }
        .running-card .time-display {
          font-size: 12px;
          margin-bottom: 6px;
        }
        .task-list-section {
          padding: 10px;
          border-radius: 8px;
        }
        .task-list-section h2 {
          font-size: 13px;
          margin-bottom: 8px;
        }
        .task-list li {
          margin-bottom: 4px;
        }
        .task-list-link {
          padding: 10px 10px;
          font-size: 12px;
          border-radius: 6px;
          margin-bottom: 2px;
        }
        .modal-content {
          width: 95%;
          padding: 15px;
        }
        .modal-content h2 {
          font-size: 16px;
          margin-bottom: 12px;
        }
        .sheet-item {
          padding: 10px;
          margin-bottom: 6px;
          font-size: 12px;
        }
        .analytics-icon {
          margin-left: 2px;
          font-size: 14px;
          cursor: pointer;
        }
        .home-sidebar {
          width: 100%;
          border-right: 2px solid var(--primary);
        }
        .sidebar-header {
          padding: 12px;
        }
        .sidebar-header h2 {
          font-size: 16px;
        }
        .running-tasks-list {
          padding: 10px;
        }
        .running-task-card {
          padding: 10px;
          margin-bottom: 8px;
          border-radius: 6px;
        }
        .running-task-card h4 {
          font-size: 12px;
          margin-bottom: 4px;
        }
        .analytics {
          padding: 10px;
        }
        .analytics h3 {
          font-size: 13px;
        }
        .chart-container {
          margin-bottom: 20px;
          min-height: 250px;
        }
        canvas {
          max-width: 100% !important;
          height: auto !important;
        }
        .login-container {
          width: 95%;
          padding: 15px;
          border-radius: 8px;
        }
        .login-container h2 {
          font-size: 16px;
          margin-bottom: 12px;
        }
        .login-form input {
          padding: 10px;
          font-size: 14px;
          margin-bottom: 8px;
          border-radius: 6px;
        }
        .login-btn {
          padding: 10px;
          font-size: 14px;
          width: 100%;
          border-radius: 6px;
        }
        .welcome-container {
          width: 95%;
          padding: 15px;
          border-radius: 8px;
        }
        .welcome-icon {
          font-size: 48px;
          margin-bottom: 10px;
        }
        .welcome-container h2 {
          font-size: 16px;
          margin-bottom: 10px;
        }
      }
      @media (max-width: 480px) {
        header {
          padding: 6px 8px;
          gap: 4px;
        }
        header h1 {
          font-size: 12px;
          margin: 4px 0;
        }
        header .left button,
        header .right button {
          padding: 5px 5px;
          font-size: 10px;
        }
        .card h3 {
          font-size: 12px;
        }
        .card table {
          font-size: 9px;
          display: block;
          width: 100%;
        }
        .card table thead {
          display: none;
        }
        .card table tr {
          display: block;
          margin-bottom: 10px;
          border: 1px solid var(--border);
          border-radius: 4px;
          padding: 8px;
          background: #f8f9fa;
        }
        .card table td {
          display: block;
          padding: 4px 0;
          text-align: left;
        }
      }
      #totalRunning {
        font-size: 26px;
        font-weight: 600;
        text-align: center;
        margin: 20px 0;
        white-space: nowrap;
        color: var(--primary);
      }
      .card {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 14px;
        margin-bottom: 16px;
        background: #fff;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }
      .card h3 {
        margin: 0 0 10px 0;
        font-size: 16px;
        color: var(--primary);
      }
      .controls {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 10px;
        align-items: center;
      }
      .total-time {
        color: var(--success);
        font-weight: 600;
      }
      input[type="text"] {
        border: 1px solid var(--border);
        padding: 6px;
        border-radius: 6px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        background: #fff;
        color: #0f172a;
      }
      th,
      td {
        border: 1px solid var(--border);
        padding: 8px 6px;
        text-align: center;
        color: #0f172a;
        background: #fff;
      }
      th {
        background: #eef2ff;
        color: var(--primary);
        font-weight: 700;
      }
      .card {
        color: #0f172a;
      }
      .running-card,
      .running-section,
      .task-list-section {
        color: #0f172a;
      }
      /* Dark theme specific link contrast */
      body.theme-dark .task-list-link {
        background: #0f172a;
        border-color: #334155;
        color: #e5e7eb;
      }
      body.theme-dark .task-list-link.running {
        background: #052e1b;
        border-color: #16a34a;
        color: #22c55e;
      }
      .analytics {
        margin-top: 0;
        border-color: var(--accent);
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .analytics h3 {
        color: var(--primary);
        margin: 0 0 16px 0;
      }
      .analytics canvas {
        flex: 1;
      }
      .toggle-mode {
        display: inline-block;
        margin-left: 10px;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }
      .toggle-mode.single {
        background: var(--primary);
        color: #fff;
      }
      .toggle-mode.multi {
        background: #f0f0f0;
        color: var(--muted);
      }
      canvas {
        max-height: 260px;
      }
      .login-modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 320px;
        background: #fff;
        border: 2px solid var(--primary);
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        z-index: 200;
      }
      .login-modal.active {
        display: block;
      }
      .login-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        z-index: 199;
      }
      .login-overlay.active {
        display: block;
      }
      .login-container {
        background: transparent;
        border: none;
        padding: 0;
        box-shadow: none;
        text-align: left;
      }
      .login-container h2 {
        margin: 0 0 16px 0;
        color: var(--primary);
        font-size: 16px;
        text-align: center;
      }
      .login-form {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .login-form input {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 12px;
        font-family: inherit;
      }
      .login-form input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
      }
      .login-btn {
        padding: 8px 16px;
        background: var(--primary);
        color: #fff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 12px;
        transition: all 0.2s;
        width: 100%;
      }
      .login-btn:hover {
        background: #4338ca;
      }
      .username-display {
        font-size: 12px;
        color: var(--muted);
        margin: 0 10px;
      }
      .user-badge {
        display: inline-block;
        background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%);
        color: #fff;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin: 0 10px;
        box-shadow: 0 2px 8px rgba(79, 70, 229, 0.2);
      }
      .user-badge.fixed-left {
        margin: 0 5px;
        position: static;
      }
      .welcome-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        z-index: 201;
        align-items: center;
        justify-content: center;
      }
      .welcome-modal.active {
        display: flex;
      }
      .welcome-container {
        background: #fff;
        border-radius: 16px;
        padding: 60px 40px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        text-align: center;
      }
      .welcome-icon {
        font-size: 64px;
        margin-bottom: 20px;
      }
      .welcome-container h2 {
        margin: 0 0 16px 0;
        color: var(--primary);
        font-size: 28px;
        font-weight: 700;
      }
      .welcome-container p {
        margin: 0 0 30px 0;
        color: var(--muted);
        font-size: 16px;
        line-height: 1.6;
      }
      .user-stats {
        background: #f0f4ff;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
        text-align: left;
      }
      .stat-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        font-size: 14px;
      }
      .stat-item:last-child {
        margin-bottom: 0;
      }
      .stat-label {
        color: var(--muted);
        font-weight: 500;
      }
      .stat-value {
        color: var(--primary);
        font-weight: 600;
      }
      .welcome-btn {
        background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%);
        color: #fff;
        border: none;
        padding: 12px 40px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
      }
      .welcome-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3);
      }
      .logout-btn {
        background: var(--danger);
        color: #fff;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        font-size: 12px;
      }
      .logout-btn:hover {
        background: #dc2626;
      }
      .logout-btn.fixed-left {
        margin: 0;
        position: static;
      }
      /* ===================== DARK THEME OVERRIDES ===================== */
      body.theme-dark {
        background: var(--bg);
        color: #e5e7eb;
      }
      body.theme-dark header {
        background: #111827;
        border-bottom-color: #334155;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
      }
      body.theme-dark header h1 {
        color: var(--primary);
      }
      body.theme-dark button {
        background: #1f2937;
        color: #e5e7eb;
        border-color: #334155;
      }
      body.theme-dark button:hover {
        background: #374151;
        border-color: var(--primary);
      }
      body.theme-dark .card,
      body.theme-dark .running-section,
      body.theme-dark .task-list-section {
        background: #0f172a;
        border-color: #1f2937;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.35);
        color: #e5e7eb;
      }
      body.theme-dark .running-card {
        background: #071a13;
        border-color: #14532d;
        color: #d1fae5;
      }
      body.theme-dark table {
        background: #0f172a;
        color: #e5e7eb;
      }
      body.theme-dark th,
      body.theme-dark td {
        background: #0f172a;
        color: #e5e7eb;
        border-color: #1f2937;
      }
      body.theme-dark th {
        background: #111827;
        color: #93c5fd;
      }
      body.theme-dark .menu-drawer {
        background: #0f172a;
        border-left-color: #334155;
      }
      body.theme-dark .drawer-header {
        background: var(--primary);
      }
      body.theme-dark .menu-toggle-row {
        background: #111827;
        border-color: #1f2937;
      }
      body.theme-dark .menu-toggle-row .toggle-label {
        color: #e5e7eb;
      }
      body.theme-dark .slider {
        background-color: #374151;
      }
      body.theme-dark .home-sidebar {
        background: #0f172a;
        border-right-color: #334155;
      }
      body.theme-dark .sidebar-header {
        background: var(--primary);
      }
      /* Sheets Modal dark styling */
      body.theme-dark .modal-content {
        background: #0f172a;
        border-color: #334155;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
        color: #e5e7eb;
      }
      body.theme-dark .modal-content h2 {
        color: #93c5fd;
      }
      body.theme-dark .sheet-item {
        background: #0b1221;
        border-color: #1f2937;
        color: #e5e7eb;
      }
      body.theme-dark .sheet-item:hover {
        background: #111827;
        border-color: #334155;
      }
      body.theme-dark .sheet-item.active {
        background: #2563eb;
        color: #fff;
        border-color: #2563eb;
      }
      body.theme-dark .sheet-actions button {
        background: #1f2937;
        border: 1px solid #334155;
        color: #e5e7eb;
      }
      body.theme-dark .sheet-actions button:hover {
        background: #374151;
        border-color: #3b82f6;
        color: #fff;
      }
      body.theme-dark .create-sheet-btn {
        background: #111827;
        color: #e5e7eb;
        border: 1px solid #334155;
      }
      body.theme-dark .create-sheet-btn:hover {
        background: #1f2937;
        border-color: #3b82f6;
        color: #93c5fd;
      }
      /* Home sidebar running tasks readability */
      body.theme-dark .running-task-card {
        background: #071a13;
        border-color: #14532d;
        color: #d1fae5;
      }
      body.theme-dark .running-task-card .sheet-name {
        color: #cbd5e1;
      }
      /* Toggle mode button dark styles */
      body.theme-dark .toggle-mode.single {
        background: #2563eb;
        color: #fff;
      }
      body.theme-dark .toggle-mode.single:hover {
        background: #1d4ed8;
      }
      body.theme-dark .toggle-mode.multi {
        background: #111827;
        color: #e5e7eb;
        border: 1px solid #334155;
      }
      body.theme-dark .toggle-mode.multi:hover {
        background: #1f2937;
      }
      body.theme-dark .analytics-content {
        background: #0f172a;
        border: 1px solid #1f2937;
        color: #e5e7eb;
      }
      body.theme-dark .analytics-header {
        border-bottom-color: #1f2937;
      }
      body.theme-dark .analytics-header h2 {
        color: #93c5fd;
      }
      body.theme-dark .analytics-tab {
        color: #cbd5f5;
      }
      body.theme-dark .analytics-tab.active {
        color: #93c5fd;
        border-bottom-color: #93c5fd;
      }
      body.theme-dark .analytics-tab-content h3 {
        color: #93c5fd;
      }
      body.theme-dark .analytics-tab-content table {
        background: #0f172a;
      }
      body.theme-dark .analytics-tab-content th {
        background: #111827;
        color: #93c5fd;
        border-color: #1f2937;
      }
      body.theme-dark .analytics-tab-content td {
        background: #0f172a;
        color: #e5e7eb;
        border-color: #1f2937;
      }
      /* Dark mode for filter indicator */
      body.theme-dark #filterIndicator {
        background: linear-gradient(135deg, #1e293b 0%, #1f2937 100%);
        border-color: #3b82f6;
        color: #93c5fd;
      }
      body.theme-dark #filterIndicator strong {
        color: #60a5fa;
      }
      /* Analytics Modal Styles */
      #analyticsModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 999;
        align-items: center;
        justify-content: center;
        overflow-y: auto;
      }
      #analyticsModal.active {
        display: flex;
      }
      .analytics-content {
        background: #fff;
        border-radius: 12px;
        padding: 30px;
        width: 90%;
        max-width: 1200px;
        max-height: 90vh;
        overflow-y: auto;
        margin: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      }
      .analytics-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid var(--border);
      }
      .analytics-header h2 {
        margin: 0;
        color: var(--primary);
        font-size: 24px;
      }
      .analytics-close {
        background: var(--danger);
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
      }
      .analytics-close:hover {
        background: #dc2626;
      }
      .analytics-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        border-bottom: 2px solid var(--border);
        flex-wrap: wrap;
      }
      .analytics-tab {
        padding: 12px 20px;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-weight: 600;
        color: var(--muted);
        transition: all 0.3s;
        font-size: 14px;
      }
      .analytics-tab:hover {
        color: var(--primary);
      }
      .analytics-tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
      }
      .analytics-tab-content {
        display: none;
      }
      .analytics-tab-content.active {
        display: block;
      }
      .analytics-title-btn {
        background: transparent;
        border: none;
        color: var(--primary);
        font-size: 14px;
        margin: 10px 0;
        padding: 0;
        cursor: pointer;
        text-align: left;
        font-weight: 600;
      }
      .analytics-title-btn:hover {
        text-decoration: underline;
      }

      /* Power BI Style Filter Indicator */
      #filterIndicator {
        animation: slideIn 0.3s ease-out;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      #filterIndicator button:hover {
        background: #dc2626 !important;
        transform: scale(1.05);
      }

      /* Chart hover effect for cross-filtering */
      .analytics canvas {
        cursor: pointer;
        transition: transform 0.2s ease;
      }
      .analytics canvas:hover {
        transform: scale(1.01);
      }

      #analyticsDetailModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }
      #analyticsDetailModal.active {
        display: flex;
      }
      .analytics-detail-content {
        background: #fff;
        border-radius: 12px;
        width: 90vw;
        height: 90vh;
        padding: 24px;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      }
      .analytics-detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        border-bottom: 2px solid var(--border);
        padding-bottom: 12px;
      }
      .analytics-detail-header h2 {
        margin: 0;
        color: var(--primary);
        font-size: 22px;
      }
      .analytics-detail-chart {
        height: 420px;
        margin-bottom: 24px;
      }
      .analytics-detail-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 24px;
        font-size: 13px;
      }
      .analytics-detail-table th,
      .analytics-detail-table td {
        border: 1px solid var(--border);
        padding: 8px 6px;
        text-align: center;
      }
      .analytics-detail-note {
        background: #f8fafc;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 16px;
        color: #0f172a;
      }
      body.theme-dark .analytics-detail-content {
        background: #0f172a;
        color: #e5e7eb;
      }
      body.theme-dark .analytics-detail-note {
        background: #111827;
        border-color: #334155;
        color: #e5e7eb;
      }
      .analytics-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: linear-gradient(135deg, var(--primary) 0%, #3b82f6 100%);
        color: #fff;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
      }
      .stat-card h4 {
        margin: 0 0 10px 0;
        font-size: 14px;
        opacity: 0.9;
      }
      .stat-card .value {
        font-size: 28px;
        font-weight: 700;
      }
      .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 30px;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
      }
      .analytics-icon {
        cursor: pointer;
        color: var(--primary);
        font-size: 18px;
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.2s;
      }
      .analytics-icon:hover {
        background: #f0f4ff;
        color: #3b82f6;
      }
      .login-error {
        color: var(--danger);
        font-size: 12px;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="left">
        <button
          class="home-btn"
          onclick="toggleHomeSidebar()"
          title="Home (Alt+H)"
        >
          üè† Home
        </button>
        <button onclick="downloadAll()">‚¨áÔ∏è CSV</button>
        <button onclick="addTracker()" title="Create New Task (Alt+1)">
          Ôºã Task
        </button>
        <button onclick="openSheetsModal()" title="Sheet List (Alt+2)">
          üìë Sheets
        </button>
      </div>

      <h1>
        Pro Work Time Tracker -
        <span
          id="sheetNameHeader"
          style="color: var(--success); font-size: 16px"
          >Sheet 1</span
        >
      </h1>
      <div class="right">
        <button
          id="modeBtn"
          class="toggle-mode single"
          onclick="toggleMode()"
          title="Single Task Mode: ON (click to allow multiple tasks) - Toggle (Alt+3)"
        >
          Single Task
        </button>
        <span id="userDisplay" class="user-badge" style="display: none"></span>
        <button
          class="logout-btn"
          onclick="handleLogout()"
          style="display: none"
          id="logoutBtn"
        >
          Logout
        </button>
        <button onclick="toggleMenuDrawer(true)" title="Open Menu (Alt+M)">
          Menu
        </button>
      </div>
    </header>
    <!-- Right-side Menu Drawer -->
    <div id="menuDrawer" class="menu-drawer" aria-hidden="true">
      <div class="drawer-header">
        <h2>Menu</h2>
        <button
          class="drawer-close"
          onclick="toggleMenuDrawer(false)"
          aria-label="Close Menu"
        >
          ‚úï
        </button>
      </div>
      <div class="drawer-content">
        <a
          class="task-list-link"
          href="welcome.html"
          title="Welcome Page"
          onmousedown="handleMenuLinkClick(event, 'welcome.html')"
          >üòé Know Me</a
        >
        <div
          class="menu-toggle-row"
          title="Show or hide Actions column (Alt+E)"
        >
          <span class="toggle-label" id="actionsToggleLabel">Actions: ON</span>
          <label class="switch">
            <input
              type="checkbox"
              id="actionsToggle"
              onchange="toggleActionsColumn(this.checked)"
            />
            <span class="slider"></span>
          </label>
        </div>
        <button
          id="themeToggleBtn"
          class="task-list-link"
          style="text-align: left"
          onclick="toggleThemeMode()"
          title="Toggle Dark/Day Mode (Alt+/)"
        >
          üåô Night Mode
        </button>
        <button
          class="task-list-link"
          style="text-align: left"
          onclick="openShortcutModal()"
          title="View shortcut keys"
        >
          ‚å®Ô∏è Shortcut key
        </button>
        <button
          class="task-list-link"
          style="text-align: left"
          onclick="exportAllSheetsCsv()"
          title="Export all sheets to CSV"
        >
          ‚¨áÔ∏è Export CSV
        </button>
        <button
          class="task-list-link"
          style="text-align: left"
          onclick="importAllSheetsCsv()"
          title="Import CSV to all sheets"
        >
          ‚¨ÜÔ∏è Import CSV
        </button>
        <a
          class="task-list-link"
          href="YearActivity.html"
          title="Year Activity Tracker"
          onmousedown="handleMenuLinkClick(event, 'YearActivity.html')"
          >üìÖ Year Activity</a
        >
        <a
          class="task-list-link"
          href="todo.html"
          title="Track your To-Do list"
          onmousedown="handleMenuLinkClick(event, 'todo.html')"
          >üìù To-Do</a
        >
        <a
          class="task-list-link"
          href="Timer.html"
          onmousedown="handleMenuLinkClick(event, 'Timer.html')"
          title="Tap Timer"
          >‚è±Ô∏è Timer</a
        >
        <!-- Create by me, button for the ProDoc.html -->
        <a
          class="task-list-link"
          href="ProDoc/ProDoc.html"
          title="ProDoc (Alt+D)"
          onmousedown="handleMenuLinkClick(event, 'ProDoc/ProDoc.html')"
          >üìÑ ProDoc (In development)</a
        >
        <a
          class="task-list-link"
          href="NotificationTimer.html"
          title="Smart Timer (Alt+S)"
          onmousedown="handleMenuLinkClick(event, 'NotificationTimer.html')"
          >üîî Smart Timer</a
        >
        <div
          style="
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            gap: 8px;
          "
        >
          <span
            id="drawerUserDisplay"
            class="user-badge"
            style="display: none"
          ></span>
          <button
            class="logout-btn"
            onclick="handleLogout()"
            id="drawerLogoutBtn"
            style="display: none"
          >
            Logout
          </button>
        </div>
      </div>
    </div>
    <input
      type="file"
      id="csvImportInput"
      accept=".csv,text/csv"
      style="display: none"
      onchange="handleCsvImport(event)"
    />

    <main>
      <div id="totalRunning">Total Running Time: 00:00:00.000</div>
      <div class="main-container">
        <div class="left-panel">
          <div class="running-section">
            <h2>üìå Currently Running</h2>
            <div id="runningTrackers"></div>
          </div>
          <div class="task-list-section">
            <h2>üìã All Tasks</h2>
            <ul class="task-list" id="taskList"></ul>
          </div>
        </div>
        <div class="right-panel">
          <div id="trackers"></div>
          <div class="card analytics">
            <h3>üìä Activity Analytics</h3>
            <div
              id="filterIndicator"
              style="
                display: none;
                align-items: center;
                padding: 10px 16px;
                margin-bottom: 16px;
                background: linear-gradient(135deg, #f0f4ff 0%, #e8f5e9 100%);
                border: 2px solid var(--primary);
                border-radius: 8px;
                font-size: 13px;
                color: var(--primary);
              "
            >
              <!-- Filter indicator content will be injected here -->
            </div>
            <p
              style="
                font-size: 12px;
                color: var(--muted);
                margin-bottom: 20px;
                text-align: center;
              "
            >
              üí° <strong>Power BI Style:</strong> Click on any task color in the
              charts below to filter all charts by that task. Click again to
              clear.
            </p>
            <div style="margin-bottom: 30px">
              <button
                class="analytics-title-btn"
                onclick="openAnalyticsDetail('bar', 'Duration & Session Count')"
                title="Open details"
              >
                Duration & Session Count
              </button>
              <canvas id="barChart"></canvas>
            </div>
            <div style="margin-bottom: 30px">
              <button
                class="analytics-title-btn"
                onclick="openAnalyticsDetail('pie', 'Task Distribution')"
                title="Open details"
              >
                Task Distribution
              </button>
              <canvas id="pieChart"></canvas>
            </div>
            <div style="margin-bottom: 30px">
              <button
                class="analytics-title-btn"
                onclick="openAnalyticsDetail('line', 'Time Trend Analysis')"
                title="Open details"
              >
                Time Trend Analysis
              </button>
              <canvas id="lineChart"></canvas>
            </div>
            <div style="margin-bottom: 30px">
              <button
                class="analytics-title-btn"
                onclick="
                  openAnalyticsDetail('doughnut', 'Task Completion Rate')
                "
                title="Open details"
              >
                Task Completion Rate
              </button>
              <canvas id="doughnutChart"></canvas>
            </div>
            <div style="margin-bottom: 30px">
              <button
                class="analytics-title-btn"
                onclick="openAnalyticsDetail('stacked', 'Days and Task')"
                title="Open details"
              >
                Days and Task
              </button>
              <canvas id="stackedDayChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- History Modal -->
    <div id="historyModal" class="history-modal">
      <div class="history-modal-content">
        <!-- Content will be inserted here by showRowHistory() -->
      </div>
    </div>

    <div id="homeSidebar" class="home-sidebar">
      <div class="sidebar-header">
        <h2>‚ö° Running Tasks</h2>
        <button class="sidebar-close" onclick="toggleHomeSidebar()">‚úï</button>
      </div>
      <div id="runningTasksList" class="running-tasks-list"></div>
    </div>

    <div id="loginOverlay" class="login-overlay" style="display: none"></div>

    <div id="welcomeModal" class="welcome-modal">
      <div class="welcome-container">
        <div class="welcome-icon">üëã</div>
        <h2 id="welcomeTitle">Welcome!</h2>
        <p id="welcomeMessage">
          You're all set! Let's start tracking your work time.
        </p>
        <div id="userStats" class="user-stats" style="display: none">
          <div class="stat-item">
            <span class="stat-label">Sheets Created:</span>
            <span class="stat-value" id="statSheets">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Total Tasks:</span>
            <span class="stat-value" id="statTasks">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Total Time Tracked:</span>
            <span class="stat-value" id="statTime">0h 0m</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Member Since:</span>
            <span class="stat-value" id="statJoined">-</span>
          </div>
        </div>
        <button class="welcome-btn" onclick="closeWelcomeModal()">
          Get Started
        </button>
      </div>
    </div>

    <!-- OLD LOGIN MODAL REMOVED - Using login.html instead -->

    <div id="sheetsModal" class="modal">
      <div class="modal-content">
        <h2>üìë Your Sheets</h2>
        <button class="create-sheet-btn" onclick="createNewSheet()">
          + Create New Sheet
        </button>
        <ul class="sheet-list" id="sheetsList"></ul>
      </div>
    </div>

    <div id="shortcutModal" class="modal" aria-hidden="true">
      <div class="modal-content shortcut-modal-content">
        <div
          style="
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
          "
        >
          <h2>‚å®Ô∏è Shortcut Keys</h2>
          <button class="drawer-close" onclick="closeShortcutModal()">‚úï</button>
        </div>
        <table class="shortcut-table">
          <thead>
            <tr>
              <th style="width: 60px">S.No</th>
              <th style="width: 130px">Shortcut key</th>
              <th>Which webpage it works</th>
              <th>Uses</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1</td>
              <td>Alt + E</td>
              <td>Timer sheet</td>
              <td>Enable/disable Actions column</td>
            </tr>
            <tr>
              <td>2</td>
              <td>Alt + M</td>
              <td>Timer sheet</td>
              <td>Open/close menu</td>
            </tr>
            <tr>
              <td>3</td>
              <td>Alt + /</td>
              <td>Timer sheet</td>
              <td>Toggle night/day mode</td>
            </tr>
            <tr>
              <td>4</td>
              <td>Alt + 1</td>
              <td>Timer sheet</td>
              <td>Create new task pop-up</td>
            </tr>
            <tr>
              <td>5</td>
              <td>Alt + 2</td>
              <td>Timer sheet</td>
              <td>Get the sheets list</td>
            </tr>
            <tr>
              <td>6</td>
              <td>Alt + 3</td>
              <td>Timer sheet</td>
              <td>Single/Multiple tasks mode</td>
            </tr>
            <tr>
              <td>7</td>
              <td>Alt + .</td>
              <td>Timer sheet</td>
              <td>For open the shortcut keys Pop-up</td>
            </tr>
            <tr>
              <td>8</td>
              <td>Alt + P</td>
              <td>Timer sheet</td>
              <td>Open ProDoc page</td>
            </tr>
            <tr>
              <td>9</td>
              <td>Alt + S</td>
              <td>Timer sheet</td>
              <td>Open Smart Timer page</td>
            </tr>
            <tr>
              <td>10</td>
              <td>Alt + O</td>
              <td>Timer sheet</td>
              <td>Open To-Do page</td>
            </tr>
            <tr>
              <td>11</td>
              <td>Alt + L</td>
              <td>Timer sheet</td>
              <td>Open Know me page</td>
            </tr>
            <tr>
              <td>12</td>
              <td>Alt + H</td>
              <td>Timer sheet</td>
              <td>Open Home tab</td>
            </tr>
            <tr>
              <td>13</td>
              <td>Alt + A</td>
              <td>Timer sheet</td>
              <td>
                Go do the Activity Analytics with out need scroll down in
                current sheet
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="analyticsModal" class="modal">
      <div class="analytics-content">
        <div class="analytics-header">
          <h2 id="analyticsTaskName">Task Analytics</h2>
          <button class="analytics-close" onclick="closeAnalytics()">
            Close
          </button>
        </div>

        <div class="analytics-tabs">
          <button
            class="analytics-tab active"
            onclick="switchAnalyticsTab('overview')"
          >
            üìä Overview
          </button>
          <button class="analytics-tab" onclick="switchAnalyticsTab('byday')">
            üìÖ By Date
          </button>
          <button class="analytics-tab" onclick="switchAnalyticsTab('bydays')">
            üìÖ By Days
          </button>
          <button
            class="analytics-tab"
            onclick="switchAnalyticsTab('distribution')"
          >
            üìà Distribution
          </button>
          <button
            class="analytics-tab"
            onclick="switchAnalyticsTab('sessions')"
          >
            ‚è±Ô∏è Sessions
          </button>
        </div>

        <!-- Overview Tab -->
        <div id="tab-overview" class="analytics-tab-content active">
          <div class="analytics-stats">
            <div class="stat-card">
              <h4>Total Time</h4>
              <div class="value" id="stat-total">0h</div>
            </div>
            <div
              class="stat-card"
              style="
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
              "
            >
              <h4>Sessions</h4>
              <div class="value" id="stat-sessions">0</div>
            </div>
            <div
              class="stat-card"
              style="
                background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
              "
            >
              <h4>Average Duration</h4>
              <div class="value" id="stat-average">0m</div>
            </div>
            <div
              class="stat-card"
              style="
                background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
              "
            >
              <h4>Longest Session</h4>
              <div class="value" id="stat-longest">0m</div>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="analyticsLineChart"></canvas>
          </div>
        </div>

        <!-- By Date Tab -->
        <div id="tab-byday" class="analytics-tab-content">
          <h3 style="color: var(--primary); margin-top: 0">
            Time Tracked by Day
          </h3>
          <div class="chart-container">
            <canvas id="analyticsDayChart"></canvas>
          </div>
        </div>

        <!-- By Days Tab -->
        <div id="tab-bydays" class="analytics-tab-content">
          <h3 style="color: var(--primary); margin-top: 0">
            Time Tracked by Days
          </h3>
          <div class="chart-container">
            <canvas id="analyticsWeekdayChart"></canvas>
          </div>
        </div>

        <!-- Distribution Tab -->
        <div id="tab-distribution" class="analytics-tab-content">
          <h3 style="color: var(--primary); margin-top: 0">
            Sessions Distribution
          </h3>
          <div class="chart-container">
            <canvas id="analyticsPieChart"></canvas>
          </div>
        </div>

        <!-- Sessions Tab -->
        <div id="tab-sessions" class="analytics-tab-content">
          <h3 style="color: var(--primary); margin-top: 0">All Sessions</h3>
          <div style="overflow-x: auto">
            <table
              style="width: 100%; border-collapse: collapse; font-size: 13px"
            >
              <thead>
                <tr
                  style="
                    background: #f0f4ff;
                    border-bottom: 2px solid var(--primary);
                  "
                >
                  <th
                    style="
                      padding: 12px;
                      text-align: left;
                      color: var(--primary);
                    "
                  >
                    Date
                  </th>
                  <th
                    style="
                      padding: 12px;
                      text-align: left;
                      color: var(--primary);
                    "
                  >
                    Start Time
                  </th>
                  <th
                    style="
                      padding: 12px;
                      text-align: left;
                      color: var(--primary);
                    "
                  >
                    End Time
                  </th>
                  <th
                    style="
                      padding: 12px;
                      text-align: right;
                      color: var(--primary);
                    "
                  >
                    Duration
                  </th>
                  <th
                    style="
                      padding: 12px;
                      text-align: right;
                      color: var(--primary);
                    "
                  >
                    Rank
                  </th>
                  <th
                    style="
                      padding: 12px;
                      text-align: right;
                      color: var(--primary);
                    "
                  >
                    Percentage
                  </th>
                </tr>
              </thead>
              <tbody id="sessionsTable">
                <tr>
                  <td
                    colspan="6"
                    style="
                      text-align: center;
                      padding: 20px;
                      color: var(--muted);
                    "
                  >
                    No sessions recorded
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div id="analyticsDetailModal" class="modal" aria-hidden="true">
      <div class="analytics-detail-content">
        <div class="analytics-detail-header">
          <h2 id="analyticsDetailTitle">Analytics Detail</h2>
          <button class="analytics-close" onclick="closeAnalyticsDetail()">
            Close
          </button>
        </div>
        <div class="analytics-detail-chart">
          <canvas id="analyticsDetailChart"></canvas>
        </div>
        <div id="analyticsDayTableSection" style="display: none">
          <h3 style="margin: 0 0 12px 0; color: var(--primary)">
            Days Summary
          </h3>
          <div style="overflow-x: auto; margin-bottom: 24px">
            <table class="analytics-detail-table">
              <thead>
                <tr>
                  <th>Day</th>
                  <th>Total Duration</th>
                  <th>Total Sessions</th>
                  <th>Rank</th>
                  <th>Percentage</th>
                </tr>
              </thead>
              <tbody id="analyticsDayTableBody"></tbody>
            </table>
          </div>
        </div>
        <div style="overflow-x: auto">
          <table class="analytics-detail-table">
            <thead>
              <tr>
                <th>Task</th>
                <th>Total Duration</th>
                <th>Total Count</th>
                <th>Min Duration</th>
                <th>Max Duration</th>
                <th>Rank</th>
                <th>Percentage</th>
              </tr>
            </thead>
            <tbody id="analyticsDetailTableBody"></tbody>
          </table>
        </div>
        <div class="analytics-detail-note">
          <h3 style="margin-top: 0">How to read this chart</h3>
          <p id="analyticsDetailDescription" style="margin: 0"></p>
        </div>
      </div>
    </div>

    <!-- Removed old ad-hoc menu; replaced by header button and drawer -->

    <script>
      /* -------------------- IMMEDIATE AUTH CHECK -------------------- */
      // Check authentication IMMEDIATELY before anything else loads
      (function () {
        const token = localStorage.getItem("pwtm_auth_token");
        const userData = localStorage.getItem("pwtm_user_data");
        if (!token || !userData) {
          // Not logged in - redirect to login page immediately
          window.location.href = "login.html";
          return;
        }
      })();

      /* -------------------- JWT AUTHENTICATION INTEGRATION -------------------- */
      // Storage keys for JWT auth (from login.html)
      const JWT_STORAGE_KEYS = {
        AUTH_TOKEN: "pwtm_auth_token",
        REFRESH_TOKEN: "pwtm_refresh_token",
        USER_DATA: "pwtm_user_data",
        DEVICE_ID: "pwtm_device_id",
      };

      // API Base URL for backend sync - use from config.js if available
      // (API_BASE_URL is already defined in config.js)

      // Check if user is logged in via JWT (from login.html)
      function isJWTAuthenticated() {
        const token = localStorage.getItem(JWT_STORAGE_KEYS.AUTH_TOKEN);
        const userData = localStorage.getItem(JWT_STORAGE_KEYS.USER_DATA);
        return token && userData;
      }

      // Get JWT user data
      function getJWTUser() {
        try {
          const userData = localStorage.getItem(JWT_STORAGE_KEYS.USER_DATA);
          return userData ? JSON.parse(userData) : null;
        } catch (e) {
          return null;
        }
      }

      // Get JWT token for API calls
      function getJWTToken() {
        return localStorage.getItem(JWT_STORAGE_KEYS.AUTH_TOKEN);
      }

      // Redirect to login page if not authenticated
      function redirectToLogin() {
        window.location.href = "login.html";
      }

      /* -------------------- BACKEND SYNC FUNCTIONS -------------------- */
      // Save data to backend server
      async function syncToServer(dataType, data) {
        const token = getJWTToken();
        if (!token) {
          console.log("‚ùå syncToServer: No token available");
          return { success: false, error: "Not authenticated" };
        }

        try {
          console.log(`üì§ Saving to: ${API_BASE_URL}/api/sync/${dataType}`);
          console.log(`üì§ Data size: ${JSON.stringify(data).length} bytes`);

          const response = await fetch(`${API_BASE_URL}/api/sync/${dataType}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(data),
          });

          console.log(`üì§ Response status: ${response.status}`);
          const result = await response.json();
          console.log(`üì§ Response:`, result);

          if (!response.ok) {
            console.log(
              `‚ùå Server error: ${response.status} - ${result.error || "Unknown error"}`,
            );
            return {
              success: false,
              error: result.error || `HTTP ${response.status}`,
            };
          }

          return result;
        } catch (error) {
          console.error("‚ùå Sync to server failed:", error);
          return { success: false, error: error.message };
        }
      }

      // Load data from backend server
      async function loadFromServer(dataType) {
        const token = getJWTToken();
        if (!token) {
          console.log("‚ùå loadFromServer: No token available");
          return { success: false, error: "Not authenticated" };
        }

        try {
          console.log(`üì° Fetching from: ${API_BASE_URL}/api/sync/${dataType}`);
          const response = await fetch(`${API_BASE_URL}/api/sync/${dataType}`, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          console.log(`üì° Response status: ${response.status}`);
          const result = await response.json();
          console.log(`üì° Response data:`, result);

          if (!response.ok) {
            console.log(
              `‚ùå Server error: ${response.status} - ${result.error || "Unknown error"}`,
            );
            return {
              success: false,
              error: result.error || `HTTP ${response.status}`,
            };
          }

          return result;
        } catch (error) {
          console.error("‚ùå Load from server failed:", error);
          return { success: false, error: error.message };
        }
      }

      /* -------------------- LOGIN SYSTEM -------------------- */
      // Check JWT auth first - if authenticated, skip local login completely
      let currentUser = null;

      // FIRST: Check if JWT authenticated (logged in via login.html)
      if (isJWTAuthenticated()) {
        const jwtUser = getJWTUser();
        if (jwtUser) {
          currentUser = jwtUser.username;
          // Sync JWT user with local database if not exists
          if (typeof db !== "undefined" && !db.userExists(currentUser)) {
            db.registerUser(currentUser, "jwt_auth_" + Date.now());
          }
          if (typeof db !== "undefined") {
            db.setCurrentUser(currentUser);
          }
        }
      } else {
        // Not JWT authenticated - redirect to login page
        window.location.href = "login.html";
      }

      /* OLD LOCAL LOGIN CODE REMOVED - Using login.html now */

      function displayUserBadge() {
        if (currentUser) {
          const badge = document.getElementById("userDisplay");
          const logoutBtn = document.getElementById("logoutBtn");
          if (badge) {
            badge.innerHTML = `üë§ ${currentUser.toUpperCase()}`;
            badge.classList.add("fixed-left");
            badge.style.display = "inline-block";
          }
          if (logoutBtn) {
            logoutBtn.classList.add("fixed-left");
            logoutBtn.style.display = "block";
          }
        }
      }

      function showWelcomeModal() {
        const stats = db.getUserStats(currentUser);

        // Update welcome message
        document.getElementById("welcomeTitle").textContent =
          `Welcome, ${currentUser}!`;
        document.getElementById("welcomeMessage").textContent =
          "Your account has been created successfully. Let's start tracking your work time!";

        // Show stats if not new
        if (!db.getUserData(currentUser).isNew || stats.totalTasks > 0) {
          document.getElementById("userStats").style.display = "block";
          document.getElementById("statSheets").textContent = stats.totalSheets;
          document.getElementById("statTasks").textContent = stats.totalTasks;
          document.getElementById("statTime").textContent =
            stats.totalTimeFormatted;
          document.getElementById("statJoined").textContent = stats.joinedDate;
        }

        document.getElementById("welcomeModal").classList.add("active");
      }

      function closeWelcomeModal() {
        document.getElementById("welcomeModal").classList.remove("active");
        render();
        drawCharts();
      }

      function handleLogout() {
        if (confirm("Are you sure you want to logout?")) {
          currentUser = null;
          db.logout();

          // Clear JWT tokens as well (from login.html auth)
          localStorage.removeItem(JWT_STORAGE_KEYS.AUTH_TOKEN);
          localStorage.removeItem(JWT_STORAGE_KEYS.REFRESH_TOKEN);
          localStorage.removeItem(JWT_STORAGE_KEYS.USER_DATA);

          // Clear app data from memory
          currentSheet = null;
          sheets = {};
          trackers = [];
          runningTimers = {};
          singleTaskMode = true;

          // Hide username badge and logout button
          const badge = document.getElementById("userDisplay");
          const logoutBtn = document.getElementById("logoutBtn");
          badge.style.display = "none";
          badge.classList.remove("fixed-left");
          logoutBtn.style.display = "none";
          logoutBtn.classList.remove("fixed-left");

          // Redirect to login page instead of showing modal
          window.location.href = "login.html";
        }
      }

      function loadUserData() {
        const userData = db.getUserData(currentUser);
        if (!userData) return;

        currentSheet = userData.currentSheet;
        sheets = userData.sheets;
        trackers = sheets[currentSheet] || [];
        runningTimers = userData.runningTimers || {};
        singleTaskMode = userData.singleTaskMode !== false;

        // Load row histories from localStorage
        loadRowHistories();

        // Update UI
        document.getElementById("sheetNameHeader").textContent = currentSheet;
        const modeBtn = document.getElementById("modeBtn");
        if (!singleTaskMode) {
          modeBtn.textContent = "Multiple Tasks";
          modeBtn.className = "toggle-mode multi";
          modeBtn.title =
            "Multiple Tasks Mode: ON (click to restrict to single task) - Toggle (Alt+3)";
        } else {
          modeBtn.textContent = "Single Task";
          modeBtn.className = "toggle-mode single";
          modeBtn.title =
            "Single Task Mode: ON (click to allow multiple tasks) - Toggle (Alt+3)";
        }
      }

      function saveUserData() {
        if (!currentUser) {
          console.log("‚ö†Ô∏è No user - data not saved");
          return;
        }

        // Save to user-specific localStorage key (for JWT users)
        const localKey = `pwtm_tracker_data_${currentUser}`;
        const dataToSave = {
          currentSheet: currentSheet,
          sheets: sheets,
          runningTimers: runningTimers,
          singleTaskMode: singleTaskMode,
          rowHistories: rowHistories,
          lastSaved: new Date().toISOString(),
        };
        localStorage.setItem(localKey, JSON.stringify(dataToSave));
        console.log("üíæ Saved to localStorage:", localKey);

        // Also save to local database for legacy support
        if (typeof db !== "undefined") {
          const existingData = db.getUserData(currentUser) || {};
          const userData = {
            password: existingData.password || "jwt_auth",
            createdAt: existingData.createdAt || new Date().toISOString(),
            currentSheet: currentSheet,
            sheets: sheets,
            runningTimers: runningTimers,
            singleTaskMode: singleTaskMode,
            isNew: false,
          };
          db.saveUserData(currentUser, userData);
        }

        // Save row histories to localStorage
        saveRowHistories();

        // Sync to server IMMEDIATELY (if JWT authenticated)
        if (isJWTAuthenticated()) {
          console.log("üîÑ Syncing to server...");
          showSyncStatus("syncing");
          syncToServer("tracker", dataToSave)
            .then((result) => {
              if (result.success) {
                console.log("‚úÖ Data synced to server successfully");
                showSyncStatus("synced");
              } else {
                console.log("‚ö†Ô∏è Server sync failed:", result.error);
                showSyncStatus("error");
              }
            })
            .catch((err) => {
              console.log("‚ö†Ô∏è Server sync pending:", err.message);
              showSyncStatus("error");
            });
        }
      }

      // Show sync status indicator
      function showSyncStatus(status) {
        let indicator = document.getElementById("syncIndicator");
        if (!indicator) {
          indicator = document.createElement("div");
          indicator.id = "syncIndicator";
          indicator.style.cssText =
            "position:fixed;bottom:20px;right:20px;padding:8px 16px;border-radius:20px;font-size:12px;font-weight:600;z-index:9999;transition:all 0.3s;";
          document.body.appendChild(indicator);
        }

        if (status === "syncing") {
          indicator.innerHTML = "üîÑ Syncing...";
          indicator.style.background = "#fef3c7";
          indicator.style.color = "#92400e";
          indicator.style.opacity = "1";
        } else if (status === "synced") {
          indicator.innerHTML = "‚úÖ Synced";
          indicator.style.background = "#d1fae5";
          indicator.style.color = "#065f46";
          indicator.style.opacity = "1";
          setTimeout(() => {
            indicator.style.opacity = "0";
          }, 2000);
        } else if (status === "error") {
          indicator.innerHTML = "‚ö†Ô∏è Sync failed";
          indicator.style.background = "#fee2e2";
          indicator.style.color = "#991b1b";
          indicator.style.opacity = "1";
          setTimeout(() => {
            indicator.style.opacity = "0";
          }, 3000);
        }
      }

      function saveRowHistories() {
        if (currentUser) {
          const historyKey = `rowHistories_${currentUser}_${currentSheet}`;
          localStorage.setItem(historyKey, JSON.stringify(rowHistories));
        }
      }

      function loadRowHistories() {
        if (currentUser) {
          const historyKey = `rowHistories_${currentUser}_${currentSheet}`;
          const stored = localStorage.getItem(historyKey);
          if (stored) {
            try {
              rowHistories = JSON.parse(stored);
            } catch (e) {
              console.error("Failed to load row histories:", e);
              rowHistories = {};
            }
          }
        } else {
          rowHistories = {};
        }
      }

      /* -------------------- THEME -------------------- */
      const THEME_KEY = "tt_theme";
      const ACTIONS_VISIBILITY_KEY = "tt_actions_column";

      function applyTheme(theme) {
        const root = document.documentElement;
        const isDark = theme === "dark";

        if (isDark) {
          root.style.setProperty("--bg", "#0f172a");
          root.style.setProperty("--fg", "#e5e7eb");
          root.style.setProperty("--muted", "#9ca3af");
          root.style.setProperty("--border", "#1f2937");
          root.style.setProperty("--primary", "#3b82f6");
          root.style.setProperty("--success", "#22c55e");
          root.style.setProperty("--danger", "#ef4444");
          root.style.setProperty("--accent", "#8b5cf6");
          document.body.style.background = "var(--bg)";
          document.body.classList.add("theme-dark");
        } else {
          root.style.setProperty("--bg", "#f8f9fa");
          root.style.setProperty("--fg", "#111111");
          root.style.setProperty("--muted", "#666");
          root.style.setProperty("--border", "#ddd");
          root.style.setProperty("--primary", "#4f46e5");
          root.style.setProperty("--success", "#10b981");
          root.style.setProperty("--danger", "#ef4444");
          root.style.setProperty("--accent", "#3b82f6");
          document.body.style.background = "var(--bg)";
          document.body.classList.remove("theme-dark");
        }

        const btn = document.getElementById("themeToggleBtn");
        if (btn) {
          btn.textContent = isDark ? "‚òÄÔ∏è Day Mode" : "üåô Night Mode";
        }
      }

      function toggleThemeMode() {
        const current = localStorage.getItem(THEME_KEY) || "light";
        const next = current === "dark" ? "light" : "dark";
        localStorage.setItem(THEME_KEY, next);
        applyTheme(next);
      }

      function applyActionsVisibility(isVisible) {
        document.body.classList.toggle("hide-actions", !isVisible);
        const toggle = document.getElementById("actionsToggle");
        if (toggle) {
          toggle.checked = isVisible;
        }
        const label = document.getElementById("actionsToggleLabel");
        if (label) {
          label.textContent = isVisible ? "Actions: ON" : "Actions: OFF";
        }
      }

      function toggleActionsColumn(isVisible) {
        localStorage.setItem(ACTIONS_VISIBILITY_KEY, isVisible ? "on" : "off");
        applyActionsVisibility(isVisible);
      }

      document.addEventListener("DOMContentLoaded", () => {
        applyTheme(localStorage.getItem(THEME_KEY) || "light");
        const stored = localStorage.getItem(ACTIONS_VISIBILITY_KEY);
        applyActionsVisibility(stored !== "off");
      });

      /* -------------------- STORAGE -------------------- */
      let currentSheet = "Sheet 1";
      let sheets = { "Sheet 1": [] };
      let trackers = [];
      let runningTimers = {};
      let singleTaskMode = true;
      let rowHistories = {}; // Track edit history for rows in format: "taskIdx-rowIdx": [{changes}, ...]
      let serverDataLoaded = false;
      let liveSyncInterval = null; // For live sync across devices

      // Function to load data from server
      async function loadDataFromServer(forceUpdate = false) {
        if (!isJWTAuthenticated()) {
          console.log("‚ùå Not authenticated, cannot load from server");
          return false;
        }

        try {
          console.log("üîÑ Loading data from server...");
          const result = await loadFromServer("tracker");
          console.log("üì• Server response:", result);

          // DEBUG: Show what we got from server
          if (result && result.data) {
            console.log("üìä Server data keys:", Object.keys(result.data));
            console.log(
              "üìä Server sheets:",
              result.data.sheets ? Object.keys(result.data.sheets) : "none",
            );
            console.log(
              "üìä Current sheet from server:",
              result.data.currentSheet,
            );
          }

          if (result.success) {
            if (result.data && Object.keys(result.data).length > 0) {
              // Server has data - load it
              currentSheet = result.data.currentSheet || "Sheet 1";
              sheets = result.data.sheets || { "Sheet 1": [] };
              trackers = sheets[currentSheet] || [];
              runningTimers = result.data.runningTimers || {};
              singleTaskMode = result.data.singleTaskMode !== false;

              console.log(
                "‚úÖ Loaded from server - currentSheet:",
                currentSheet,
              );
              console.log(
                "‚úÖ Loaded from server - sheets count:",
                Object.keys(sheets).length,
              );
              console.log(
                "‚úÖ Loaded from server - trackers in current sheet:",
                trackers.length,
              );

              // Load rowHistories from server if available
              if (result.data.rowHistories) {
                rowHistories = result.data.rowHistories;
                // Also save to localStorage for the current sheet
                saveRowHistories();
              }

              // Save to local storage as cache
              const localKey = `pwtm_tracker_data_${currentUser}`;
              localStorage.setItem(localKey, JSON.stringify(result.data));

              serverDataLoaded = true;
              console.log(
                "‚úÖ Data loaded from server (including row histories)",
              );
              return true;
            } else {
              // Server responded OK but no data exists yet
              console.log(
                "‚ÑπÔ∏è Server has no data for this user yet (new user or cleared data)",
              );
              serverDataLoaded = true; // Mark as loaded so we don't keep retrying
              return true; // Return true so UI renders with empty state
            }
          } else {
            console.log("‚ùå Server returned error:", result.error);
          }
        } catch (error) {
          console.log("‚ùå Server load failed, using local data:", error);
        }
        return false;
      }

      // Live sync function - check server for updates periodically
      async function checkForServerUpdates() {
        if (!isJWTAuthenticated() || !serverDataLoaded) return;

        try {
          const result = await loadFromServer("tracker");
          if (result.success && result.data && result.data.lastSaved) {
            const localKey = `pwtm_tracker_data_${currentUser}`;
            const localData = localStorage.getItem(localKey);
            const localParsed = localData ? JSON.parse(localData) : null;

            // Compare timestamps - if server is newer, update
            if (
              !localParsed ||
              !localParsed.lastSaved ||
              new Date(result.data.lastSaved) > new Date(localParsed.lastSaved)
            ) {
              console.log("üîÑ Live sync: Server has newer data, updating...");

              currentSheet = result.data.currentSheet || "Sheet 1";
              sheets = result.data.sheets || { "Sheet 1": [] };
              trackers = sheets[currentSheet] || [];
              runningTimers = result.data.runningTimers || {};
              singleTaskMode = result.data.singleTaskMode !== false;
              if (result.data.rowHistories) {
                rowHistories = result.data.rowHistories;
              }

              // Update local cache
              localStorage.setItem(localKey, JSON.stringify(result.data));

              // Update UI
              render();
              drawCharts();
              console.log("‚úÖ Live sync: UI updated with server data");
            }
          }
        } catch (e) {
          // Silent fail for background sync
        }
      }

      // Start live sync (check every 5 seconds)
      function startLiveSync() {
        if (liveSyncInterval) clearInterval(liveSyncInterval);
        liveSyncInterval = setInterval(checkForServerUpdates, 5000);
        console.log("üî¥ Live sync started (checking every 5s)");
      }

      // Stop live sync
      function stopLiveSync() {
        if (liveSyncInterval) {
          clearInterval(liveSyncInterval);
          liveSyncInterval = null;
          console.log("‚èπÔ∏è Live sync stopped");
        }
      }

      // If user is logged in via JWT, load their data and show app
      if (currentUser && isJWTAuthenticated()) {
        console.log("üîê User authenticated:", currentUser);
        console.log("üîë Token exists:", !!getJWTToken());
        console.log("üåê API URL:", API_BASE_URL);

        // Check if this is a NEW device (no local cache)
        const localKey = `pwtm_tracker_data_${currentUser}`;
        const localData = localStorage.getItem(localKey);
        const isNewDevice = !localData;

        if (isNewDevice) {
          console.log("üì± NEW DEVICE detected - MUST load from server");
          // Show loading indicator
          document.body.insertAdjacentHTML(
            "afterbegin",
            '<div id="loadingOverlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.9);display:flex;align-items:center;justify-content:center;z-index:99999;flex-direction:column;"><div style="font-size:24px;">üîÑ</div><div style="margin-top:10px;font-size:16px;">Loading your data from server...</div></div>',
          );
        } else {
          // Load local cache as initial data (while waiting for server)
          try {
            const parsed = JSON.parse(localData);
            currentSheet = parsed.currentSheet || "Sheet 1";
            if (parsed.rowHistories) {
              rowHistories = parsed.rowHistories;
            }
            sheets = parsed.sheets || { "Sheet 1": [] };
            trackers = sheets[currentSheet] || [];
            runningTimers = parsed.runningTimers || {};
            singleTaskMode = parsed.singleTaskMode !== false;
            console.log("üì¶ Loaded local cache while waiting for server");
          } catch (e) {
            console.log("No local data found, starting fresh");
          }
        }

        // ALWAYS load from server (this is the source of truth)
        loadDataFromServer()
          .then((loaded) => {
            // Remove loading overlay if exists
            const overlay = document.getElementById("loadingOverlay");
            if (overlay) overlay.remove();

            if (loaded) {
              console.log(
                "‚úÖ Server data loaded successfully - sheets:",
                Object.keys(sheets),
              );
              console.log("‚úÖ Current sheet:", currentSheet);
              console.log("‚úÖ Trackers count:", trackers.length);
              render();
              drawCharts();

              // Start live sync after initial load
              startLiveSync();
            } else if (isNewDevice) {
              // Server failed but this is new device - show empty state
              console.log(
                "‚ö†Ô∏è Server unavailable, showing empty state for new device",
              );
              alert(
                "Could not load data from server. Please check your internet connection and try again.",
              );
              render();
              drawCharts();
            }
          })
          .catch((err) => {
            // Remove loading overlay on error
            const overlay = document.getElementById("loadingOverlay");
            if (overlay) overlay.remove();
            console.error("‚ùå Critical error loading data:", err);
            alert("Error loading data: " + err.message);
          });

        // Initialize UI immediately with cached/local data
        setTimeout(() => {
          // Update sheet header
          const sheetHeader = document.getElementById("sheetNameHeader");
          if (sheetHeader) sheetHeader.textContent = currentSheet;

          // Update mode button
          const modeBtn = document.getElementById("modeBtn");
          if (modeBtn) {
            if (!singleTaskMode) {
              modeBtn.textContent = "Multiple Tasks";
              modeBtn.className = "toggle-mode multi";
            } else {
              modeBtn.textContent = "Single Task";
              modeBtn.className = "toggle-mode single";
            }
          }

          render();
          drawCharts();
        }, 100);

        displayUserBadge();
      } else if (currentUser) {
        // Local auth fallback (legacy)
        const existing =
          typeof db !== "undefined" ? db.getUserData(currentUser) : null;
        if (existing) {
          loadUserData();
          displayUserBadge();
        } else {
          // Stored session key is stale; redirect to login
          if (typeof db !== "undefined") db.logout();
          currentUser = null;
          window.location.href = "login.html";
        }
      }

      window.addEventListener("beforeunload", (e) => {
        // Check if any task is currently running
        const runningCount = Object.keys(runningTimers).length;
        let message = "Your data is saved. Use delete to remove items.";
        if (runningCount > 0) {
          message = `You have ${runningCount} task(s) currently running! Leaving will stop tracking time for these tasks. Your data is saved.`;
        }
        e.preventDefault();
        e.returnValue = message;
      });

      function save() {
        sheets[currentSheet] = trackers;
        saveUserData();
      }

      function toggleMode() {
        singleTaskMode = !singleTaskMode;
        const btn = document.getElementById("modeBtn");
        if (singleTaskMode) {
          btn.textContent = "Single Task";
          btn.className = "toggle-mode single";
          btn.title =
            "Single Task Mode: ON (click to allow multiple tasks) - Toggle (Alt+3)";
        } else {
          btn.textContent = "Multiple Tasks";
          btn.className = "toggle-mode multi";
          btn.title =
            "Multiple Tasks Mode: ON (click to restrict to single task) - Toggle (Alt+3)";
        }
        save();
      }

      /* -------------------- TIME HELPERS -------------------- */
      function fmtTime(d) {
        return d.toLocaleTimeString("en-US", { hour12: true });
      }
      function fmtDate(d) {
        return d.toLocaleDateString("en-US");
      }
      function dur(ms) {
        let s = Math.floor(ms / 1000),
          m = Math.floor(s / 60),
          h = Math.floor(m / 60);
        return `${String(h).padStart(2, "0")}:${String(m % 60).padStart(2, "0")}:${String(s % 60).padStart(2, "0")}.${String(ms % 1000).padStart(3, "0")}`;
      }

      function parseDateOnly(dateStr) {
        if (!dateStr) return null;
        const iso = dateStr.match(/(\d{4})-(\d+)-(\d+)/);
        if (iso) {
          const year = parseInt(iso[1]);
          const month = parseInt(iso[2]) - 1;
          const day = parseInt(iso[3]);
          return new Date(year, month, day);
        }

        const slash = dateStr.match(/(\d+)\/(\d+)\/(\d+)/);
        if (slash) {
          const part1 = parseInt(slash[1]);
          const part2 = parseInt(slash[2]);
          const year = parseInt(slash[3]);
          let day;
          let month;

          if (part1 > 12) {
            day = part1;
            month = part2 - 1;
          } else if (part2 > 12) {
            month = part1 - 1;
            day = part2;
          } else {
            // Ambiguous - assume M/D/YYYY (US format) for consistency
            month = part1 - 1;
            day = part2;
          }

          return new Date(year, month, day);
        }

        const parsed = new Date(dateStr);
        return isNaN(parsed.getTime()) ? null : parsed;
      }

      /* -------------------- TRACKERS -------------------- */
      function addTracker() {
        const name = prompt("Work name");
        if (!name) return;
        trackers.push({ name, rows: [], total: 0 });
        save();
        render();
      }

      function start(i) {
        const timerKey = `${currentSheet}-${i}`;
        if (runningTimers[timerKey]) return;

        // Check if single task mode is enabled and another task is already running on CURRENT sheet
        if (singleTaskMode) {
          // Count how many tasks are running on the current sheet
          const currentSheetRunningTasks = Object.keys(runningTimers).filter(
            (key) => key.startsWith(currentSheet + "-"),
          );

          if (currentSheetRunningTasks.length > 0) {
            alert("Single Task Mode: Stop all tasks and kindly run one.");
            return;
          }
        }

        runningTimers[timerKey] = Date.now();
        // Create a new row immediately when start is clicked
        trackers[i].rows.push({
          sd: fmtDate(new Date(runningTimers[timerKey])),
          st: fmtTime(new Date(runningTimers[timerKey])),
          ed: "",
          et: "",
          dur: 0,
          running: true,
          rowIndex: trackers[i].rows.length,
        });
        save();
        render();
        updateTimer(i);
      }

      function updateTimer(i) {
        const timerKey = `${currentSheet}-${i}`;
        const trackerIndex = i;
        const sheetAtStart = currentSheet;
        const interval = setInterval(() => {
          if (!runningTimers[timerKey]) {
            clearInterval(interval);
            return;
          }
          // Only update if we're still on the same sheet and the tracker still exists
          if (currentSheet !== sheetAtStart) {
            return; // Don't update, we've switched sheets
          }
          if (!trackers[trackerIndex]) {
            clearInterval(interval);
            return;
          }
          // Update only the total time display and running time, not full render to prevent chart blink
          const running = runningTimers[timerKey];
          const elapsed = running ? Date.now() - running : 0;
          const t = trackers[trackerIndex];
          const total = t.total + elapsed;

          const totalEl = document.getElementById(`total-${trackerIndex}`);
          if (totalEl) {
            totalEl.textContent = `Total: ${dur(total)}`;
          }

          const runningTimeEl = document.getElementById(
            `running-time-${trackerIndex}`,
          );
          if (runningTimeEl) {
            runningTimeEl.textContent = dur(elapsed);
          }

          // Update the running row duration in real-time
          const lastRowIdx = trackers[trackerIndex].rows.length - 1;
          if (
            lastRowIdx >= 0 &&
            trackers[trackerIndex].rows[lastRowIdx].running
          ) {
            const rowElement = document.getElementById(
              `row-${trackerIndex}-${lastRowIdx}`,
            );
            if (rowElement) {
              const cells = rowElement.querySelectorAll("td");
              if (cells[4]) {
                cells[4].textContent = dur(elapsed);
              }
            }
          }
        }, 100);
      }

      function stop(i) {
        const timerKey = `${currentSheet}-${i}`;
        const start = runningTimers[timerKey];
        if (!start) return;
        const end = Date.now();
        const d = end - start;

        // Update the last running row with end time and duration
        const lastRowIdx = trackers[i].rows.length - 1;
        if (lastRowIdx >= 0 && trackers[i].rows[lastRowIdx].running) {
          trackers[i].rows[lastRowIdx].ed = fmtDate(new Date(end));
          trackers[i].rows[lastRowIdx].et = fmtTime(new Date(end));
          trackers[i].rows[lastRowIdx].dur = d;
          trackers[i].rows[lastRowIdx].running = false;
        }

        trackers[i].total += d;
        delete runningTimers[timerKey];
        save();
        render();
        drawCharts();
      }

      function del(i) {
        const timerKey = `${currentSheet}-${i}`;
        const isRunning = runningTimers[timerKey];

        if (isRunning) {
          alert(
            "Cannot delete a running task! Please stop the task first before deleting.",
          );
          return;
        }

        if (confirm("Delete tracker?")) {
          // Clear filter if the deleted task was the filtered one
          if (globalFilteredTaskIndex === i) {
            globalFilteredTaskIndex = null;
            updateFilterIndicator();
          } else if (
            globalFilteredTaskIndex !== null &&
            globalFilteredTaskIndex > i
          ) {
            // Adjust filter index if a task before it was deleted
            globalFilteredTaskIndex--;
            updateFilterIndicator();
          }

          trackers.splice(i, 1);

          // Update runningTimers keys for tasks that come after the deleted one
          // If a task at index j (where j > i) is running, move its timer from
          // ${currentSheet}-j to ${currentSheet}-(j-1)
          for (let j = i + 1; j < trackers.length + 1; j++) {
            const oldKey = `${currentSheet}-${j}`;
            const newKey = `${currentSheet}-${j - 1}`;
            if (runningTimers[oldKey]) {
              runningTimers[newKey] = runningTimers[oldKey];
              delete runningTimers[oldKey];
            }
          }

          save();
          render();
          drawCharts();
        }
      }

      function recalcTaskTotal(taskIdx) {
        const task = trackers[taskIdx];
        if (!task) return;
        const completed = task.rows
          .filter((r) => !r.running && typeof r.dur === "number")
          .reduce((sum, r) => sum + (isNaN(r.dur) ? 0 : r.dur), 0);
        task.total = completed;
      }

      function editTask(i) {
        const currentName = trackers[i].name;
        const newName = prompt("Edit task name:", currentName);
        if (newName && newName.trim() !== "" && newName !== currentName) {
          trackers[i].name = newName.trim();
          save();
          render();
          drawCharts();
        }
      }

      function editRowData(taskIdx, rowIdx, iconEl) {
        const row = trackers[taskIdx].rows[rowIdx];
        const tableRow = document.getElementById(`row-${taskIdx}-${rowIdx}`);

        function addPicker(cell, isDate) {
          if (cell.querySelector(".cell-picker")) return;
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "cell-picker";
          btn.textContent = isDate ? "üìÖ" : "‚è∞";
          btn.onclick = (e) => {
            e.stopPropagation();
            if (isDate) {
              openDatePickerPopup(cell, row, isDate);
            } else {
              openTimePickerPopup(cell, row, isDate);
            }
          };
          cell.appendChild(btn);
        }

        function clearPickers() {
          tableRow.querySelectorAll(".cell-picker").forEach((b) => b.remove());
        }

        // Check if already in edit mode
        if (tableRow.classList.contains("edit-mode")) {
          // Save the edits - get text content excluding picker buttons
          const newSd =
            tableRow.cells[0].childNodes[0]?.textContent?.trim() ||
            tableRow.cells[0].innerText.trim().replace(/üìÖ/g, "").trim();
          const newSt =
            tableRow.cells[1].childNodes[0]?.textContent?.trim() ||
            tableRow.cells[1].innerText.trim().replace(/‚è∞/g, "").trim();
          const newEd =
            tableRow.cells[2].childNodes[0]?.textContent?.trim() ||
            tableRow.cells[2].innerText.trim().replace(/üìÖ/g, "").trim();
          const newEt =
            tableRow.cells[3].childNodes[0]?.textContent?.trim() ||
            tableRow.cells[3].innerText.trim().replace(/‚è∞/g, "").trim();

          // Helper function to parse date in various formats (D/M/YYYY, M/D/YYYY, YYYY-MM-DD)
          function parseLocalDate(dateStr, timeStr) {
            // Try different date formats
            let day, month, year;

            // Try YYYY-MM-DD format first (ISO format)
            const isoParts = dateStr.match(/(\d{4})-(\d+)-(\d+)/);
            if (isoParts) {
              year = parseInt(isoParts[1]);
              month = parseInt(isoParts[2]) - 1;
              day = parseInt(isoParts[3]);
            } else {
              // Try D/M/YYYY or M/D/YYYY format
              const slashParts = dateStr.match(/(\d+)\/(\d+)\/(\d+)/);
              if (slashParts) {
                const part1 = parseInt(slashParts[1]);
                const part2 = parseInt(slashParts[2]);
                year = parseInt(slashParts[3]);

                // If first part > 12, it must be day (D/M/YYYY format)
                if (part1 > 12) {
                  day = part1;
                  month = part2 - 1; // JS months are 0-indexed
                } else if (part2 > 12) {
                  // If second part > 12, it must be day (M/D/YYYY format)
                  month = part1 - 1;
                  day = part2;
                } else {
                  // Ambiguous - assume M/D/YYYY (US format) since that's what toLocaleDateString('en-US') produces
                  month = part1 - 1;
                  day = part2;
                }
              }
            }

            if (
              day === undefined ||
              month === undefined ||
              year === undefined
            ) {
              console.error("Failed to parse date:", dateStr);
              return new Date(NaN); // Invalid
            }

            // Parse time - handle "H:MM:SS AM/PM" format
            let hours = 0,
              minutes = 0,
              seconds = 0;
            const timeParts = timeStr.match(/(\d+):(\d+):(\d+)\s*(AM|PM)?/i);
            if (timeParts) {
              hours = parseInt(timeParts[1]);
              minutes = parseInt(timeParts[2]);
              seconds = parseInt(timeParts[3]);
              const ampm = timeParts[4];
              if (ampm) {
                if (ampm.toUpperCase() === "PM" && hours !== 12) hours += 12;
                if (ampm.toUpperCase() === "AM" && hours === 12) hours = 0;
              }
            } else {
              // Try simpler HH:MM format
              const simpleTime = timeStr.match(/(\d+):(\d+)/);
              if (simpleTime) {
                hours = parseInt(simpleTime[1]);
                minutes = parseInt(simpleTime[2]);
              } else {
                console.error("Failed to parse time:", timeStr);
                return new Date(NaN);
              }
            }

            const result = new Date(year, month, day, hours, minutes, seconds);
            console.log(`Parsed: "${dateStr} ${timeStr}" => ${result}`);
            return result;
          }

          // Validate timestamps using proper parsing
          console.log("Parsing values:", { newSd, newSt, newEd, newEt });
          const startTime = parseLocalDate(newSd, newSt);
          const endTime = parseLocalDate(newEd, newEt);
          const now = new Date();

          console.log("Parsed times:", {
            startTime: startTime.toString(),
            endTime: endTime.toString(),
            now: now.toString(),
            startValid: !isNaN(startTime.getTime()),
            endValid: !isNaN(endTime.getTime()),
            startInFuture: startTime > now,
            endInFuture: endTime > now,
            endBeforeStart: endTime < startTime,
          });

          if (isNaN(startTime.getTime()) || isNaN(endTime.getTime())) {
            alert(
              "Invalid date/time format. Please use the picker to select dates and times.",
            );
            return;
          }

          if (endTime.getTime() < startTime.getTime()) {
            alert("End time must be after start time.");
            return;
          }

          // Allow times up to end of current day (not strict now check)
          const endOfToday = new Date(
            now.getFullYear(),
            now.getMonth(),
            now.getDate(),
            23,
            59,
            59,
            999,
          );
          if (startTime > endOfToday || endTime > endOfToday) {
            alert("Dates cannot be in the future.");
            return;
          }

          // Store old values for history
          const oldRow = {
            sd: row.sd,
            st: row.st,
            ed: row.ed,
            et: row.et,
          };

          row.sd = newSd;
          row.st = newSt;
          row.ed = newEd;
          row.et = newEt;
          row.dur = endTime - startTime;

          // Record the edit in history
          recordRowEdit(taskIdx, rowIdx, oldRow, row, "");

          tableRow.classList.remove("edit-mode");
          tableRow.cells[0].classList.remove("editing");
          tableRow.cells[1].classList.remove("editing");
          tableRow.cells[2].classList.remove("editing");
          tableRow.cells[3].classList.remove("editing");
          tableRow.cells[0].contentEditable = false;
          tableRow.cells[1].contentEditable = false;
          tableRow.cells[2].contentEditable = false;
          tableRow.cells[3].contentEditable = false;
          clearPickers();
          if (iconEl) iconEl.textContent = "‚úèÔ∏è";
          recalcTaskTotal(taskIdx);
          save();
          render();
          drawCharts();
        } else {
          // Enter edit mode
          tableRow.classList.add("edit-mode");
          tableRow.cells[0].classList.add("editing");
          tableRow.cells[1].classList.add("editing");
          tableRow.cells[2].classList.add("editing");
          tableRow.cells[3].classList.add("editing");
          // Don't allow manual typing - only picker selection
          tableRow.cells[0].contentEditable = false;
          tableRow.cells[1].contentEditable = false;
          tableRow.cells[2].contentEditable = false;
          tableRow.cells[3].contentEditable = false;
          addPicker(tableRow.cells[0], true);
          addPicker(tableRow.cells[1], false);
          addPicker(tableRow.cells[2], true);
          addPicker(tableRow.cells[3], false);
          if (iconEl) iconEl.textContent = "‚úîÔ∏è";
        }
      }

      function deleteRow(taskIdx, rowIdx) {
        if (confirm("Delete this row?")) {
          trackers[taskIdx].rows.splice(rowIdx, 1);
          recalcTaskTotal(taskIdx);
          save();
          render();
          drawCharts();
        }
      }

      function recordRowEdit(taskIdx, rowIdx, oldRow, newRow, comment = "") {
        const key = `${taskIdx}-${rowIdx}`;
        if (!rowHistories[key]) {
          rowHistories[key] = [];
        }

        const edit = {
          timestamp: new Date().toISOString(),
          oldStartDate: oldRow.sd,
          newStartDate: newRow.sd,
          oldEndDate: oldRow.ed,
          newEndDate: newRow.ed,
          oldStartTime: oldRow.st,
          newStartTime: newRow.st,
          oldEndTime: oldRow.et,
          newEndTime: newRow.et,
          comment: comment,
        };

        rowHistories[key].push(edit);

        // Save history to localStorage immediately
        saveRowHistories();
      }

      function showRowHistory(taskIdx, rowIdx) {
        const key = `${taskIdx}-${rowIdx}`;
        const history = rowHistories[key] || [];
        const modal = document.getElementById("historyModal");

        let historyHTML = `
          <div class="history-modal-header">
            <h2>üìã Row Edit History</h2>
            <button class="history-modal-close" onclick="closeHistoryModal()">‚úï</button>
          </div>
        `;

        if (history.length === 0) {
          historyHTML += `<p style="text-align: center; color: var(--muted); padding: 20px;">No edit history for this row yet.</p>`;
        } else {
          historyHTML += `
            <table class="history-table">
              <thead>
                <tr>
                  <th style="width: 5%;">S.No</th>
                  <th style="width: 19%;">Start Date</th>
                  <th style="width: 19%;">End Date</th>
                  <th style="width: 19%;">Start Time</th>
                  <th style="width: 19%;">End Time</th>
                  <th style="width: 19%;">Comment</th>
                </tr>
              </thead>
              <tbody>
          `;

          history.forEach((edit, index) => {
            const startDateChange =
              edit.oldStartDate !== edit.newStartDate
                ? `<div class="history-change"><span class="history-old">${edit.oldStartDate}</span><span class="history-arrow">‚Üí</span><span class="history-new">${edit.newStartDate}</span></div>`
                : `<div>${edit.newStartDate}</div>`;

            const endDateChange =
              edit.oldEndDate !== edit.newEndDate
                ? `<div class="history-change"><span class="history-old">${edit.oldEndDate}</span><span class="history-arrow">‚Üí</span><span class="history-new">${edit.newEndDate}</span></div>`
                : `<div>${edit.newEndDate}</div>`;

            const startTimeChange =
              edit.oldStartTime !== edit.newStartTime
                ? `<div class="history-change"><span class="history-old">${edit.oldStartTime}</span><span class="history-arrow">‚Üí</span><span class="history-new">${edit.newStartTime}</span></div>`
                : `<div>${edit.newStartTime}</div>`;

            const endTimeChange =
              edit.oldEndTime !== edit.newEndTime
                ? `<div class="history-change"><span class="history-old">${edit.oldEndTime}</span><span class="history-arrow">‚Üí</span><span class="history-new">${edit.newEndTime}</span></div>`
                : `<div>${edit.newEndTime}</div>`;

            historyHTML += `
              <tr>
                <td>${index + 1}</td>
                <td>${startDateChange}</td>
                <td>${endDateChange}</td>
                <td>${startTimeChange}</td>
                <td>${endTimeChange}</td>
                <td><small>${edit.comment || "‚Äî"}</small></td>
              </tr>
            `;
          });

          historyHTML += `</tbody></table>`;
        }

        historyHTML += `
          <div class="comment-input-wrapper">
            <label for="editComment">Add Comment (Optional):</label>
            <textarea id="editComment" placeholder="Describe why this change was made..."></textarea>
          </div>
          <div class="history-modal-footer">
            <button class="btn-close" onclick="closeHistoryModal()">Close</button>
            <button class="btn-save" onclick="saveHistoryComment(${taskIdx}, ${rowIdx})">Save Comment</button>
          </div>
        `;

        const modalContent = modal.querySelector(".history-modal-content");
        modalContent.innerHTML = historyHTML;
        modal.classList.add("active");
      }

      function closeHistoryModal() {
        const modal = document.getElementById("historyModal");
        modal.classList.remove("active");
      }

      // Close modal when clicking outside
      document.addEventListener("click", function (event) {
        const modal = document.getElementById("historyModal");
        if (event.target === modal) {
          closeHistoryModal();
        }
      });

      function saveHistoryComment(taskIdx, rowIdx) {
        const key = `${taskIdx}-${rowIdx}`;
        const commentText = document.getElementById("editComment").value;

        if (commentText.trim()) {
          if (!rowHistories[key]) {
            rowHistories[key] = [];
          }

          // Update the most recent entry with the comment instead of creating a new row
          if (rowHistories[key].length > 0) {
            // Add comment to the last entry
            rowHistories[key][rowHistories[key].length - 1].comment =
              commentText;
          } else {
            // If no history yet, create a new comment-only entry
            rowHistories[key].push({
              timestamp: new Date().toISOString(),
              isCommentOnly: true,
              comment: commentText,
            });
          }
        }

        // Save history to localStorage
        saveRowHistories();

        // Refresh the modal to show the updated comment
        showRowHistory(taskIdx, rowIdx);
        showNotification("Comment saved!", "success");
      }

      function showNotification(message, type = "info") {
        const notif = document.createElement("div");
        notif.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: ${type === "success" ? "var(--success)" : "var(--primary)"};
          color: white;
          padding: 12px 20px;
          border-radius: 6px;
          z-index: 2000;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        `;
        notif.textContent = message;
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 3000);
      }

      /* -------------------- DOWNLOAD -------------------- */
      function escapeCsvValue(value) {
        const str = value === null || value === undefined ? "" : String(value);
        return /[",\n]/.test(str) ? `"${str.replace(/"/g, '""')}"` : str;
      }

      function parseCsvText(text) {
        const rows = [];
        let row = [];
        let current = "";
        let inQuotes = false;

        for (let i = 0; i < text.length; i++) {
          const char = text[i];
          const next = text[i + 1];

          if (char === '"') {
            if (inQuotes && next === '"') {
              current += '"';
              i++;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (char === "," && !inQuotes) {
            row.push(current);
            current = "";
          } else if ((char === "\n" || char === "\r") && !inQuotes) {
            if (char === "\r" && next === "\n") {
              i++;
            }
            row.push(current);
            current = "";
            if (row.length > 1 || row.some((cell) => cell.trim() !== "")) {
              rows.push(row);
            }
            row = [];
          } else {
            current += char;
          }
        }

        if (current.length > 0 || row.length > 0) {
          row.push(current);
          if (row.length > 1 || row.some((cell) => cell.trim() !== "")) {
            rows.push(row);
          }
        }

        return rows;
      }

      function parseDateTime(dateStr, timeStr) {
        if (!dateStr || !timeStr) return null;
        const baseDate = parseDateOnly(dateStr);
        if (!baseDate) return null;

        const timeMatch = timeStr
          .trim()
          .match(/(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?/i);
        if (!timeMatch) return null;

        let hours = parseInt(timeMatch[1], 10);
        const minutes = parseInt(timeMatch[2], 10);
        const seconds = parseInt(timeMatch[3] || "0", 10);
        const meridiem = timeMatch[4] ? timeMatch[4].toUpperCase() : null;

        if (meridiem) {
          if (meridiem === "PM" && hours < 12) hours += 12;
          if (meridiem === "AM" && hours === 12) hours = 0;
        }

        const combined = new Date(baseDate);
        combined.setHours(hours, minutes, seconds, 0);
        return isNaN(combined.getTime()) ? null : combined;
      }

      function importAllSheetsCsv() {
        const input = document.getElementById("csvImportInput");
        if (!input) return;
        input.value = "";
        input.click();
      }

      function handleCsvImport(event) {
        const file = event.target.files && event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = () => {
          const text = reader.result || "";
          const rows = parseCsvText(String(text));
          if (!rows.length) {
            alert("CSV is empty.");
            return;
          }

          const header = rows[0].map((h) => h.trim());
          const expected = [
            "Sheets Name",
            "Tasks Name",
            "Start Date",
            "Start Time",
            "End Date",
            "End Time",
          ];

          const isValidHeader = expected.every(
            (name, idx) => header[idx] === name,
          );

          if (!isValidHeader) {
            alert(
              "Invalid CSV format. Expected headers: Sheets Name, Tasks Name, Start Date, Start Time, End Date, End Time.",
            );
            return;
          }

          const importMap = {};
          rows.slice(1).forEach((row) => {
            const sheetName = (row[0] || "").trim();
            const taskName = (row[1] || "").trim();
            const sd = (row[2] || "").trim();
            const st = (row[3] || "").trim();
            const ed = (row[4] || "").trim();
            const et = (row[5] || "").trim();

            if (!sheetName || !taskName) return;

            const start = parseDateTime(sd, st);
            const end = parseDateTime(ed, et);
            const durMs = start && end && end > start ? end - start : 0;

            if (!importMap[sheetName]) importMap[sheetName] = {};
            if (!importMap[sheetName][taskName]) {
              importMap[sheetName][taskName] = [];
            }

            importMap[sheetName][taskName].push({
              sd,
              st,
              ed,
              et,
              dur: durMs,
              running: false,
            });
          });

          const sheetNames = Object.keys(importMap);
          if (!sheetNames.length) {
            alert("No valid rows found in the CSV.");
            return;
          }

          sheetNames.forEach((sheetName) => {
            if (!sheets[sheetName]) {
              sheets[sheetName] = [];
            }

            const sheetTasks = sheets[sheetName];
            const tasksInSheet = importMap[sheetName];

            Object.keys(tasksInSheet).forEach((taskName) => {
              const newRows = tasksInSheet[taskName].map((row, index) => ({
                ...row,
                rowIndex: index,
              }));
              const total = newRows.reduce(
                (sum, row) => sum + (row.dur || 0),
                0,
              );
              const existingIndex = sheetTasks.findIndex(
                (task) => task.name === taskName,
              );

              if (existingIndex >= 0) {
                sheetTasks[existingIndex].rows = newRows;
                sheetTasks[existingIndex].total = total;
              } else {
                sheetTasks.push({ name: taskName, rows: newRows, total });
              }
            });
          });

          trackers = sheets[currentSheet] || [];
          saveUserData();
          render();
          drawCharts();
          alert("CSV import completed.");
        };
        reader.readAsText(file);
      }

      function exportAllSheetsCsv() {
        if (!confirm("Export all sheets to CSV?")) {
          return;
        }

        let csv =
          "Sheets Name,Tasks Name,Start Date,Start Time,End Date,End Time\n";

        Object.keys(sheets || {}).forEach((sheetName) => {
          const sheetTasks = sheets[sheetName] || [];
          sheetTasks.forEach((task) => {
            const taskName = task && task.name ? task.name : "";
            const rows = (task && task.rows) || [];

            rows.forEach((row) => {
              csv +=
                `${escapeCsvValue(sheetName)},` +
                `${escapeCsvValue(taskName)},` +
                `${escapeCsvValue(row.sd)},` +
                `${escapeCsvValue(row.st)},` +
                `${escapeCsvValue(row.ed)},` +
                `${escapeCsvValue(row.et)}\n`;
            });
          });
        });

        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([csv]));
        a.download = "All_Sheets_Tasks.csv";
        a.click();
      }

      function downloadAll() {
        let csv =
          "Work,Start Date,Start Time,End Date,End Time,Duration(Minutes)\n";
        trackers.forEach((t) =>
          t.rows.forEach((r) => {
            const minutes = (r.dur / 60000).toFixed(2);
            csv += `${t.name},${r.sd},${r.st},${r.ed},${r.et},${minutes}\n`;
          }),
        );
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([csv]));
        a.download = "All_Tasks.csv";
        a.click();
      }

      function downloadTask(i) {
        const t = trackers[i];
        let csv = "Start Date,Start Time,End Date,End Time,Duration(Minutes)\n";
        t.rows.forEach((r) => {
          const minutes = (r.dur / 60000).toFixed(2);
          csv += `${r.sd},${r.st},${r.ed},${r.et},${minutes}\n`;
        });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([csv]));
        a.download = `${t.name}.csv`;
        a.click();
      }

      /* -------------------- ANALYTICS -------------------- */
      let analyticsCharts = { line: null, day: null, weekday: null, pie: null };
      let currentAnalyticsTaskIndex = null;

      function openAnalytics(taskIndex) {
        currentAnalyticsTaskIndex = taskIndex;
        const task = trackers[taskIndex];
        document.getElementById("analyticsTaskName").textContent =
          `üìä ${task.name} - Analytics`;
        document.getElementById("analyticsModal").classList.add("active");

        // Initialize first tab
        setTimeout(() => {
          switchAnalyticsTab("overview");
        }, 100);
      }

      function closeAnalytics() {
        document.getElementById("analyticsModal").classList.remove("active");
        // Destroy charts
        if (analyticsCharts.line) analyticsCharts.line.destroy();
        if (analyticsCharts.day) analyticsCharts.day.destroy();
        if (analyticsCharts.weekday) analyticsCharts.weekday.destroy();
        if (analyticsCharts.pie) analyticsCharts.pie.destroy();
      }

      function switchAnalyticsTab(tabName) {
        // Hide all tabs
        document.querySelectorAll(".analytics-tab-content").forEach((el) => {
          el.classList.remove("active");
        });
        document.querySelectorAll(".analytics-tab").forEach((el) => {
          el.classList.remove("active");
        });

        // Show selected tab
        document.getElementById(`tab-${tabName}`).classList.add("active");
        event.target.classList.add("active");

        // Generate analytics data
        if (currentAnalyticsTaskIndex !== null) {
          const task = trackers[currentAnalyticsTaskIndex];

          if (tabName === "overview") {
            generateOverviewAnalytics(task);
          } else if (tabName === "byday") {
            generateByDayAnalytics(task);
          } else if (tabName === "bydays") {
            generateByDaysAnalytics(task);
          } else if (tabName === "distribution") {
            generateDistributionAnalytics(task);
          } else if (tabName === "sessions") {
            generateSessionsAnalytics(task);
          }
        }
      }

      function generateOverviewAnalytics(task) {
        // Calculate stats
        const totalMs = task.rows.reduce((sum, r) => sum + r.dur, 0);
        const totalHours = (totalMs / 3600000).toFixed(1);
        const sessions = task.rows.length;
        const avgMs = sessions > 0 ? totalMs / sessions : 0;
        const avgMinutes = (avgMs / 60000).toFixed(0);
        const longest =
          sessions > 0 ? Math.max(...task.rows.map((r) => r.dur)) : 0;
        const longestMinutes = (longest / 60000).toFixed(0);

        document.getElementById("stat-total").textContent = `${totalHours}h`;
        document.getElementById("stat-sessions").textContent = sessions;
        document.getElementById("stat-average").textContent = `${avgMinutes}m`;
        document.getElementById("stat-longest").textContent =
          `${longestMinutes}m`;

        // Line chart - sessions over time
        if (analyticsCharts.line) analyticsCharts.line.destroy();

        const ctx = document.getElementById("analyticsLineChart");
        analyticsCharts.line = new Chart(ctx, {
          type: "line",
          data: {
            labels: task.rows.map((r, idx) => `Session ${idx + 1}`),
            datasets: [
              {
                label: "Duration (minutes)",
                data: task.rows.map((r) => (r.dur / 60000).toFixed(1)),
                borderColor: "#4f46e5",
                backgroundColor: "rgba(79, 70, 229, 0.1)",
                borderWidth: 2,
                tension: 0.3,
                pointRadius: 5,
                pointBackgroundColor: "#4f46e5",
                pointBorderColor: "#fff",
                pointBorderWidth: 2,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: true, position: "top" },
            },
            scales: {
              y: { beginAtZero: true, ticks: { callback: (v) => v + "m" } },
            },
          },
        });
      }

      function generateByDayAnalytics(task) {
        // Group sessions by date
        const dayMap = {};
        task.rows.forEach((r) => {
          if (!dayMap[r.sd]) dayMap[r.sd] = 0;
          dayMap[r.sd] += r.dur;
        });

        const days = Object.keys(dayMap).sort();
        const durations = days.map((d) => (dayMap[d] / 3600000).toFixed(2));

        if (analyticsCharts.day) analyticsCharts.day.destroy();

        const ctx = document.getElementById("analyticsDayChart");
        analyticsCharts.day = new Chart(ctx, {
          type: "bar",
          data: {
            labels: days,
            datasets: [
              {
                label: "Hours Tracked",
                data: durations,
                backgroundColor: "#10b981",
                borderColor: "#059669",
                borderWidth: 1,
                borderRadius: 6,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: true },
            },
            scales: {
              y: { beginAtZero: true, ticks: { callback: (v) => v + "h" } },
            },
          },
        });
      }

      function generateByDaysAnalytics(task) {
        const weekdayLabels = [
          "Monday",
          "Tuesday",
          "Wednesday",
          "Thursday",
          "Friday",
          "Saturday",
          "Sunday",
        ];
        const weekdayTotals = new Array(7).fill(0);

        task.rows.forEach((r) => {
          const d = parseDateOnly(r.sd);
          if (!d) return;
          const dayIndex = (d.getDay() + 6) % 7;
          weekdayTotals[dayIndex] += r.dur || 0;
        });

        const hours = weekdayTotals.map((total) =>
          (total / 3600000).toFixed(2),
        );

        if (analyticsCharts.weekday) analyticsCharts.weekday.destroy();

        const ctx = document.getElementById("analyticsWeekdayChart");
        analyticsCharts.weekday = new Chart(ctx, {
          type: "bar",
          data: {
            labels: weekdayLabels,
            datasets: [
              {
                label: "Hours Tracked",
                data: hours,
                backgroundColor: "#3b82f6",
                borderColor: "#2563eb",
                borderWidth: 1,
                borderRadius: 6,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: true },
            },
            scales: {
              y: { beginAtZero: true, ticks: { callback: (v) => v + "h" } },
            },
          },
        });
      }

      function generateDistributionAnalytics(task) {
        // Sessions grouped by duration ranges
        const ranges = {
          "0-15 min": 0,
          "15-30 min": 0,
          "30-60 min": 0,
          "1-2 hours": 0,
          "2+ hours": 0,
        };

        task.rows.forEach((r) => {
          const minutes = r.dur / 60000;
          if (minutes <= 15) ranges["0-15 min"]++;
          else if (minutes <= 30) ranges["15-30 min"]++;
          else if (minutes <= 60) ranges["30-60 min"]++;
          else if (minutes <= 120) ranges["1-2 hours"]++;
          else ranges["2+ hours"]++;
        });

        const labels = Object.keys(ranges);
        const data = Object.values(ranges);
        const colors = ["#4f46e5", "#10b981", "#f59e0b", "#8b5cf6", "#ef4444"];

        if (analyticsCharts.pie) analyticsCharts.pie.destroy();

        const ctx = document.getElementById("analyticsPieChart");
        analyticsCharts.pie = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: labels,
            datasets: [
              {
                data: data,
                backgroundColor: colors,
                borderColor: "#fff",
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: "bottom" },
            },
          },
        });
      }

      function generateSessionsAnalytics(task) {
        const tbody = document.getElementById("sessionsTable");
        tbody.innerHTML = "";

        if (task.rows.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--muted);">No sessions recorded</td></tr>';
          return;
        }

        const totalTime = task.rows.reduce((sum, r) => sum + (r.dur || 0), 0);
        const ranked = task.rows
          .map((r, idx) => ({ idx, dur: r.dur || 0 }))
          .sort((a, b) => b.dur - a.dur)
          .map((item, rank) => ({ ...item, rank: rank + 1 }));
        const rankMap = ranked.reduce((acc, item) => {
          acc[item.idx] = item.rank;
          return acc;
        }, {});

        task.rows.forEach((r, idx) => {
          const row = document.createElement("tr");
          const minutes = (r.dur / 60000).toFixed(2);
          const pct = totalTime > 0 ? ((r.dur || 0) / totalTime) * 100 : 0;
          row.innerHTML = `
            <td style="padding: 12px; border-bottom: 1px solid var(--border);">${r.sd}</td>
            <td style="padding: 12px; border-bottom: 1px solid var(--border);">${r.st}</td>
            <td style="padding: 12px; border-bottom: 1px solid var(--border);">${r.et || "-"}</td>
            <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: right; color: var(--success); font-weight: 600;">${minutes}m</td>
            <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: right;">${rankMap[idx] || "-"}</td>
            <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: right;">${pct.toFixed(1)}%</td>
          `;
          tbody.appendChild(row);
        });
      }

      /* -------------------- ANALYTICS DETAIL MODAL -------------------- */
      let analyticsDetailChart = null;

      function openAnalyticsDetail(chartKey, title) {
        if (!trackers || trackers.length === 0) {
          alert("No data available for analytics.");
          return;
        }

        const modal = document.getElementById("analyticsDetailModal");
        const titleEl = document.getElementById("analyticsDetailTitle");
        titleEl.textContent = title;
        modal.classList.add("active");

        buildAnalyticsDayTable(chartKey);
        buildAnalyticsDetailTable();
        buildAnalyticsDetailDescription(chartKey);
        buildAnalyticsDetailChart(chartKey);
      }

      function closeAnalyticsDetail() {
        const modal = document.getElementById("analyticsDetailModal");
        modal.classList.remove("active");
        if (analyticsDetailChart) {
          analyticsDetailChart.destroy();
          analyticsDetailChart = null;
        }
      }

      function buildAnalyticsDetailTable() {
        const tbody = document.getElementById("analyticsDetailTableBody");
        tbody.innerHTML = "";
        const totalTime = trackers.reduce((sum, t) => sum + (t.total || 0), 0);

        const stats = trackers
          .map((t) => {
            const durations = t.rows
              .map((r) => r.dur || 0)
              .sort((a, b) => a - b);
            const min = durations.length ? durations[0] : 0;
            const max = durations.length ? durations[durations.length - 1] : 0;
            return {
              name: t.name,
              total: t.total || 0,
              count: t.rows.length,
              min,
              max,
            };
          })
          .sort((a, b) => b.total - a.total);

        stats.forEach((item, idx) => {
          const pct = totalTime > 0 ? (item.total / totalTime) * 100 : 0;
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${item.name}</td>
            <td>${dur(item.total)}</td>
            <td>${item.count}</td>
            <td>${item.min ? dur(item.min) : "0"}</td>
            <td>${item.max ? dur(item.max) : "0"}</td>
            <td>${idx + 1}</td>
            <td>${pct.toFixed(1)}%</td>
          `;
          tbody.appendChild(row);
        });

        if (stats.length === 0) {
          const row = document.createElement("tr");
          row.innerHTML =
            '<td colspan="7" style="padding: 16px; color: var(--muted);">No task data available.</td>';
          tbody.appendChild(row);
        }
      }

      function buildAnalyticsDayTable(chartKey) {
        const section = document.getElementById("analyticsDayTableSection");
        const tbody = document.getElementById("analyticsDayTableBody");
        if (!section || !tbody) return;

        if (chartKey !== "stacked") {
          section.style.display = "none";
          tbody.innerHTML = "";
          return;
        }

        section.style.display = "block";
        tbody.innerHTML = "";

        const dayLabels = [
          "Monday",
          "Tuesday",
          "Wednesday",
          "Thursday",
          "Friday",
          "Saturday",
          "Sunday",
        ];

        const dayTotals = new Array(7).fill(0);
        const dayCounts = new Array(7).fill(0);

        trackers.forEach((t) => {
          t.rows.forEach((r) => {
            const d = parseDateOnly(r.sd);
            if (!d) return;
            const dayIndex = (d.getDay() + 6) % 7;
            dayTotals[dayIndex] += r.dur || 0;
            dayCounts[dayIndex] += 1;
          });
        });

        const weekTotal = dayTotals.reduce((sum, v) => sum + v, 0);

        const ranked = dayTotals
          .map((total, idx) => ({ idx, total }))
          .sort((a, b) => b.total - a.total)
          .map((item, rank) => ({ ...item, rank: rank + 1 }));

        const rankMap = ranked.reduce((acc, item) => {
          acc[item.idx] = item.rank;
          return acc;
        }, {});

        dayLabels.forEach((label, idx) => {
          const pct = weekTotal > 0 ? (dayTotals[idx] / weekTotal) * 100 : 0;
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${label}</td>
            <td>${dayTotals[idx] ? dur(dayTotals[idx]) : "0"}</td>
            <td>${dayCounts[idx]}</td>
            <td>${rankMap[idx]}</td>
            <td>${pct.toFixed(1)}%</td>
          `;
          tbody.appendChild(row);
        });

        if (weekTotal === 0) {
          const row = document.createElement("tr");
          row.innerHTML =
            '<td colspan="5" style="padding: 16px; color: var(--muted);">No day data available.</td>';
          tbody.appendChild(row);
        }
      }

      function buildAnalyticsDetailDescription(chartKey) {
        const description = document.getElementById(
          "analyticsDetailDescription",
        );
        const descriptions = {
          bar: "This chart compares total duration (hours) and session count for each task. Use it to spot which tasks take the most time and which ones happen most often.",
          pie: "This chart shows the percentage share of total time by task. Use it to understand workload distribution and identify tasks that dominate your time.",
          line: "This chart tracks time trend progression across tasks. Use it to compare cumulative growth and individual task duration patterns.",
          doughnut:
            "This chart shows average session duration by task. Use it to see efficiency per session and compare consistency across tasks.",
          stacked:
            "This chart breaks down hours by day and task. Use it to find your most productive days and how tasks are distributed across the week.",
        };

        description.textContent =
          descriptions[chartKey] ||
          "This chart provides a detailed view of your task analytics.";
      }

      function buildAnalyticsDetailChart(chartKey) {
        const chartCanvas = document.getElementById("analyticsDetailChart");
        if (!chartCanvas) return;

        const labels = trackers.map((t) => t.name);
        const durationData = trackers.map((t) =>
          (t.total / 3600000).toFixed(2),
        );
        const countData = trackers.map((t) => t.rows.length);
        const total = trackers.reduce((a, t) => a + t.total, 0) || 1;
        const colors = [
          "#4f46e5",
          "#10b981",
          "#ef4444",
          "#f59e0b",
          "#3b82f6",
          "#8b5cf6",
          "#ec4899",
        ];

        if (analyticsDetailChart) {
          analyticsDetailChart.destroy();
          analyticsDetailChart = null;
        }

        if (labels.length === 0) return;

        if (chartKey === "bar") {
          analyticsDetailChart = new Chart(chartCanvas, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "Duration (Hours)",
                  data: durationData,
                  backgroundColor: colors.slice(0, labels.length),
                  borderColor: colors.slice(0, labels.length),
                  borderWidth: 1,
                  borderRadius: 12,
                  borderSkipped: false,
                  yAxisID: "y",
                  type: "bar",
                  order: 2,
                },
                {
                  label: "Count (Sessions)",
                  data: countData,
                  borderColor: "#ef4444",
                  backgroundColor: "rgba(239, 68, 68, 0.2)",
                  borderWidth: 3,
                  yAxisID: "y1",
                  type: "line",
                  tension: 0.3,
                  pointRadius: 6,
                  pointBorderColor: "#fff",
                  pointBorderWidth: 2,
                  pointBackgroundColor: "#ef4444",
                  order: 1,
                  fill: false,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                mode: "index",
                intersect: false,
              },
              scales: {
                y: {
                  type: "linear",
                  display: true,
                  position: "left",
                  title: {
                    display: true,
                    text: "Duration (Hours)",
                  },
                },
                y1: {
                  type: "linear",
                  display: true,
                  position: "right",
                  title: {
                    display: true,
                    text: "Count (Sessions)",
                  },
                  grid: {
                    drawOnChartArea: false,
                  },
                },
              },
              plugins: {
                legend: {
                  display: true,
                  position: "top",
                },
              },
            },
          });
          return;
        }

        if (chartKey === "pie") {
          analyticsDetailChart = new Chart(chartCanvas, {
            type: "pie",
            data: {
              labels: labels.map((label, idx) => {
                const pct = ((trackers[idx].total / total) * 100).toFixed(1);
                return `${label} (${pct}%)`;
              }),
              datasets: [
                {
                  data: trackers.map((t) => t.total),
                  backgroundColor: colors.slice(0, labels.length),
                  borderColor: "#fff",
                  borderWidth: 2,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "right",
                },
              },
            },
          });
          return;
        }

        if (chartKey === "line") {
          const cumulativeData = trackers.map((t, idx) => {
            return (
              trackers
                .slice(0, idx + 1)
                .reduce((sum, tracker) => sum + tracker.total, 0) / 3600000
            );
          });

          analyticsDetailChart = new Chart(chartCanvas, {
            type: "line",
            data: {
              labels,
              datasets: [
                {
                  label: "Cumulative Time (Hours)",
                  data: cumulativeData,
                  borderColor: "#8b5cf6",
                  backgroundColor: "rgba(139, 92, 246, 0.1)",
                  borderWidth: 3,
                  tension: 0.4,
                  fill: true,
                  pointRadius: 5,
                  pointBackgroundColor: "#8b5cf6",
                  pointBorderColor: "#fff",
                  pointBorderWidth: 2,
                },
                {
                  label: "Individual Task Time (Hours)",
                  data: durationData,
                  borderColor: "#10b981",
                  backgroundColor: "rgba(16, 185, 129, 0.1)",
                  borderWidth: 2,
                  tension: 0.4,
                  fill: false,
                  pointRadius: 4,
                  pointBackgroundColor: "#10b981",
                  pointBorderColor: "#fff",
                  pointBorderWidth: 2,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                mode: "index",
                intersect: false,
              },
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: "Time (Hours)",
                  },
                },
              },
              plugins: {
                legend: {
                  display: true,
                  position: "top",
                },
              },
            },
          });
          return;
        }

        if (chartKey === "doughnut") {
          const avgSessionDuration = trackers.map((t) => {
            if (t.rows.length === 0) return 0;
            return t.total / t.rows.length / 60000;
          });

          analyticsDetailChart = new Chart(chartCanvas, {
            type: "doughnut",
            data: {
              labels: labels.map((label, idx) => {
                return `${label} (${avgSessionDuration[idx].toFixed(0)} min/session)`;
              }),
              datasets: [
                {
                  label: "Average Session Duration (Minutes)",
                  data: avgSessionDuration,
                  backgroundColor: colors.slice(0, labels.length),
                  borderColor: "#fff",
                  borderWidth: 3,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "bottom",
                },
              },
            },
          });
          return;
        }

        if (chartKey === "stacked") {
          const dayLabels = [
            "Monday",
            "Tuesday",
            "Wednesday",
            "Thursday",
            "Friday",
            "Saturday",
            "Sunday",
          ];
          const dayDatasets = trackers.map((t, idx) => {
            const data = new Array(7).fill(0);
            t.rows.forEach((r) => {
              const d = parseDateOnly(r.sd);
              if (!d) return;
              const dayIndex = (d.getDay() + 6) % 7;
              const hours = (r.dur || 0) / 3600000;
              data[dayIndex] += hours;
            });
            return {
              label: t.name,
              data,
              backgroundColor: colors[idx % colors.length],
              borderColor: colors[idx % colors.length],
              borderWidth: 1,
              borderRadius: 6,
            };
          });

          analyticsDetailChart = new Chart(chartCanvas, {
            type: "bar",
            data: {
              labels: dayLabels,
              datasets: dayDatasets,
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "bottom",
                },
              },
              scales: {
                x: { stacked: true },
                y: {
                  stacked: true,
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: "Hours",
                  },
                },
              },
            },
          });
        }
      }

      /* -------------------- CROSS-FILTER STATE (Power BI Style) -------------------- */
      let globalFilteredTaskIndex = null; // Track globally selected task index for cross-filtering

      function setGlobalFilter(taskIndex) {
        if (globalFilteredTaskIndex === taskIndex) {
          // Clicking same task again clears the filter
          globalFilteredTaskIndex = null;
        } else {
          globalFilteredTaskIndex = taskIndex;
        }
        updateChartsWithFilter();
        updateFilterIndicator();
      }

      function clearGlobalFilter() {
        globalFilteredTaskIndex = null;
        updateChartsWithFilter();
        updateFilterIndicator();
      }

      function updateFilterIndicator() {
        const indicator = document.getElementById("filterIndicator");
        if (
          globalFilteredTaskIndex !== null &&
          trackers[globalFilteredTaskIndex]
        ) {
          const taskName = trackers[globalFilteredTaskIndex].name;
          const colors = [
            "#4f46e5",
            "#10b981",
            "#ef4444",
            "#f59e0b",
            "#3b82f6",
            "#8b5cf6",
            "#ec4899",
          ];
          const color = colors[globalFilteredTaskIndex % colors.length];
          indicator.innerHTML = `
            <span style="display: inline-block; width: 12px; height: 12px; background: ${color}; border-radius: 50%; margin-right: 8px;"></span>
            Filtered by: <strong>${taskName}</strong>
            <button onclick="clearGlobalFilter()" style="margin-left: 12px; padding: 4px 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">‚úï Clear Filter</button>
          `;
          indicator.style.display = "flex";
        } else {
          indicator.style.display = "none";
        }
      }

      function updateChartsWithFilter() {
        drawCharts();
      }

      /* -------------------- RENDER -------------------- */
      let bar, pie, lineChart, doughnutChart, stackedDayChart;
      let pieSelectedTasks = null; // Track selected tasks for pie chart
      function render() {
        const trackerBox = document.getElementById("trackers");
        const runningBox = document.getElementById("runningTrackers");
        const taskListBox = document.getElementById("taskList");
        trackerBox.innerHTML = "";
        runningBox.innerHTML = "";
        taskListBox.innerHTML = "";

        let grand = 0;
        let runningCount = 0;

        trackers.forEach((t, i) => {
          grand += t.total;
          const timerKey = `${currentSheet}-${i}`;
          const running = runningTimers[timerKey];
          const elapsed = running ? Date.now() - running : 0;
          const total = t.total + elapsed;

          // Add card to right panel (both running and not running)
          // Change the "Download CSV" button name for each task to icon with CSV, like "‚¨áÔ∏è CSV" by myself (in line 3183).
          const c = document.createElement("div");
          c.id = `task-${i}`;
          c.className = "card";
          c.innerHTML = `<h3>${t.name} <span style="cursor: pointer; color: var(--primary); font-size: 16px; margin-left: 8px;" onclick="editTask(${i})" title="Edit task name">‚úèÔ∏è</span><span class="analytics-icon" onclick="openAnalytics(${i})" title="View Analytics">üìä</span></h3>
      <div class=controls>
        <button id="start-${i}" class="${running ? "running" : ""}" onclick="start(${i})" ${running ? "disabled" : ""}>${running ? "Running" : "Start"}</button>
        <button id="stop-${i}" onclick="stop(${i})" ${!running ? "disabled" : ""}>Stop</button>
        <button id="del-${i}" onclick="del(${i})" ${running ? "disabled" : ""}>Delete</button>
        <button id="download-${i}" onclick="downloadTask(${i})">‚¨áÔ∏è CSV</button>
        <strong id="total-${i}" class="total-time">Total: ${dur(total)}</strong>
      </div>
      <table><tr><th>Start Date</th><th>Start Time</th><th>End Date</th><th>End Time</th><th>Duration</th><th class="actions-header">Actions</th></tr>
      ${t.rows.map((r, rIdx) => `<tr id="row-${i}-${rIdx}"><td class="cell-sd cell-date">${r.sd}</td><td class="cell-st cell-time">${r.st}</td><td class="cell-ed cell-date">${r.ed || (r.running ? "Running..." : "")}</td><td class="cell-et cell-time">${r.et || (r.running ? "" : "")}</td><td class="cell-dur">${r.running ? dur(elapsed) : dur(r.dur)}</td><td class="cell-actions" style="text-align: center;"><span class="row-edit" style="cursor: pointer; color: var(--primary); font-size: 14px; margin: 0 4px;" onclick="editRowData(${i}, ${rIdx}, this)" title="Edit row">‚úèÔ∏è</span><span class="row-history" style="cursor: pointer; color: #8b5cf6; font-size: 14px; margin: 0 4px;" onclick="showRowHistory(${i}, ${rIdx})" title="View edit history">üìã</span><span class="row-delete" style="cursor: pointer; color: var(--danger); font-size: 14px; margin: 0 4px;" onclick="deleteRow(${i}, ${rIdx})" title="Delete row">üóëÔ∏è</span></td></tr>`).join("")}
      </table>`;
          trackerBox.appendChild(c);

          // Also add to running section if currently running (compact)
          if (running) {
            const runningCard = document.createElement("div");
            runningCard.className = "running-card";
            runningCard.innerHTML = `<h4>${t.name}</h4>
              <div class="time-display" id="running-time-${i}">${dur(elapsed)}</div>
              <button id="running-stop-${i}" onclick="stop(${i})">Stop</button>`;
            runningBox.appendChild(runningCard);
            runningCount++;
          }

          // Add to task list (shows all tasks)
          const listItem = document.createElement("li");
          const listLink = document.createElement("a");
          listLink.className = running
            ? "task-list-link running"
            : "task-list-link completed";
          listLink.innerHTML =
            t.name +
            (running
              ? ` <span style="font-size: 10px; margin-left: 4px;" id="list-time-${i}">${dur(elapsed)}</span>`
              : "");
          listLink.onclick = (e) => {
            e.preventDefault();
            const taskCard = document.getElementById(`task-${i}`);
            if (taskCard) {
              taskCard.scrollIntoView({ behavior: "smooth", block: "start" });
            }
          };
          listItem.appendChild(listLink);
          taskListBox.appendChild(listItem);
        });

        // Add Activity Analytics link to task list
        const analyticsItem = document.createElement("li");
        const analyticsLink = document.createElement("a");
        analyticsLink.className = "task-list-link";
        analyticsLink.style.background =
          "linear-gradient(135deg, #667eea 0%, #764ba2 100%)";
        analyticsLink.style.color = "#fff";
        analyticsLink.style.fontWeight = "600";
        analyticsLink.innerHTML = "üìä Activity Analytics";
        analyticsLink.onclick = (e) => {
          e.preventDefault();
          const analyticsSection = document.querySelector(".analytics");
          if (analyticsSection) {
            analyticsSection.scrollIntoView({
              behavior: "smooth",
              block: "start",
            });
          }
        };
        analyticsItem.appendChild(analyticsLink);
        taskListBox.appendChild(analyticsItem);

        // Show message if no trackers running
        if (runningCount === 0) {
          runningBox.innerHTML =
            '<p style="color: var(--muted); text-align: center; padding: 20px; font-size: 12px;">No tasks running</p>';
        }

        // Initialize total running time
        document.getElementById("totalRunning").textContent =
          "Total Running Time: " + dur(grand);
      }

      function drawCharts() {
        const labels = trackers.map((t) => t.name);
        const durationData = trackers.map((t) =>
          (t.total / 3600000).toFixed(2),
        );
        const countData = trackers.map((t) => t.rows.length);
        const total = trackers.reduce((a, t) => a + t.total, 0) || 1;
        const colors = [
          "#4f46e5",
          "#10b981",
          "#ef4444",
          "#f59e0b",
          "#3b82f6",
          "#8b5cf6",
          "#ec4899",
        ];

        // Dimmed colors for non-selected items (Power BI style)
        const dimmedColors = colors.map((c) => c + "33"); // Add transparency

        if (bar) bar.destroy();
        if (pie) pie.destroy();
        if (lineChart) lineChart.destroy();
        if (doughnutChart) doughnutChart.destroy();
        if (stackedDayChart) stackedDayChart.destroy();

        if (labels.length === 0) return;

        // Helper function to get filtered background colors
        const getFilteredColors = (
          baseColors,
          highlightIndex = globalFilteredTaskIndex,
        ) => {
          if (highlightIndex === null) return baseColors;
          return baseColors.map((color, idx) =>
            idx === highlightIndex ? color : color + "40",
          );
        };

        // Helper function to get filtered border colors
        const getFilteredBorderColors = (
          baseColors,
          highlightIndex = globalFilteredTaskIndex,
        ) => {
          if (highlightIndex === null) return baseColors;
          return baseColors.map((color, idx) =>
            idx === highlightIndex ? color : color + "40",
          );
        };

        // Helper function to get filtered data (show all data but highlight selected)
        const getFilteredData = (
          data,
          highlightIndex = globalFilteredTaskIndex,
        ) => {
          return data; // Keep all data visible for context
        };

        // Mixed chart: Bar for duration + Line for count
        const barBgColors = getFilteredColors(colors.slice(0, labels.length));
        const barBorderColors = getFilteredBorderColors(
          colors.slice(0, labels.length),
        );

        bar = new Chart(barChart, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: "Duration (Hours)",
                data: durationData,
                backgroundColor: barBgColors,
                borderColor: barBorderColors,
                borderWidth:
                  globalFilteredTaskIndex !== null
                    ? labels.map((_, idx) =>
                        idx === globalFilteredTaskIndex ? 3 : 1,
                      )
                    : 1,
                borderRadius: 12,
                borderSkipped: false,
                yAxisID: "y",
                type: "bar",
                order: 2,
              },
              {
                label: "Count (Sessions)",
                data: countData,
                borderColor:
                  globalFilteredTaskIndex !== null ? "#ef444480" : "#ef4444",
                backgroundColor: "rgba(239, 68, 68, 0.2)",
                borderWidth: 3,
                yAxisID: "y1",
                type: "line",
                tension: 0.3,
                pointRadius: labels.map((_, idx) =>
                  globalFilteredTaskIndex === null ||
                  idx === globalFilteredTaskIndex
                    ? 6
                    : 3,
                ),
                pointBorderColor: "#fff",
                pointBorderWidth: 2,
                pointBackgroundColor: labels.map((_, idx) =>
                  globalFilteredTaskIndex === null ||
                  idx === globalFilteredTaskIndex
                    ? "#ef4444"
                    : "#ef444440",
                ),
                order: 1,
                fill: false,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
              mode: "index",
              intersect: false,
            },
            onClick: (event, elements) => {
              if (elements.length > 0) {
                const index = elements[0].index;
                setGlobalFilter(index);
              }
            },
            scales: {
              y: {
                type: "linear",
                display: true,
                position: "left",
                title: {
                  display: true,
                  text: "Duration (Hours)",
                },
              },
              y1: {
                type: "linear",
                display: true,
                position: "right",
                title: {
                  display: true,
                  text: "Count (Sessions)",
                },
                grid: {
                  drawOnChartArea: false,
                },
              },
            },
            plugins: {
              legend: {
                display: true,
                position: "top",
              },
              tooltip: {
                callbacks: {
                  label: function (ctx) {
                    const idx = ctx.dataIndex;
                    const t = trackers[idx];
                    const durations = t.rows
                      .map((r) => r.dur)
                      .sort((a, b) => a - b);
                    const pct = ((t.total / total) * 100).toFixed(1);
                    if (ctx.dataset.label.includes("Duration")) {
                      return [
                        `Duration: ${dur(t.total)}`,
                        `Min: ${durations.length ? dur(durations[0]) : "N/A"}`,
                        `Max: ${durations.length ? dur(durations[durations.length - 1]) : "N/A"}`,
                        `Percentage: ${pct}%`,
                        globalFilteredTaskIndex === null
                          ? "üñ±Ô∏è Click to filter all charts"
                          : idx === globalFilteredTaskIndex
                            ? "üñ±Ô∏è Click to clear filter"
                            : "üñ±Ô∏è Click to switch filter",
                      ];
                    } else {
                      return `Count: ${t.rows.length} sessions`;
                    }
                  },
                },
              },
            },
          },
        });

        // Prepare pie data
        const basePieData = trackers.map((t) => t.total);

        // Get filtered pie colors for Power BI style highlighting
        const pieBgColors =
          globalFilteredTaskIndex !== null
            ? colors
                .slice(0, labels.length)
                .map((color, idx) =>
                  idx === globalFilteredTaskIndex ? color : color + "40",
                )
            : colors.slice(0, labels.length);

        // Pie chart with legend on sides
        pie = new Chart(pieChart, {
          type: "pie",
          data: {
            labels: labels.map((label, idx) => {
              const pct = ((trackers[idx].total / total) * 100).toFixed(1);
              return `${label} (${pct}%)`;
            }),
            datasets: [
              {
                data: basePieData,
                backgroundColor: pieBgColors,
                borderColor:
                  globalFilteredTaskIndex !== null
                    ? labels.map((_, idx) =>
                        idx === globalFilteredTaskIndex
                          ? "#fff"
                          : "rgba(255,255,255,0.3)",
                      )
                    : "#fff",
                borderWidth:
                  globalFilteredTaskIndex !== null
                    ? labels.map((_, idx) =>
                        idx === globalFilteredTaskIndex ? 4 : 1,
                      )
                    : 2,
                offset:
                  globalFilteredTaskIndex !== null
                    ? labels.map((_, idx) =>
                        idx === globalFilteredTaskIndex ? 15 : 0,
                      )
                    : 0,
              },
            ],
          },
          options: {
            responsive: true,
            onClick: (event, elements) => {
              if (elements.length > 0) {
                const index = elements[0].index;
                setGlobalFilter(index);
              }
            },
            plugins: {
              legend: {
                position: "right",
                labels: {
                  padding: 15,
                  font: {
                    size: 12,
                    weight: function (ctx) {
                      return globalFilteredTaskIndex === ctx.index
                        ? "bold"
                        : "normal";
                    },
                  },
                  usePointStyle: true,
                  color: function (ctx) {
                    const index = ctx.index;
                    if (
                      globalFilteredTaskIndex !== null &&
                      globalFilteredTaskIndex !== index
                    ) {
                      return "rgba(100, 100, 100, 0.5)";
                    }
                    return "#111111";
                  },
                },
                onClick: function (e, legendItem, legend) {
                  const index = legendItem.index;
                  setGlobalFilter(index);
                },
              },
              tooltip: {
                callbacks: {
                  label: function (ctx) {
                    const idx = ctx.dataIndex;
                    const t = trackers[idx];
                    const durations = t.rows
                      .map((r) => r.dur)
                      .sort((a, b) => a - b);

                    const pct = ((t.total / total) * 100).toFixed(1);

                    return [
                      `Count: ${t.rows.length} sessions`,
                      `Total: ${dur(t.total)}`,
                      `Min: ${durations.length ? dur(durations[0]) : "N/A"}`,
                      `Max: ${durations.length ? dur(durations[durations.length - 1]) : "N/A"}`,
                      `Percentage: ${pct}%`,
                      globalFilteredTaskIndex === null
                        ? "üñ±Ô∏è Click to filter all charts"
                        : idx === globalFilteredTaskIndex
                          ? "üñ±Ô∏è Click to clear filter"
                          : "üñ±Ô∏è Click to switch filter",
                    ];
                  },
                },
              },
            },
          },
        });

        // Line Chart: Time Trend Analysis (showing cumulative time per task)
        const lineChartCanvas = document.getElementById("lineChart");
        const cumulativeData = trackers.map((t, idx) => {
          return (
            trackers
              .slice(0, idx + 1)
              .reduce((sum, tracker) => sum + tracker.total, 0) / 3600000
          );
        });

        lineChart = new Chart(lineChartCanvas, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Cumulative Time (Hours)",
                data: cumulativeData,
                borderColor:
                  globalFilteredTaskIndex !== null ? "#8b5cf680" : "#8b5cf6",
                backgroundColor: "rgba(139, 92, 246, 0.1)",
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointRadius: labels.map((_, idx) =>
                  globalFilteredTaskIndex === null ||
                  idx === globalFilteredTaskIndex
                    ? 8
                    : 4,
                ),
                pointBackgroundColor: labels.map((_, idx) =>
                  globalFilteredTaskIndex === null ||
                  idx === globalFilteredTaskIndex
                    ? "#8b5cf6"
                    : "#8b5cf640",
                ),
                pointBorderColor: labels.map((_, idx) =>
                  globalFilteredTaskIndex === null ||
                  idx === globalFilteredTaskIndex
                    ? "#fff"
                    : "rgba(255,255,255,0.3)",
                ),
                pointBorderWidth: labels.map((_, idx) =>
                  globalFilteredTaskIndex === null ||
                  idx === globalFilteredTaskIndex
                    ? 3
                    : 1,
                ),
              },
              {
                label: "Individual Task Time (Hours)",
                data: durationData,
                borderColor:
                  globalFilteredTaskIndex !== null ? "#10b98180" : "#10b981",
                backgroundColor: "rgba(16, 185, 129, 0.1)",
                borderWidth: 2,
                tension: 0.4,
                fill: false,
                pointRadius: labels.map((_, idx) =>
                  globalFilteredTaskIndex === null ||
                  idx === globalFilteredTaskIndex
                    ? 8
                    : 3,
                ),
                pointBackgroundColor: labels.map((_, idx) =>
                  globalFilteredTaskIndex === null ||
                  idx === globalFilteredTaskIndex
                    ? "#10b981"
                    : "#10b98140",
                ),
                pointBorderColor: labels.map((_, idx) =>
                  globalFilteredTaskIndex === null ||
                  idx === globalFilteredTaskIndex
                    ? "#fff"
                    : "rgba(255,255,255,0.3)",
                ),
                pointBorderWidth: labels.map((_, idx) =>
                  globalFilteredTaskIndex === null ||
                  idx === globalFilteredTaskIndex
                    ? 3
                    : 1,
                ),
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
              mode: "index",
              intersect: false,
            },
            onClick: (event, elements) => {
              if (elements.length > 0) {
                const index = elements[0].index;
                setGlobalFilter(index);
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Time (Hours)",
                },
              },
            },
            plugins: {
              legend: {
                display: true,
                position: "top",
              },
              tooltip: {
                callbacks: {
                  label: function (ctx) {
                    const base = `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)} hours`;
                    const hint =
                      globalFilteredTaskIndex === null
                        ? "üñ±Ô∏è Click to filter all charts"
                        : ctx.dataIndex === globalFilteredTaskIndex
                          ? "üñ±Ô∏è Click to clear filter"
                          : "üñ±Ô∏è Click to switch filter";
                    return [base, hint];
                  },
                },
              },
            },
          },
        });

        // Doughnut Chart: Task Completion Rate (showing sessions vs time efficiency)
        const doughnutChartCanvas = document.getElementById("doughnutChart");
        const avgSessionDuration = trackers.map((t) => {
          if (t.rows.length === 0) return 0;
          return t.total / t.rows.length / 60000; // in minutes
        });

        // Get filtered doughnut colors
        const doughnutBgColors =
          globalFilteredTaskIndex !== null
            ? colors
                .slice(0, labels.length)
                .map((color, idx) =>
                  idx === globalFilteredTaskIndex ? color : color + "40",
                )
            : colors.slice(0, labels.length);

        doughnutChart = new Chart(doughnutChartCanvas, {
          type: "doughnut",
          data: {
            labels: labels.map((label, idx) => {
              return `${label} (${avgSessionDuration[idx].toFixed(0)} min/session)`;
            }),
            datasets: [
              {
                label: "Average Session Duration (Minutes)",
                data: avgSessionDuration,
                backgroundColor: doughnutBgColors,
                borderColor:
                  globalFilteredTaskIndex !== null
                    ? labels.map((_, idx) =>
                        idx === globalFilteredTaskIndex
                          ? "#fff"
                          : "rgba(255,255,255,0.3)",
                      )
                    : "#fff",
                borderWidth:
                  globalFilteredTaskIndex !== null
                    ? labels.map((_, idx) =>
                        idx === globalFilteredTaskIndex ? 4 : 1,
                      )
                    : 3,
                offset:
                  globalFilteredTaskIndex !== null
                    ? labels.map((_, idx) =>
                        idx === globalFilteredTaskIndex ? 15 : 0,
                      )
                    : 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            onClick: (event, elements) => {
              if (elements.length > 0) {
                const index = elements[0].index;
                setGlobalFilter(index);
              }
            },
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  padding: 15,
                  font: {
                    size: 11,
                    weight: function (ctx) {
                      return globalFilteredTaskIndex === ctx.index
                        ? "bold"
                        : "normal";
                    },
                  },
                  color: function (ctx) {
                    const index = ctx.index;
                    if (
                      globalFilteredTaskIndex !== null &&
                      globalFilteredTaskIndex !== index
                    ) {
                      return "rgba(100, 100, 100, 0.5)";
                    }
                    return "#111111";
                  },
                },
                onClick: function (e, legendItem, legend) {
                  const index = legendItem.index;
                  setGlobalFilter(index);
                },
              },
              tooltip: {
                callbacks: {
                  label: function (ctx) {
                    const idx = ctx.dataIndex;
                    const t = trackers[idx];
                    return [
                      `Task: ${t.name}`,
                      `Avg Session: ${avgSessionDuration[idx].toFixed(1)} minutes`,
                      `Total Sessions: ${t.rows.length}`,
                      `Total Time: ${dur(t.total)}`,
                      globalFilteredTaskIndex === null
                        ? "üñ±Ô∏è Click to filter all charts"
                        : idx === globalFilteredTaskIndex
                          ? "üñ±Ô∏è Click to clear filter"
                          : "üñ±Ô∏è Click to switch filter",
                    ];
                  },
                },
              },
            },
          },
        });

        // Stacked Bar Chart: Days and Task (hours per day)
        const dayLabels = [
          "Monday",
          "Tuesday",
          "Wednesday",
          "Thursday",
          "Friday",
          "Saturday",
          "Sunday",
        ];
        const dayTotals = new Array(7).fill(0);
        const dayTaskSessions = trackers.map(() => new Array(7).fill(0));
        const dayDatasets = trackers.map((t, idx) => {
          const data = new Array(7).fill(0);
          t.rows.forEach((r) => {
            const d = parseDateOnly(r.sd);
            if (!d) return;
            const dayIndex = (d.getDay() + 6) % 7; // Monday=0
            const hours = (r.dur || 0) / 3600000;
            data[dayIndex] += hours;
            dayTotals[dayIndex] += hours;
            dayTaskSessions[idx][dayIndex] += 1;
          });

          // Apply Power BI style filtering - dim non-selected datasets
          const isHighlighted =
            globalFilteredTaskIndex === null || globalFilteredTaskIndex === idx;
          const baseColor = colors[idx % colors.length];

          return {
            label: t.name,
            data,
            backgroundColor: isHighlighted ? baseColor : baseColor + "40",
            borderColor: isHighlighted ? baseColor : baseColor + "40",
            borderWidth: isHighlighted ? 2 : 1,
            borderRadius: 6,
          };
        });

        const stackedDayCanvas = document.getElementById("stackedDayChart");
        stackedDayChart = new Chart(stackedDayCanvas, {
          type: "bar",
          data: {
            labels: dayLabels,
            datasets: dayDatasets,
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            onClick: (event, elements) => {
              if (elements.length > 0) {
                const datasetIndex = elements[0].datasetIndex;
                setGlobalFilter(datasetIndex);
              }
            },
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  font: {
                    weight: function (ctx) {
                      return globalFilteredTaskIndex === ctx.datasetIndex
                        ? "bold"
                        : "normal";
                    },
                  },
                  color: function (ctx) {
                    const index = ctx.datasetIndex;
                    if (
                      globalFilteredTaskIndex !== null &&
                      globalFilteredTaskIndex !== index
                    ) {
                      return "rgba(100, 100, 100, 0.5)";
                    }
                    return "#111111";
                  },
                },
                onClick: function (e, legendItem, legend) {
                  const index = legendItem.datasetIndex;
                  setGlobalFilter(index);
                },
              },
              tooltip: {
                callbacks: {
                  label: function (ctx) {
                    const dayIndex = ctx.dataIndex;
                    const taskName = ctx.dataset.label;
                    const hours = ctx.parsed.y || 0;
                    const minutes = hours * 60;
                    const taskIdx = ctx.datasetIndex;
                    const sessions = dayTaskSessions[taskIdx][dayIndex] || 0;
                    const dayTotal = dayTotals[dayIndex] || 0;
                    const pct = dayTotal > 0 ? (hours / dayTotal) * 100 : 0;

                    return [
                      `Day: ${dayLabels[dayIndex]}`,
                      `Task: ${taskName}`,
                      `Hours: ${hours.toFixed(2)}h`,
                      `Minutes: ${minutes.toFixed(0)}m`,
                      `Sessions: ${sessions}`,
                      `Day Total: ${dayTotal.toFixed(2)}h`,
                      `Share: ${pct.toFixed(1)}%`,
                      globalFilteredTaskIndex === null
                        ? "üñ±Ô∏è Click to filter all charts"
                        : taskIdx === globalFilteredTaskIndex
                          ? "üñ±Ô∏è Click to clear filter"
                          : "üñ±Ô∏è Click to switch filter",
                    ];
                  },
                },
              },
            },
            scales: {
              x: { stacked: true },
              y: {
                stacked: true,
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Hours",
                },
              },
            },
          },
        });
      }

      render();
      drawCharts();

      // Display current user if logged in
      if (currentUser) {
        displayUserBadge();
      }

      // Initialize mode button on load
      const modeBtn = document.getElementById("modeBtn");
      if (!singleTaskMode) {
        modeBtn.textContent = "Multiple Tasks";
        modeBtn.className = "toggle-mode multi";
        modeBtn.title =
          "Multiple Tasks Mode: ON (click to restrict to single task)";
      }

      // Update sheet name header on load
      document.getElementById("sheetNameHeader").textContent = currentSheet;

      // Restart running timers on page load
      Object.keys(runningTimers).forEach((timerKey) => {
        const parts = timerKey.split("-");
        const idx = parseInt(parts[parts.length - 1]);
        const sheetKey = parts.slice(0, -1).join("-");

        // Restart the timer update for currently running tasks
        if (sheetKey === currentSheet && trackers[idx]) {
          updateTimer(idx);
        }
      });

      // Update task list timers every 100ms
      setInterval(() => {
        Object.keys(runningTimers).forEach((timerKey) => {
          const parts = timerKey.split("-");
          const idx = parseInt(parts[parts.length - 1]);
          const sheetKey = parts.slice(0, -1).join("-");

          if (sheetKey === currentSheet) {
            const listTimeEl = document.getElementById(`list-time-${idx}`);
            if (listTimeEl) {
              const elapsed = Date.now() - runningTimers[timerKey];
              listTimeEl.textContent = dur(elapsed);
            }
          }
        });
      }, 100);

      // Also set up a continuous update for all running tasks in real-time
      setInterval(() => {
        // Only get running timers from the CURRENT sheet
        const currentSheetRunningTimers = Object.keys(runningTimers).filter(
          (key) => key.startsWith(currentSheet + "-"),
        );

        if (currentSheetRunningTimers.length > 0) {
          // Update total running time display only if there are running timers on current sheet
          const timerValues = currentSheetRunningTimers.map(
            (key) => Date.now() - runningTimers[key],
          );
          const totalElapsed = timerValues.reduce((a, b) => a + b, 0);
          const grand = trackers.reduce((a, t) => a + t.total, 0);
          document.getElementById("totalRunning").textContent =
            "Total Running Time: " + dur(grand + totalElapsed);
        } else {
          // Show only total completed time when no timers running on current sheet
          const grand = trackers.reduce((a, t) => a + t.total, 0);
          document.getElementById("totalRunning").textContent =
            "Total Running Time: " + dur(grand);
        }
      }, 100);

      /* -------------------- SHEET MANAGEMENT -------------------- */
      function openSheetsModal() {
        const modal = document.getElementById("sheetsModal");
        modal.classList.add("active");
        renderSheetsList();
      }

      function closeModal() {
        const modal = document.getElementById("sheetsModal");
        modal.classList.remove("active");
      }

      function renderSheetsList() {
        const sheetsList = document.getElementById("sheetsList");
        sheetsList.innerHTML = "";

        Object.keys(sheets).forEach((sheetName) => {
          const li = document.createElement("li");
          li.className = "sheet-item";
          if (sheetName === currentSheet) {
            li.classList.add("active");
          }

          const nameSpan = document.createElement("span");
          nameSpan.textContent = sheetName;
          nameSpan.style.cursor = "pointer";
          nameSpan.style.flex = "1";
          nameSpan.onclick = () => switchSheet(sheetName);

          const actionsDiv = document.createElement("div");
          actionsDiv.className = "sheet-actions";

          const editBtn = document.createElement("button");
          editBtn.textContent = "‚úèÔ∏è";
          editBtn.title = "Rename sheet";
          editBtn.onclick = () => renameSheet(sheetName);

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "üóëÔ∏è";
          deleteBtn.title = "Delete sheet";
          deleteBtn.onclick = () => deleteSheet(sheetName);

          actionsDiv.appendChild(editBtn);
          actionsDiv.appendChild(deleteBtn);
          li.appendChild(nameSpan);
          li.appendChild(actionsDiv);
          sheetsList.appendChild(li);
        });
      }

      function switchSheet(sheetName) {
        if (!sheets[sheetName]) {
          alert("Sheet not found!");
          return;
        }
        if (sheetName === currentSheet) {
          closeModal();
          return;
        }
        currentSheet = sheetName;
        trackers = sheets[currentSheet] || [];
        document.getElementById("sheetNameHeader").textContent = currentSheet;
        // Clear global filter when switching sheets
        globalFilteredTaskIndex = null;
        updateFilterIndicator();

        // Load row histories for the new sheet
        loadRowHistories();

        save();
        render();
        drawCharts();
        renderSheetsList();
      }

      function createNewSheet() {
        const newName = prompt("Enter new sheet name:");
        if (!newName || newName.trim() === "") return;
        const trimmedName = newName.trim();

        if (sheets[trimmedName]) {
          alert("Sheet already exists!");
          return;
        }

        sheets[trimmedName] = [];
        save();
        switchSheet(trimmedName);
      }

      function renameSheet(oldName) {
        const newName = prompt(`Rename "${oldName}" to:`, oldName);
        if (!newName || newName.trim() === "") return;
        const trimmedName = newName.trim();

        if (trimmedName === oldName) return;

        if (sheets[trimmedName]) {
          alert("Sheet already exists with that name!");
          return;
        }

        sheets[trimmedName] = sheets[oldName];
        delete sheets[oldName];

        if (currentSheet === oldName) {
          currentSheet = trimmedName;
          document.getElementById("sheetNameHeader").textContent = trimmedName;
        }

        save();
        renderSheetsList();
      }

      function deleteSheet(sheetName) {
        if (sheetName === currentSheet) {
          alert(
            "Cannot delete the current sheet! Switch to another sheet first.",
          );
          return;
        }

        if (confirm(`Delete sheet "${sheetName}"?`)) {
          delete sheets[sheetName];
          save();
          renderSheetsList();
        }
      }

      // Close modal when clicking outside
      document.getElementById("sheetsModal").onclick = (e) => {
        if (e.target.id === "sheetsModal") {
          closeModal();
        }
      };

      /* -------------------- SHORTCUT MODAL -------------------- */
      function openShortcutModal() {
        const modal = document.getElementById("shortcutModal");
        if (!modal) return;
        modal.classList.add("active");
      }

      function closeShortcutModal() {
        const modal = document.getElementById("shortcutModal");
        if (!modal) return;
        modal.classList.remove("active");
      }

      document.getElementById("shortcutModal").onclick = (e) => {
        if (e.target.id === "shortcutModal") {
          closeShortcutModal();
        }
      };

      /* -------------------- HOME SIDEBAR -------------------- */
      function toggleHomeSidebar() {
        const sidebar = document.getElementById("homeSidebar");
        sidebar.classList.toggle("active");
        if (sidebar.classList.contains("active")) {
          renderRunningTasks();
        }
      }

      function renderRunningTasks() {
        const runningTasksList = document.getElementById("runningTasksList");
        runningTasksList.innerHTML = "";

        let hasRunning = false;

        // Get all running tasks from all sheets
        Object.entries(sheets).forEach(([sheetName, sheetTrackers]) => {
          sheetTrackers.forEach((t, idx) => {
            if (runningTimers[`${sheetName}-${idx}`]) {
              hasRunning = true;
              const startTime = runningTimers[`${sheetName}-${idx}`];
              const elapsed = Date.now() - startTime;

              const card = document.createElement("div");
              card.className = "running-task-card";
              card.style.cursor = "pointer";
              card.innerHTML = `
                <div class="sheet-name">Sheet: ${sheetName}</div>
                <h4>${t.name}</h4>
                <div class="timer" id="timer-${sheetName}-${idx}">${dur(elapsed)}</div>
                <button onclick="stopTaskFromHome('${sheetName}', ${idx})">Stop</button>
              `;
              card.onclick = (e) => {
                if (e.target.textContent !== "Stop") {
                  switchSheet(sheetName);
                  toggleHomeSidebar();
                }
              };
              runningTasksList.appendChild(card);
            }
          });
        });

        if (!hasRunning) {
          runningTasksList.innerHTML =
            '<div class="no-running">No running tasks</div>';
        }

        // Update timers every 100ms
        updateRunningTimersDisplay();
      }

      function updateRunningTimersDisplay() {
        Object.keys(runningTimers).forEach((key) => {
          const timerEl = document.getElementById(`timer-${key}`);
          if (timerEl) {
            const startTime = runningTimers[key];
            const elapsed = Date.now() - startTime;
            timerEl.textContent = dur(elapsed);
          }
        });

        if (
          document.getElementById("homeSidebar").classList.contains("active")
        ) {
          setTimeout(updateRunningTimersDisplay, 100);
        }
      }

      function stopTaskFromHome(sheetName, trackerIdx) {
        const timerKey = `${sheetName}-${trackerIdx}`;
        if (!runningTimers[timerKey]) return;

        // Switch to the sheet and stop the task
        currentSheet = sheetName;
        trackers = sheets[currentSheet] || [];
        stop(trackerIdx);

        // Close the sidebar and scroll to the task
        toggleHomeSidebar();
        setTimeout(() => {
          const taskCard = document.getElementById(`task-${trackerIdx}`);
          if (taskCard) {
            taskCard.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        }, 300);
      }

      // Update running timers display every 100ms when sidebar is active
      setInterval(() => {
        if (
          document.getElementById("homeSidebar").classList.contains("active")
        ) {
          updateRunningTimersDisplay();
        }
      }, 100);

      // Keyboard shortcuts - Global shortcut handler for tracker page
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          if (closeAllPopups()) {
            e.preventDefault();
            return;
          }
        }
        // Check if Alt key is pressed
        if (e.altKey) {
          switch (e.key) {
            case "1":
              // Alt+1: Create new task
              e.preventDefault();
              addTracker();
              break;
            case "2":
              // Alt+2: Open sheet list popup
              e.preventDefault();
              openSheetsModal();
              break;
            case "3":
              // Alt+3: Toggle single/multiple tasks mode
              e.preventDefault();
              toggleMode();
              break;
            case "e":
            case "E": {
              // Alt+E: Toggle Actions column
              e.preventDefault();
              const isVisible =
                !document.body.classList.contains("hide-actions");
              toggleActionsColumn(!isVisible);
              break;
            }
            case "m":
            case "M":
              // Alt+M: Open/close menu
              e.preventDefault();
              toggleMenuDrawer();
              break;
            case "/":
            case "?":
              // Alt+/: Toggle night/day mode
              e.preventDefault();
              toggleThemeMode();
              break;
            case "h":
            case "H":
              // Alt+H: Open home tab
              e.preventDefault();
              toggleHomeSidebar();
              break;
            case ".":
              // Alt+.: Open shortcut keys popup
              e.preventDefault();
              openShortcutModal();
              break;
            case "p":
            case "P":
              // Alt+P: Open ProDoc page
              e.preventDefault();
              window.open("ProDoc/ProDoc.html", "_blank");
              break;
            case "o":
            case "O":
              // Alt+O: Open To-Do page
              e.preventDefault();
              window.open("todo.html", "_blank");
              break;
            case "l":
            case "L":
              // Alt+L: Open Know Me page
              e.preventDefault();
              window.open("welcome.html", "_blank");
              break;
            case "a":
            case "A": {
              // Alt+A: Go to Activity Analytics
              e.preventDefault();
              const analyticsSection = document.querySelector(".analytics");
              if (analyticsSection) {
                analyticsSection.scrollIntoView({
                  behavior: "smooth",
                  block: "start",
                });
              }
              break;
            }
            case "s":
            case "S":
              // Alt+S: Open smart timer web
              e.preventDefault();
              window.open("NotificationTimer.html", "_blank");
              break;
          }
        }
      });

      // Add event listeners to menu links
      document.querySelectorAll(".menu-link").forEach((link) => {
        link.addEventListener("click", (event) => {
          handleMenuLinkClick(event, link.getAttribute("href"));
        });
      });

      // Toggle right-side menu drawer
      function toggleMenuDrawer(force) {
        const drawer = document.getElementById("menuDrawer");
        if (!drawer) return;
        const isActive = drawer.classList.contains("active");
        const shouldOpen = typeof force === "boolean" ? force : !isActive;
        drawer.classList.toggle("active", shouldOpen);

        // Sync user info visibility and content
        const headerUser = document.getElementById("userDisplay");
        const drawerUser = document.getElementById("drawerUserDisplay");
        if (drawerUser) {
          if (
            headerUser &&
            headerUser.style.display !== "none" &&
            headerUser.textContent
          ) {
            drawerUser.style.display = "inline-flex";
            drawerUser.textContent = headerUser.textContent;
          } else {
            drawerUser.style.display = "none";
            drawerUser.textContent = "";
          }
        }

        // Sync logout button visibility
        const headerLogout = document.getElementById("logoutBtn");
        const drawerLogout = document.getElementById("drawerLogoutBtn");
        if (drawerLogout && headerLogout) {
          drawerLogout.style.display = headerLogout.style.display || "none";
        }
      }

      function handleMenuLinkClick(event, url) {
        if (event.button === 1) {
          event.preventDefault();
          window.open(url, "_blank");
        }
      }

      function closeAllPopups() {
        let closed = false;

        const menuDrawer = document.getElementById("menuDrawer");
        if (menuDrawer && menuDrawer.classList.contains("active")) {
          toggleMenuDrawer(false);
          closed = true;
        }

        const homeSidebar = document.getElementById("homeSidebar");
        if (homeSidebar && homeSidebar.classList.contains("active")) {
          toggleHomeSidebar();
          closed = true;
        }

        const sheetsModal = document.getElementById("sheetsModal");
        if (sheetsModal && sheetsModal.classList.contains("active")) {
          closeModal();
          closed = true;
        }

        const analyticsModal = document.getElementById("analyticsModal");
        if (analyticsModal && analyticsModal.classList.contains("active")) {
          closeAnalytics();
          closed = true;
        }

        const analyticsDetailModal = document.getElementById(
          "analyticsDetailModal",
        );
        if (
          analyticsDetailModal &&
          analyticsDetailModal.classList.contains("active")
        ) {
          closeAnalyticsDetail();
          closed = true;
        }

        const shortcutModal = document.getElementById("shortcutModal");
        if (shortcutModal && shortcutModal.classList.contains("active")) {
          closeShortcutModal();
          closed = true;
        }

        const calPopup = document.getElementById("calendarPopup");
        if (calPopup) {
          closeCalendarPopup();
          closed = true;
        }

        const timePopup = document.getElementById("timePopup");
        if (timePopup) {
          closeTimePopup();
          closed = true;
        }

        return closed;
      }
    </script>

    <script>
      let currentPickerCell = null;
      let currentPickerRow = null;

      function openDatePickerPopup(cellElement, rowData, isDate) {
        currentPickerCell = cellElement;
        currentPickerRow = rowData;
        const currentDate = cellElement.textContent.trim();
        showCalendarPopup(currentDate, cellElement);
      }

      function openTimePickerPopup(cellElement, rowData, isDate) {
        currentPickerCell = cellElement;
        currentPickerRow = rowData;
        const currentTime = cellElement.textContent.trim();
        showTimePopup(currentTime, cellElement);
      }

      function showCalendarPopup(dateStr, cellElement) {
        const existingPopup = document.getElementById("calendarPopup");
        if (existingPopup) existingPopup.remove();

        let date = new Date();
        if (dateStr) {
          const parsed = new Date(dateStr + "T00:00:00");
          if (!isNaN(parsed.getTime())) date = parsed;
        }

        const popup = document.createElement("div");
        popup.id = "calendarPopup";
        popup.style.cssText = `
          position: fixed;
          background: #2d2d2d;
          border: 1px solid #444;
          border-radius: 12px;
          padding: 20px;
          box-shadow: 0 10px 40px rgba(0,0,0,0.5);
          z-index: 99999;
        `;

        const header = document.createElement("div");
        header.style.cssText =
          "display:flex;align-items:center;justify-content:space-between;margin-bottom:15px;color:#fff;";
        header.innerHTML = `
          <button onclick="previousMonth()" style="background:transparent;border:none;color:#999;font-size:18px;cursor:pointer;padding:5px 10px;">‚Üë</button>
          <span class="cal-month" style="font-size:18px;font-weight:600;">${date.toLocaleDateString("en-US", { month: "long", year: "numeric" })}</span>
          <button onclick="nextMonth()" style="background:transparent;border:none;color:#999;font-size:18px;cursor:pointer;padding:5px 10px;">‚Üì</button>
        `;
        popup.appendChild(header);

        const weekdays = document.createElement("div");
        weekdays.style.cssText =
          "display:grid;grid-template-columns:repeat(7,40px);gap:4px;margin-bottom:10px;color:#999;font-size:12px;text-align:center;";
        weekdays.innerHTML =
          "<div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>";
        popup.appendChild(weekdays);

        const daysGrid = document.createElement("div");
        daysGrid.id = "calendarDays";
        daysGrid.style.cssText =
          "display:grid;grid-template-columns:repeat(7,40px);gap:4px;margin-bottom:15px;";
        popup.appendChild(daysGrid);

        const footer = document.createElement("div");
        footer.style.cssText =
          "text-align:center;border-top:1px solid #444;padding-top:12px;";
        footer.innerHTML = `<button onclick="selectToday()" style="background:transparent;border:none;color:#999;cursor:pointer;font-size:13px;">Go to today</button>`;
        popup.appendChild(footer);

        popup.dataset.year = date.getFullYear();
        popup.dataset.month = date.getMonth();
        popup.dataset.selectedDate = dateStr;

        renderCalendarDays(popup, date, dateStr);

        document.body.appendChild(popup);

        // Position popup and scroll to ensure visibility
        const popupHeight = popup.offsetHeight;
        const popupWidth = popup.offsetWidth;
        const viewportHeight = window.innerHeight;
        const viewportWidth = window.innerWidth;

        // Scroll cell into view first
        cellElement.scrollIntoView({ behavior: "smooth", block: "center" });

        // Wait for scroll to complete then position popup
        setTimeout(() => {
          const rect = cellElement.getBoundingClientRect();
          let left = rect.left;
          let top = rect.bottom + 5;

          // Adjust if popup goes off right edge
          if (left + popupWidth > viewportWidth - 10) {
            left = viewportWidth - popupWidth - 10;
          }
          // Adjust if popup goes off left edge
          if (left < 10) left = 10;

          // Adjust if popup goes off bottom edge - show above cell
          if (top + popupHeight > viewportHeight - 10) {
            top = rect.top - popupHeight - 5;
          }
          // If still off top, just position at top
          if (top < 10) top = 10;

          popup.style.left = left + "px";
          popup.style.top = top + "px";
        }, 300);
      }

      function renderCalendarDays(popup, date, selectedDateStr) {
        const year = parseInt(popup.dataset.year);
        const month = parseInt(popup.dataset.month);

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();

        const daysContainer = popup.querySelector("#calendarDays");
        daysContainer.innerHTML = "";

        const dayStyle =
          "width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:6px;font-size:14px;cursor:pointer;";

        for (let i = firstDay - 1; i >= 0; i--) {
          const dayDiv = document.createElement("div");
          dayDiv.style.cssText = dayStyle + "color:#555;";
          dayDiv.textContent = daysInPrevMonth - i;
          daysContainer.appendChild(dayDiv);
        }

        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
          const dayDiv = document.createElement("div");
          const dateObj = new Date(year, month, day);
          // Use local date values instead of toISOString() which converts to UTC
          const dateString = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;

          let style = dayStyle + "color:#fff;";
          if (dateString === selectedDateStr) {
            style += "background:#6366f1;border:2px solid #8b5cf6;";
          }
          if (dateObj > today) {
            style += "color:#555;cursor:not-allowed;";
            dayDiv.style.cssText = style;
          } else {
            dayDiv.style.cssText = style;
            dayDiv.onmouseover = () => {
              if (dateObj <= today)
                dayDiv.style.background = "rgba(255,255,255,0.1)";
            };
            dayDiv.onmouseout = () => {
              if (dateString !== selectedDateStr) dayDiv.style.background = "";
            };
            dayDiv.onclick = () => selectDate(dateString);
          }
          dayDiv.textContent = day;
          daysContainer.appendChild(dayDiv);
        }

        const totalCells = daysContainer.children.length;
        const remainingCells = 42 - totalCells;
        for (let day = 1; day <= remainingCells; day++) {
          const dayDiv = document.createElement("div");
          dayDiv.style.cssText = dayStyle + "color:#555;";
          dayDiv.textContent = day;
          daysContainer.appendChild(dayDiv);
        }
      }

      function previousMonth() {
        const popup = document.getElementById("calendarPopup");
        if (!popup) return;
        let month = parseInt(popup.dataset.month);
        let year = parseInt(popup.dataset.year);
        month--;
        if (month < 0) {
          month = 11;
          year--;
        }
        popup.dataset.month = month;
        popup.dataset.year = year;
        const date = new Date(year, month, 1);
        popup.querySelector(".cal-month").textContent = date.toLocaleDateString(
          "en-US",
          { month: "long", year: "numeric" },
        );
        renderCalendarDays(popup, date, popup.dataset.selectedDate);
      }

      function nextMonth() {
        const popup = document.getElementById("calendarPopup");
        if (!popup) return;
        let month = parseInt(popup.dataset.month);
        let year = parseInt(popup.dataset.year);
        month++;
        if (month > 11) {
          month = 0;
          year++;
        }
        popup.dataset.month = month;
        popup.dataset.year = year;
        const date = new Date(year, month, 1);
        popup.querySelector(".cal-month").textContent = date.toLocaleDateString(
          "en-US",
          { month: "long", year: "numeric" },
        );
        renderCalendarDays(popup, date, popup.dataset.selectedDate);
      }

      function selectDate(dateString) {
        if (currentPickerCell) {
          // Convert ISO date (YYYY-MM-DD) to US locale format (M/D/YYYY) for consistency
          const dateObj = new Date(dateString + "T00:00:00");
          const localeDateStr = dateObj.toLocaleDateString("en-US");

          // Clear text nodes but keep picker button
          const pickerBtn = currentPickerCell.querySelector(".cell-picker");
          currentPickerCell.childNodes.forEach((node) => {
            if (node.nodeType === Node.TEXT_NODE) {
              node.remove();
            }
          });

          // Set the new date as text node before the picker button
          const textNode = document.createTextNode(localeDateStr);
          if (pickerBtn) {
            currentPickerCell.insertBefore(textNode, pickerBtn);
          } else {
            currentPickerCell.appendChild(textNode);
          }

          if (currentPickerRow) currentPickerRow.sd = localeDateStr;
        }
        closeCalendarPopup();
      }

      function selectToday() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, "0");
        const day = String(today.getDate()).padStart(2, "0");
        selectDate(`${year}-${month}-${day}`);
      }

      function closeCalendarPopup() {
        const popup = document.getElementById("calendarPopup");
        if (popup) popup.remove();
      }

      function showTimePopup(timeStr, cellElement) {
        const existingPopup = document.getElementById("timePopup");
        if (existingPopup) existingPopup.remove();

        // Parse time - could be HH:MM or HH:MM:SS or HH:MM:SS AM/PM
        let hours = "12",
          minutes = "00",
          seconds = "00",
          ampm = "AM";
        if (timeStr) {
          // Match time like "12:23:31 AM" or "1:05:30 PM"
          const timeParts = timeStr.match(/(\d+):(\d+):(\d+)\s*(AM|PM)/i);
          if (timeParts) {
            hours = timeParts[1];
            minutes = timeParts[2].padStart(2, "0");
            seconds = timeParts[3].padStart(2, "0");
            ampm = timeParts[4].toUpperCase();
          } else {
            // Try simpler format HH:MM
            const simpleParts = timeStr.match(/(\d+):(\d+)/);
            if (simpleParts) {
              hours = simpleParts[1];
              minutes = simpleParts[2].padStart(2, "0");
            }
          }
        }

        const popup = document.createElement("div");
        popup.id = "timePopup";
        popup.style.cssText = `
          position: fixed;
          background: #2d2d2d;
          border: 1px solid #444;
          border-radius: 12px;
          padding: 20px;
          box-shadow: 0 10px 40px rgba(0,0,0,0.5);
          z-index: 99999;
          min-width: 280px;
        `;

        const header = document.createElement("div");
        header.style.cssText =
          "text-align:center;color:#fff;font-size:18px;font-weight:600;margin-bottom:20px;";
        header.textContent = "‚è∞ Select Time";
        popup.appendChild(header);

        const inputsDiv = document.createElement("div");
        inputsDiv.style.cssText =
          "display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:20px;";

        const inputStyle =
          "width:50px;padding:8px;border:1px solid #555;border-radius:8px;background:#3d3d3d;color:#fff;font-size:16px;text-align:center;font-weight:600;";
        const labelStyle =
          "color:#999;font-size:11px;margin-bottom:5px;display:block;text-align:center;";
        const selectStyle =
          "width:60px;padding:8px;border:1px solid #555;border-radius:8px;background:#3d3d3d;color:#fff;font-size:16px;text-align:center;font-weight:600;cursor:pointer;";

        inputsDiv.innerHTML = `
          <div>
            <label style="${labelStyle}">Hours</label>
            <input type="number" id="hoursInput" min="1" max="12" value="${hours}" style="${inputStyle}" />
          </div>
          <div style="color:#fff;font-size:20px;font-weight:700;margin-top:18px;">:</div>
          <div>
            <label style="${labelStyle}">Min</label>
            <input type="number" id="minutesInput" min="0" max="59" value="${minutes}" style="${inputStyle}" />
          </div>
          <div style="color:#fff;font-size:20px;font-weight:700;margin-top:18px;">:</div>
          <div>
            <label style="${labelStyle}">Sec</label>
            <input type="number" id="secondsInput" min="0" max="59" value="${seconds}" style="${inputStyle}" />
          </div>
          <div>
            <label style="${labelStyle}">AM/PM</label>
            <select id="ampmSelect" style="${selectStyle}">
              <option value="AM" ${ampm === "AM" ? "selected" : ""}>AM</option>
              <option value="PM" ${ampm === "PM" ? "selected" : ""}>PM</option>
            </select>
          </div>
        `;
        popup.appendChild(inputsDiv);

        const buttonsDiv = document.createElement("div");
        buttonsDiv.style.cssText = "display:flex;gap:10px;";

        const okBtn = document.createElement("button");
        okBtn.textContent = "OK";
        okBtn.style.cssText =
          "flex:1;padding:10px;background:#6366f1;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;";
        okBtn.onclick = selectTime;

        const cancelBtn = document.createElement("button");
        cancelBtn.textContent = "Cancel";
        cancelBtn.style.cssText =
          "flex:1;padding:10px;background:#555;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;";
        cancelBtn.onclick = closeTimePopup;

        buttonsDiv.appendChild(okBtn);
        buttonsDiv.appendChild(cancelBtn);
        popup.appendChild(buttonsDiv);

        document.body.appendChild(popup);

        // Position popup and scroll to ensure visibility
        const popupHeight = popup.offsetHeight;
        const popupWidth = popup.offsetWidth;
        const viewportHeight = window.innerHeight;
        const viewportWidth = window.innerWidth;

        // Scroll cell into view first
        cellElement.scrollIntoView({ behavior: "smooth", block: "center" });

        // Wait for scroll to complete then position popup
        setTimeout(() => {
          const rect = cellElement.getBoundingClientRect();
          let left = rect.left;
          let top = rect.bottom + 5;

          // Adjust if popup goes off right edge
          if (left + popupWidth > viewportWidth - 10) {
            left = viewportWidth - popupWidth - 10;
          }
          // Adjust if popup goes off left edge
          if (left < 10) left = 10;

          // Adjust if popup goes off bottom edge - show above cell
          if (top + popupHeight > viewportHeight - 10) {
            top = rect.top - popupHeight - 5;
          }
          // If still off top, just position at top
          if (top < 10) top = 10;

          popup.style.left = left + "px";
          popup.style.top = top + "px";

          document.getElementById("hoursInput")?.focus();
        }, 300);
      }

      function selectTime() {
        const hours = document.getElementById("hoursInput").value || "12";
        const minutes = (
          document.getElementById("minutesInput").value || "00"
        ).padStart(2, "0");
        const seconds = (
          document.getElementById("secondsInput").value || "00"
        ).padStart(2, "0");
        const ampm = document.getElementById("ampmSelect").value || "AM";

        // Format: "H:MM:SS AM/PM" (matches toLocaleTimeString format)
        const timeString = `${hours}:${minutes}:${seconds} ${ampm}`;

        if (currentPickerCell) {
          // Clear text nodes but keep picker button
          const pickerBtn = currentPickerCell.querySelector(".cell-picker");
          currentPickerCell.childNodes.forEach((node) => {
            if (node.nodeType === Node.TEXT_NODE) {
              node.remove();
            }
          });

          // Set the new time as text node before the picker button
          const textNode = document.createTextNode(timeString);
          if (pickerBtn) {
            currentPickerCell.insertBefore(textNode, pickerBtn);
          } else {
            currentPickerCell.appendChild(textNode);
          }

          if (currentPickerRow) currentPickerRow.st = timeString;
        }
        closeTimePopup();
      }

      function closeTimePopup() {
        const popup = document.getElementById("timePopup");
        if (popup) popup.remove();
      }

      document.addEventListener("click", (e) => {
        const calPopup = document.getElementById("calendarPopup");
        const timePopup = document.getElementById("timePopup");
        if (
          calPopup &&
          !calPopup.contains(e.target) &&
          e.target.className !== "cell-picker"
        ) {
          closeCalendarPopup();
        }
        if (
          timePopup &&
          !timePopup.contains(e.target) &&
          e.target.className !== "cell-picker"
        ) {
          closeTimePopup();
        }
      });
    </script>
  </body>
</html>
